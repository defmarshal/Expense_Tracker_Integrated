<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTrack - Smart Expense Tracking</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --secondary: #5856D6;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --light: #F5F5F7;
            --dark: #1D1D1F;
            --gray: #86868B;
            --gray-light: #D2D2D7;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.07);
            --gradient: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            --income-gradient: linear-gradient(135deg, #34C759 0%, #28A745 100%);
        }

        body {
            background-color: white;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header Styles */
        header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .logo i {
            font-size: 1.8rem;
            color: var(--primary);
        }

        .auth-section {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 980px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #28A745;
            transform: scale(1.05);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Landing Page Styles */
        .landing-page {
            display: block;
        }

        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0 2rem;
            background: linear-gradient(135deg, #F5F5F7 0%, #FFFFFF 100%);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            width: 800px;
            height: 800px;
            border-radius: 50%;
            background: var(--gradient);
            opacity: 0.03;
            top: -400px;
            right: -200px;
            z-index: 0;
        }

        .hero-content {
            max-width: 900px;
            z-index: 1;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.1;
        }

        .hero p {
            font-size: 1.4rem;
            color: var(--gray);
            margin-bottom: 2.5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 3rem;
        }

        .hero-image {
            max-width: 900px;
            width: 100%;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-top: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .features {
            padding: 6rem 2rem;
            background-color: var(--light);
        }

        .section-header {
            text-align: center;
            max-width: 700px;
            margin: 0 auto 4rem;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--dark);
        }

        .section-subtitle {
            font-size: 1.2rem;
            color: var(--gray);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .feature-card {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-10px);
        }

        .feature-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            background: var(--gradient);
            color: white;
            font-size: 1.8rem;
        }

        .feature-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark);
        }

        .feature-description {
            color: var(--gray);
            line-height: 1.6;
        }

        .benefits {
            padding: 6rem 2rem;
            background: white;
        }

        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 3rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .benefit-item {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
        }

        .benefit-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .benefit-content h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .benefit-content p {
            color: var(--gray);
        }

        .cta {
            padding: 6rem 2rem;
            background: var(--gradient);
            color: white;
            text-align: center;
        }

        .cta h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .cta p {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto 2.5rem;
            opacity: 0.9;
        }

        .cta-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn-white {
            background: white;
            color: var(--primary);
        }

        .btn-white:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .btn-transparent {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .btn-transparent:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        footer {
            padding: 4rem 2rem 2rem;
            background: var(--dark);
            color: white;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 3rem;
        }

        .footer-column h3 {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 0.8rem;
        }

        .footer-links a {
            color: var(--gray-light);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: white;
        }

        .footer-bottom {
            max-width: 1200px;
            margin: 3rem auto 0;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Dashboard Styles */
        .dashboard-container {
            display: none;
            min-height: 100vh;
            padding-top: 80px;
            background: var(--light);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .stat-value.income {
            color: var(--success);
        }

        .stat-value.expense {
            color: var(--primary);
        }

        .stat-value.balance {
            color: var(--dark);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .dashboard-tabs {
            display: flex;
            background: white;
            border-radius: 16px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--gray);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .form-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--dark);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-light);
            border-radius: 12px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .expense-list, .wallet-list, .category-list, .income-list {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .expense-item, .wallet-item, .category-item, .income-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .expense-item:last-child, .wallet-item:last-child, .category-item:last-child, .income-item:last-child {
            border-bottom: none;
        }

        .expense-details, .wallet-details, .category-details, .income-details {
            flex: 1;
        }

        .expense-amount, .wallet-balance, .income-amount {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--dark);
        }

        .expense-amount {
            color: var(--danger);
        }

        .income-amount {
            color: var(--success);
        }

        .expense-category, .income-source {
            background: var(--light);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .edit-btn, .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn {
            color: var(--primary);
        }

        .edit-btn:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .delete-btn {
            color: var(--danger);
        }

        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            padding: 0;
            overflow: hidden;
            transform: translateY(50px) scale(0.9);
            transition: transform 0.5s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            background: var(--gradient);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .modal-header.income {
            background: var(--income-gradient);
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .modal-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .password-strength {
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0;
            transition: width 0.3s, background 0.3s;
        }

        .strength-weak {
            background: var(--danger);
            width: 33%;
        }

        .strength-medium {
            background: var(--warning);
            width: 66%;
        }

        .strength-strong {
            background: var(--success);
            width: 100%;
        }

        /* Alert Styles */
        .alert {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .alert-error {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .alert-warning {
            background-color: rgba(255, 149, 0, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        /* Hidden utility class */
        .hidden {
            display: none !important;
        }

        /* Currency input styling */
        .currency-input {
            position: relative;
        }

        .currency-input input {
            padding-left: 40px;
        }

        .currency-symbol {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-weight: 500;
        }

        /* Subcategory styles */
        .subcategory-item {
            padding-left: 2rem;
            color: var(--gray);
            border-left: 2px solid var(--gray-light);
            margin-left: 1rem;
        }

        .category-actions {
            display: flex;
            gap: 0.5rem;
        }

        .add-subcategory-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Wallet Selector Styles */
        .wallet-selector-container {
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid var(--gray-light);
            box-shadow: var(--shadow);
        }

        .wallet-selector-container select {
            border: none;
            background: transparent;
            font-weight: 600;
            color: var(--dark);
            cursor: pointer;
        }

        .wallet-selector-container select:focus {
            outline: none;
            box-shadow: none;
        }

        /* Insufficient Balance Modal */
        .insufficient-balance-modal .modal-header {
            background: var(--danger);
        }

        .balance-warning {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 12px;
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .balance-warning i {
            font-size: 1.5rem;
            color: var(--danger);
        }

        .balance-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 1.5rem;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .balance-item:last-child {
            border-bottom: none;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .hero p {
                font-size: 1.2rem;
            }
            
            .hero-buttons, .cta-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .section-title {
                font-size: 2rem;
            }
            
            .feature-card {
                padding: 2rem;
            }
            
            header {
                padding: 1rem;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .dashboard-tabs {
                flex-direction: column;
            }
            
            .category-actions {
                flex-direction: column;
            }
            
            .wallet-selector-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            /* NEW: Compact horizontal stats for mobile */
            .dashboard-stats {
                grid-template-columns: repeat(3, 1fr); /* Force 3 small columns */
                gap: 0.5rem; /* Reduce gap between cards */
                margin-bottom: 1.5rem; /* Slightly reduce bottom margin */
            }

            .stat-card {
                padding: 0.6rem 0.4rem; /* Drastically reduce padding */
            }

            .stat-label {
                font-size: 0.65rem; /* Make label very small */
                margin-bottom: 0.1rem;
            }

            .stat-value {
                font-size: 1.0rem; /* Make value much smaller */
                margin: 0;
                line-height: 1.2;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-chart-pie"></i>
            <span>FinTrack</span>
        </div>
        <div class="auth-section">
            <button id="loginBtn" class="btn btn-outline">
                <i class="fas fa-sign-in-alt"></i>
                Sign In
            </button>
            <button id="signupBtn" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>
                Get Started
            </button>
            <button id="logoutBtn" class="btn btn-outline hidden">
                <i class="fas fa-sign-out-alt"></i>
                Sign Out
            </button>
        </div>
    </header>

    <div id="landingPage" class="landing-page">
        <section class="hero">
            <div class="hero-content">
                <h1>Track Expenses.<br>Master Your Finances.</h1>
                <p>FinTrack helps you understand where your money goes with beautiful visuals and powerful insights.</p>
                <div class="hero-buttons">
                    <button id="heroSignupBtn" class="btn btn-primary">
                        <i class="fas fa-rocket"></i>
                        Start Free Trial
                    </button>
                    <button class="btn btn-outline">
                        <i class="fas fa-play-circle"></i>
                        Watch Demo
                    </button>
                </div>
                <div class="hero-image">
                    <div style="background: var(--gradient); height: 400px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                        FinTrack Dashboard Preview
                    </div>
                </div>
            </div>
        </section>

        <section class="features">
            <div class="section-header">
                <h2 class="section-title">Everything You Need to Manage Expenses</h2>
                <p class="section-subtitle">FinTrack provides all the tools you need to take control of your financial life</p>
            </div>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <h3 class="feature-title">Multiple Wallets</h3>
                    <p class="feature-description">Track expenses across multiple wallets, bank accounts, and credit cards in one place.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-tags"></i>
                    </div>
                    <h3 class="feature-title">Smart Categories</h3>
                    <p class="feature-description">Automatically categorize expenses and create custom categories for better organization.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3 class="feature-title">Visual Reports</h3>
                    <p class="feature-description">Understand your spending patterns with beautiful charts and visualizations.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3 class="feature-title">Income Tracking</h3>
                    <p class="feature-description">Track all your income sources and see how they contribute to your financial health.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3 class="feature-title">Secure & Private</h3>
                    <p class="feature-description">Your data is encrypted and secure with enterprise-grade security infrastructure.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-sync"></i>
                    </div>
                    <h3 class="feature-title">Real-time Sync</h3>
                    <p class="feature-description">Your data syncs instantly across all devices so you're always up to date.</p>
                </div>
            </div>
        </section>

        <section class="benefits">
            <div class="section-header">
                <h2 class="section-title">Why Choose FinTrack?</h2>
                <p class="section-subtitle">Join thousands of users who have transformed their financial lives</p>
            </div>
            <div class="benefits-grid">
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Save Time</h3>
                        <p>Automate expense tracking and categorization to spend less time managing finances.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Gain Insights</h3>
                        <p>Discover spending patterns and identify opportunities to save more money.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Achieve Goals</h3>
                        <p>Set financial goals and track your progress with personalized recommendations.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Share with Partners</h3>
                        <p>Easily share expense tracking with family members or business partners.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Export Data</h3>
                        <p>Download your financial data in multiple formats for tax preparation or analysis.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Premium Support</h3>
                        <p>Get help when you need it with our responsive customer support team.</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="cta">
            <h2>Ready to Transform Your Finances?</h2>
            <p>Join FinTrack today and start your journey to financial clarity and control.</p>
            <div class="cta-buttons">
                <button id="ctaSignupBtn" class="btn btn-white">
                    <i class="fas fa-rocket"></i>
                    Get Started Free
                </button>
                <button class="btn btn-transparent">
                    <i class="fas fa-calendar"></i>
                    Book a Demo
                </button>
            </div>
        </section>

        <footer>
            <div class="footer-content">
                <div class="footer-column">
                    <h3>FinTrack</h3>
                    <ul class="footer-links">
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Careers</a></li>
                        <li><a href="#">Press</a></li>
                        <li><a href="#">Blog</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Product</h3>
                    <ul class="footer-links">
                        <li><a href="#">Features</a></li>
                        <li><a href="#">Pricing</a></li>
                        <li><a href="#">Security</a></li>
                        <li><a href="#">Roadmap</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Resources</h3>
                    <ul class="footer-links">
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Community</a></li>
                        <li><a href="#">Guides</a></li>
                        <li><a href="#">API</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Legal</h3>
                    <ul class="footer-links">
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Cookie Policy</a></li>
                        <li><a href="#">GDPR</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 FinTrack. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <div id="dashboardContainer" class="dashboard-container">
        <div class="container">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Overview</h1>
                <div class="wallet-selector-container">
                    <i class="fas fa-wallet" style="color: var(--primary);"></i>
                    <select id="globalWalletSelect">
                        <option value="">Loading wallets...</option>
                    </select>
                </div>
            </div>

            <div class="dashboard-stats" id="dashboardStats">
                <div class="stat-card">
                    <div class="stat-label">Income</div>
                    <div class="stat-value income" id="totalIncomeValue">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Expense</div>
                    <div class="stat-value expense" id="totalExpenseValue">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Balance</div>
                    <div class="stat-value balance" id="currentBalanceValue">Rp 0</div>
                </div>
            </div>
            <div class="dashboard-tabs">
                <div class="tab active" data-tab="expense">Expenses</div>
                <div class="tab" data-tab="income">Income</div>
                <div class="tab" data-tab="wallets">Wallets</div>
                <div class="tab" data-tab="categories">Categories</div>
            </div>

            <div id="expenseTab" class="tab-content active">
                <div class="form-card">
                    <h2 class="form-title">Add New Expense</h2>
                    <form id="expenseForm">
                        <input type="hidden" id="expenseId">
                        <div class="form-group">
                            <label for="expenseDescription">Description</label>
                            <input type="text" id="expenseDescription" placeholder="What did you spend money on?" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expenseAmount">Amount</label>
                                <div class="currency-input">
                                    <span class="currency-symbol">Rp</span>
                                    <input type="text" id="expenseAmount" placeholder="0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="expenseDate">Date</label>
                                <input type="date" id="expenseDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expenseCategory">Category</label>
                                <select id="expenseCategory" required>
                                    <option value="">Select a category</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="expenseSubcategory">Subcategory</label>
                                <select id="expenseSubcategory">
                                    <option value="">Select a subcategory (optional)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary" id="expenseSubmitBtn">
                                <i class="fas fa-minus-circle"></i>
                                Add Expense
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="expenseCancelBtn">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
                <div class="expense-list">
                    <h2 class="form-title">Recent Expenses</h2>
                    <div id="expensesList">
                        <div class="expense-item">
                            <div class="expense-details">
                                <div>No expenses yet. Add your first expense!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="incomeTab" class="tab-content">
                <div class="form-card">
                    <h2 class="form-title">Add New Income</h2>
                    <form id="incomeForm">
                        <input type="hidden" id="incomeId">
                        <div class="form-group">
                            <label for="incomeDescription">Description</label>
                            <input type="text" id="incomeDescription" placeholder="Where did this income come from?" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="incomeAmount">Amount</label>
                                <div class="currency-input">
                                    <span class="currency-symbol">Rp</span>
                                    <input type="text" id="incomeAmount" placeholder="0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="incomeDate">Date</label>
                                <input type="date" id="incomeDate" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="incomeSource">Income Source</label>
                            <select id="incomeSource" required>
                                <option value="">Select income source</option>
                                <option value="Salary">Salary</option>
                                <option value="Freelance">Freelance</option>
                                <option value="Investment">Investment</option>
                                <option value="Gift">Gift</option>
                                <option value="Bonus">Bonus</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-success" id="incomeSubmitBtn">
                                <i class="fas fa-plus-circle"></i>
                                Add Income
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="incomeCancelBtn">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
                <div class="income-list">
                    <h2 class="form-title">Recent Income</h2>
                    <div id="incomesList">
                        <div class="income-item">
                            <div class="income-details">
                                <div>No income yet. Add your first income!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="walletsTab" class="tab-content">
                <div class="form-card">
                    <h2 class="form-title">Add New Wallet</h2>
                    <form id="walletForm">
                        <input type="hidden" id="walletId">
                        <div class="form-group">
                            <label for="walletName">Wallet Name</label>
                            <input type="text" id="walletName" placeholder="e.g., Cash, Bank Account, Credit Card" required>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary" id="walletSubmitBtn">
                                <i class="fas fa-plus-circle"></i>
                                Add Wallet
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="walletCancelBtn">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
                <div class="wallet-list">
                    <h2 class="form-title">Your Wallets</h2>
                    <div id="walletsList">
                        <div class="wallet-item">
                            <div class="wallet-details">
                                <div>No wallets yet. Add your first wallet!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="categoriesTab" class="tab-content">
                <div class="form-card">
                    <h2 class="form-title">Add New Category</h2>
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">
                        <div class="form-group">
                            <label for="categoryName">Category Name</label>
                            <input type="text" id="categoryName" placeholder="e.g., Food, Transport, Salary" required>
                        </div>
                        <div class="form-group">
                            <label for="categoryType">Category Type</label>
                            <select id="categoryType" required>
                                <option value="">Select type</option>
                                <option value="main">Main Category</option>
                                <option value="sub">Subcategory</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="parentCategoryGroup">
                            <label for="parentCategory">Parent Category</label>
                            <select id="parentCategory">
                                <option value="">Select a parent category</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary" id="categorySubmitBtn">
                                <i class="fas fa-plus-circle"></i>
                                Add Category
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="categoryCancelBtn">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
                <div class="category-list">
                    <h2 class="form-title">Your Categories</h2>
                    <div id="categoriesList">
                        <div class="category-item">
                            <div class="category-details">
                                <div>No categories yet. Add your first category!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="subcategoryModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeSubcategoryModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Add Subcategory</h2>
                <p class="modal-subtitle">Create a new subcategory</p>
            </div>
            <div class="modal-body">
                <form id="subcategoryForm">
                    <div class="form-group">
                        <label for="subcategoryName">Subcategory Name</label>
                        <input type="text" id="subcategoryName" placeholder="e.g., Groceries, Restaurants" required>
                    </div>
                    <input type="hidden" id="parentCategoryId">
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px;">
                        <i class="fas fa-plus-circle"></i>
                        Add Subcategory
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header" style="background: var(--danger);">
                <button class="modal-close" id="closeDeleteModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Confirm Deletion</h2>
                <p class="modal-subtitle">This action cannot be undone</p>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Are you sure you want to delete this item?</p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-outline" id="cancelDeleteBtn" style="flex: 1;">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button class="btn btn-danger" id="confirmDeleteBtn" style="flex: 1; background: var(--danger);">
                        <i class="fas fa-trash"></i>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="signupModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeSignupModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Create Your Account</h2>
                <p class="modal-subtitle">Start tracking your finances today</p>
            </div>
            <div class="modal-body">
                <form id="signupForm">
                    <div class="form-group">
                        <label for="signupEmail">Email Address</label>
                        <input type="email" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a password" required>
                        <div class="password-strength">
                            <div class="strength-bar" id="passwordStrength"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px;">
                        <i class="fas fa-user-plus"></i>
                        Create Account
                    </button>
                </form>
                <div style="text-align: center; margin-top: 20px;">
                    <p>Already have an account? <a href="#" id="showLoginFromSignup" style="color: var(--primary); text-decoration: none; font-weight: 600;">Sign in here</a></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeLoginModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Welcome Back</h2>
                <p class="modal-subtitle">Sign in to your account</p>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px;">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </button>
                </form>
                <div style="text-align: center; margin-top: 20px;">
                    <p>Don't have an account? <a href="#" id="showSignupFromLogin" style="color: var(--primary); text-decoration: none; font-weight: 600;">Sign up here</a></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="insufficientBalanceModal">
        <div class="modal">
            <div class="modal-header insufficient-balance-modal">
                <h2 class="modal-title">Insufficient Balance</h2>
                <p class="modal-subtitle">Cannot record expense</p>
            </div>
            <div class="modal-body">
                <div class="balance-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>The expense amount exceeds the current available balance in your selected wallet.</p>
                </div>

                <div class="balance-details">
                    <div class="balance-item">
                        <span>Expense Amount:</span>
                        <span id="expenseAmountDetail" style="font-weight: 600; color: var(--danger);"></span>
                    </div>
                    <div class="balance-item">
                        <span>Current Wallet Balance:</span>
                        <span id="walletBalanceDetail" style="font-weight: 600; color: var(--success);"></span>
                    </div>
                    <div class="balance-item">
                        <span>Remaining (if recorded):</span>
                        <span id="remainingBalanceDetail" style="font-weight: 600; color: var(--danger);"></span>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" id="cancelExpenseBtn" style="flex: 1;">
                        <i class="fas fa-times"></i>
                        Cancel Expense
                    </button>
                    <button class="btn btn-success" id="addFundsBtn" style="flex: 1;">
                        <i class="fas fa-plus-circle"></i>
                        Add Funds
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="alertContainer" style="position: fixed; top: 100px; right: 20px; z-index: 3000; max-width: 400px;"></div>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://slgzgaoj...';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM Elements
        const landingPage = document.getElementById('landingPage');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const heroSignupBtn = document.getElementById('heroSignupBtn');
        const ctaSignupBtn = document.getElementById('ctaSignupBtn');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const subcategoryModal = document.getElementById('subcategoryModal');
        const deleteModal = document.getElementById('deleteModal');
        const insufficientBalanceModal = document.getElementById('insufficientBalanceModal');
        const alertContainer = document.getElementById('alertContainer');
        const globalWalletSelect = document.getElementById('globalWalletSelect');

        // Forms
        const signupForm = document.getElementById('signupForm');
        const loginForm = document.getElementById('loginForm');
        const expenseForm = document.getElementById('expenseForm');
        const incomeForm = document.getElementById('incomeForm');
        const walletForm = document.getElementById('walletForm');
        const categoryForm = document.getElementById('categoryForm');
        const subcategoryForm = document.getElementById('subcategoryForm');

        // Password strength indicator
        const signupPassword = document.getElementById('signupPassword');
        const passwordStrength = document.getElementById('passwordStrength');

        // Tab Content
        const tabContents = document.querySelectorAll('.tab-content');
        const tabs = document.querySelectorAll('.tab');

        // Category form elements
        const categoryTypeSelect = document.getElementById('categoryType');
        const parentCategoryGroup = document.getElementById('parentCategoryGroup');
        const parentCategory = document.getElementById('parentCategory');
        const expenseCategory = document.getElementById('expenseCategory');
        const expenseSubcategory = document.getElementById('expenseSubcategory');

        // Form buttons
        const expenseSubmitBtn = document.getElementById('expenseSubmitBtn');
        const expenseCancelBtn = document.getElementById('expenseCancelBtn');
        const incomeSubmitBtn = document.getElementById('incomeSubmitBtn');
        const incomeCancelBtn = document.getElementById('incomeCancelBtn');
        const walletSubmitBtn = document.getElementById('walletSubmitBtn');
        const walletCancelBtn = document.getElementById('walletCancelBtn');
        const categorySubmitBtn = document.getElementById('categorySubmitBtn');
        const categoryCancelBtn = document.getElementById('categoryCancelBtn');

        // Delete modal elements
        const deleteMessage = document.getElementById('deleteMessage');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        // Insufficient balance modal elements
        const expenseAmountDetail = document.getElementById('expenseAmountDetail');
        const walletBalanceDetail = document.getElementById('walletBalanceDetail');
        const remainingBalanceDetail = document.getElementById('remainingBalanceDetail');
        const addFundsBtn = document.getElementById('addFundsBtn');
        const cancelExpenseBtn = document.getElementById('cancelExpenseBtn');

        // Data storage
        let expenses = [];
        let incomes = [];
        let wallets = [];
        let categories = [];
        let currentWalletId = null;
        let pendingExpense = null;
        let itemToDelete = null;
        let deleteType = null;

        // Currency formatting functions
        function formatCurrency(value) {
            const numericValue = value.replace(/\D/g, '');
            return numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function parseCurrency(formattedValue) {
            return parseInt(formattedValue.replace(/\./g, '')) || 0;
        }

        function formatDisplayCurrency(amount) {
            return `Rp ${amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }

        // Helper function to check if a string is a valid UUID
        function isValidUUID(str) {
            if (!str) return false;
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            return uuidRegex.test(str);
        }

        // Calculate wallet balance - purely based on income minus expenses
        function calculateWalletBalance(walletId) {
            const walletExpenses = expenses.filter(expense => expense.walletId === walletId);
            const totalExpenses = walletExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const walletIncome = incomes.filter(income => income.walletId === walletId);
            const totalIncome = walletIncome.reduce((sum, income) => sum + income.amount, 0);

            return totalIncome - totalExpenses;
        }

        // --- Auth Functions ---

        async function handleSignup(e) {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                });

                if (error) throw error;

                showAlert('Sign up successful! Please check your email to confirm your account.', 'success');
                signupModal.classList.remove('active');
                signupForm.reset();
            } catch (error) {
                console.error('Signup Error:', error);
                showAlert('Signup failed: ' + error.message, 'error');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) throw error;

                showAlert('Login successful!', 'success');
                loginModal.classList.remove('active');
                loginForm.reset();
                checkAuthState(); // Force UI update
            } catch (error) {
                console.error('Login Error:', error);
                showAlert('Login failed: ' + error.message, 'error');
            }
        }

        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                showAlert('Logged out successfully!', 'success');
                checkAuthState(); // Force UI update
            } catch (error) {
                console.error('Logout Error:', error);
                showAlert('Logout failed: ' + error.message, 'error');
            }
        }

        async function checkAuthState() {
            const { data: { user } } = await supabase.auth.getUser();

            if (user) {
                landingPage.style.display = 'none';
                dashboardContainer.style.display = 'block';
                loginBtn.classList.add('hidden');
                signupBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                await loadAllData();
            } else {
                landingPage.style.display = 'block';
                dashboardContainer.style.display = 'none';
                loginBtn.classList.remove('hidden');
                signupBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }

        // --- CRUD Utility Functions ---

        // Save (Insert or Update) functions
        async function saveExpense(expense) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const record = {
                    description: expense.description,
                    amount: expense.amount,
                    date: expense.date,
                    category: expense.category,
                    subcategory: expense.subcategory,
                    wallet_id: expense.walletId,
                    user_id: user.id
                };

                let response;
                if (expense.id) {
                    response = await supabase
                        .from('expenses')
                        .update(record)
                        .eq('id', expense.id)
                        .select();
                } else {
                    response = await supabase
                        .from('expenses')
                        .insert([record])
                        .select();
                }

                if (response.error) throw response.error;
                const savedData = response.data[0];
                return {
                    id: savedData.id,
                    description: savedData.description,
                    amount: savedData.amount,
                    date: savedData.date,
                    category: savedData.category,
                    subcategory: savedData.subcategory,
                    walletId: savedData.wallet_id,
                };

            } catch (error) {
                console.error('Error saving expense:', error);
                showAlert('Error saving expense: ' + error.message, 'error');
                throw error;
            }
        }

        async function saveIncome(income) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const record = {
                    description: income.description,
                    amount: income.amount,
                    date: income.date,
                    source: income.source,
                    wallet_id: income.walletId,
                    user_id: user.id
                };

                let response;
                if (income.id) {
                    response = await supabase
                        .from('incomes')
                        .update(record)
                        .eq('id', income.id)
                        .select();
                } else {
                    response = await supabase
                        .from('incomes')
                        .insert([record])
                        .select();
                }

                if (response.error) throw response.error;
                const savedData = response.data[0];
                return {
                    id: savedData.id,
                    description: savedData.description,
                    amount: savedData.amount,
                    date: savedData.date,
                    source: savedData.source,
                    walletId: savedData.wallet_id,
                };
            } catch (error) {
                console.error('Error saving income:', error);
                showAlert('Error saving income: ' + error.message, 'error');
                throw error;
            }
        }

        async function saveWallet(wallet) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const record = {
                    name: wallet.name,
                    user_id: user.id
                };

                let response;
                if (wallet.id) {
                    response = await supabase
                        .from('wallets')
                        .update(record)
                        .eq('id', wallet.id)
                        .select();
                } else {
                    response = await supabase
                        .from('wallets')
                        .insert([record])
                        .select();
                }

                if (response.error) throw response.error;
                const savedData = response.data[0];
                return {
                    id: savedData.id,
                    name: savedData.name,
                };
            } catch (error) {
                console.error('Error saving wallet:', error);
                showAlert('Error saving wallet: ' + error.message, 'error');
                throw error;
            }
        }

        async function saveCategory(category) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const record = {
                    name: category.name,
                    type: category.type,
                    parent_id: category.parentId,
                    user_id: user.id
                };

                let response;
                if (category.id) {
                    response = await supabase
                        .from('categories')
                        .update(record)
                        .eq('id', category.id)
                        .select();
                } else {
                    response = await supabase
                        .from('categories')
                        .insert([record])
                        .select();
                }

                if (response.error) throw response.error;
                const savedData = response.data[0];
                return {
                    id: savedData.id,
                    name: savedData.name,
                    type: savedData.type,
                    parentId: savedData.parent_id
                };
            } catch (error) {
                console.error('Error saving category:', error);
                showAlert('Error saving category: ' + error.message, 'error');
                throw error;
            }
        }

        // Load data functions
        async function loadExpensesFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('date', { ascending: false });

                if (error) throw error;

                return data.map(expense => ({
                    id: expense.id,
                    description: expense.description,
                    amount: expense.amount,
                    date: expense.date,
                    category: expense.category,
                    subcategory: expense.subcategory,
                    walletId: expense.wallet_id
                }));
            } catch (error) {
                console.error('Error loading expenses:', error);
                return JSON.parse(localStorage.getItem('fintrack_expenses') || '[]');
            }
        }

        async function loadIncomesFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                const { data, error } = await supabase
                    .from('incomes')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('date', { ascending: false });

                if (error) throw error;

                return data.map(income => ({
                    id: income.id,
                    description: income.description,
                    amount: income.amount,
                    date: income.date,
                    source: income.source,
                    walletId: income.wallet_id
                }));
            } catch (error) {
                console.error('Error loading incomes:', error);
                return JSON.parse(localStorage.getItem('fintrack_incomes') || '[]');
            }
        }

        async function loadWalletsFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                const { data, error } = await supabase
                    .from('wallets')
                    .select('*')
                    .eq('user_id', user.id);

                if (error) throw error;

                return data.map(wallet => ({
                    id: wallet.id,
                    name: wallet.name
                }));
            } catch (error) {
                console.error('Error loading wallets:', error);
                return JSON.parse(localStorage.getItem('fintrack_wallets') || '[]');
            }
        }

        async function loadCategoriesFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .eq('user_id', user.id);

                if (error) throw error;

                return data.map(category => ({
                    id: category.id,
                    name: category.name,
                    type: category.type,
                    parentId: category.parent_id
                }));
            } catch (error) {
                console.error('Error loading categories:', error);
                return JSON.parse(localStorage.getItem('fintrack_categories') || '[]');
            }
        }

        // --- Data Manipulation Functions ---

        // Expense Functions
        async function handleAddExpense(e) {
            e.preventDefault();
            const id = document.getElementById('expenseId').value;
            const description = document.getElementById('expenseDescription').value;
            const amount = parseCurrency(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const subcategory = document.getElementById('expenseSubcategory').value;
            const walletId = currentWalletId;

            if (!walletId) {
                showAlert('Please select a wallet from the top-right selector', 'error');
                return;
            }

            if (amount <= 0) {
                showAlert('Please enter a valid amount', 'error');
                return;
            }

            // Find the current wallet
            const currentWallet = wallets.find(w => w.id === walletId);
            if (!currentWallet) {
                showAlert('Selected wallet not found', 'error');
                return;
            }

            // VALIDATION: Check if wallet has sufficient balance (only for new expenses)
            if (!id) {
                const walletBalance = calculateWalletBalance(walletId);
                if (walletBalance < amount) {
                    // Store the pending expense for potential future use
                    pendingExpense = { description, amount, date, category, subcategory, walletId };

                    // Show insufficient balance modal with details
                    expenseAmountDetail.textContent = formatDisplayCurrency(amount);
                    walletBalanceDetail.textContent = formatDisplayCurrency(walletBalance);
                    remainingBalanceDetail.textContent = formatDisplayCurrency(walletBalance - amount);
                    insufficientBalanceModal.classList.add('active');
                    return;
                }
            }

            const expense = { id, description, amount, date, category, subcategory, walletId };
            console.log('Saving expense:', expense);

            try {
                const savedExpense = await saveExpense(expense);
                if (id) {
                    // Update existing expense
                    const index = expenses.findIndex(e => e.id === id);
                    if (index !== -1) {
                        expenses[index] = savedExpense;
                    }
                    showAlert('Expense updated successfully!', 'success');
                } else {
                    // Add new expense
                    expenses.push(savedExpense);
                    showAlert('Expense added successfully!', 'success');
                }
                resetExpenseForm();
                await loadExpenses(); // Wait for expenses to reload
                updateStats(); // Force stats update
                console.log('After adding expense - Expenses:', expenses);
            } catch (error) {
                console.error('Error adding/updating expense:', error);
                showAlert('Failed to save expense.', 'error');
            }
        }

        // Income Functions
        async function handleAddIncome(e) {
            e.preventDefault();
            const id = document.getElementById('incomeId').value;
            const description = document.getElementById('incomeDescription').value;
            const amount = parseCurrency(document.getElementById('incomeAmount').value);
            const date = document.getElementById('incomeDate').value;
            const source = document.getElementById('incomeSource').value;
            // Use the current wallet instead of selecting from form
            const walletId = currentWalletId;

            if (!walletId) {
                showAlert('Please select a wallet from the top-right selector', 'error');
                return;
            }

            if (amount <= 0) {
                showAlert('Please enter a valid amount', 'error');
                return;
            }

            const income = { id, description, amount, date, source, walletId };
            console.log('Saving income:', income);

            try {
                const savedIncome = await saveIncome(income);
                if (id) {
                    // Update existing income
                    const index = incomes.findIndex(i => i.id === id);
                    if (index !== -1) {
                        incomes[index] = savedIncome;
                    }
                    showAlert('Income updated successfully!', 'success');
                } else {
                    // Add new income
                    incomes.push(savedIncome);
                    showAlert('Income added successfully!', 'success');
                }
                resetIncomeForm();
                await loadIncomes();
                updateStats();
            } catch (error) {
                console.error('Error adding/updating income:', error);
                showAlert('Failed to save income.', 'error');
            }
        }

        // Wallet Functions
        async function handleAddWallet(e) {
            e.preventDefault();
            const id = document.getElementById('walletId').value;
            const name = document.getElementById('walletName').value;

            const wallet = { id, name };
            console.log('Saving wallet:', wallet);

            const savedWallet = await saveWallet(wallet);

            if (id) {
                // Update existing wallet
                const index = wallets.findIndex(w => w.id === id);
                if (index !== -1) {
                    wallets[index] = savedWallet;
                }
                showAlert('Wallet updated successfully!', 'success');
            } else {
                // Add new wallet
                wallets.push(savedWallet);
                // If this is the first wallet, set it as current
                if (wallets.length === 1) {
                    currentWalletId = savedWallet.id;
                    updateGlobalWalletSelector();
                }
                showAlert('Wallet added successfully!', 'success');
            }
            resetWalletForm();
            await loadWallets();
            updateStats();
        }

        // Category Functions
        async function handleAddCategory(e) {
            e.preventDefault();
            const id = document.getElementById('categoryId').value;
            const type = document.getElementById('categoryType').value;
            const name = document.getElementById('categoryName').value;
            let parentId = null;

            if (type === 'sub') {
                parentId = document.getElementById('parentCategory').value;
                if (!parentId) {
                    showAlert('Please select a parent category for the subcategory', 'error');
                    return;
                }
            }

            const category = { id, name, type, parentId };
            console.log('Adding/updating category:', category);

            try {
                const savedCategory = await saveCategory(category);
                console.log('Saved category:', savedCategory);

                if (id) {
                    // Update existing category
                    const index = categories.findIndex(c => c.id === id);
                    if (index !== -1) {
                        categories[index] = savedCategory;
                    }
                    showAlert('Category updated successfully!', 'success');
                } else {
                    // Add new category
                    categories.push(savedCategory);
                    showAlert(`${type === 'main' ? 'Category' : 'Subcategory'} added successfully!`, 'success');
                }

                resetCategoryForm();
                // Force refresh all category-related UI
                await refreshAllCategoryUI();
            } catch (error) {
                console.error('Error in handleAddCategory:', error);
                showAlert('Error adding category: ' + error.message, 'error');
            }
        }

        // Subcategory Functions
        async function handleAddSubcategory(e) {
            e.preventDefault();
            const name = document.getElementById('subcategoryName').value;
            const parentId = document.getElementById('parentCategoryId').value;

            if (!name) {
                showAlert('Please enter a subcategory name', 'error');
                return;
            }

            if (!parentId) {
                showAlert('Parent category not found.', 'error');
                return;
            }

            const category = { id: null, name, type: 'sub', parentId };
            console.log('Adding subcategory:', category);

            try {
                await saveCategory(category);
                showAlert('Subcategory added successfully!', 'success');
                subcategoryModal.classList.remove('active');
                subcategoryForm.reset();
                await refreshAllCategoryUI();
            } catch (error) {
                console.error('Error in handleAddSubcategory:', error);
                showAlert('Error adding subcategory: ' + error.message, 'error');
            }
        }

        function openSubcategoryModal(parentId) {
            document.getElementById('parentCategoryId').value = parentId;
            subcategoryModal.classList.add('active');
            document.getElementById('subcategoryName').focus();
        }

        // Delete Functions
        async function handleDeleteItem() {
            if (!itemToDelete || !deleteType) return;

            let success = false;
            try {
                const { data: { user } } = await supabase.auth.getUser();

                if (!user) {
                    showAlert('User not authenticated for deletion.', 'error');
                    return;
                }

                let tableName = '';
                switch (deleteType) {
                    case 'expense':
                        tableName = 'expenses';
                        break;
                    case 'income':
                        tableName = 'incomes';
                        break;
                    case 'wallet':
                        tableName = 'wallets';
                        break;
                    case 'category':
                        tableName = 'categories';
                        break;
                    default:
                        showAlert('Invalid item type for deletion.', 'error');
                        return;
                }

                const { error } = await supabase
                    .from(tableName)
                    .delete()
                    .eq('id', itemToDelete)
                    .eq('user_id', user.id); // Ensure user can only delete their own data

                if (error) throw error;
                success = true;

                // Client-side array update
                switch (deleteType) {
                    case 'expense':
                        expenses = expenses.filter(e => e.id !== itemToDelete);
                        showAlert('Expense deleted successfully!', 'success');
                        break;
                    case 'income':
                        incomes = incomes.filter(i => i.id !== itemToDelete);
                        showAlert('Income deleted successfully!', 'success');
                        break;
                    case 'wallet':
                        wallets = wallets.filter(w => w.id !== itemToDelete);
                        // If deleted wallet was the current one, reset currentWalletId
                        if (itemToDelete === currentWalletId) {
                            currentWalletId = wallets.length > 0 ? wallets[0].id : null;
                            updateGlobalWalletSelector();
                        }
                        showAlert('Wallet deleted successfully!', 'success');
                        break;
                    case 'category':
                        categories = categories.filter(c => c.id !== itemToDelete);
                        // Also remove this category from expenses
                        expenses.forEach(expense => {
                            if (expense.category === itemToDelete) {
                                expense.category = '';
                            }
                        });
                        showAlert('Category deleted successfully!', 'success');
                        break;
                }

                if (success) {
                    await loadExpenses();
                    await loadIncomes();
                    await loadWallets();
                    await loadCategories();
                    updateStats();
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showAlert('Error deleting item: ' + error.message, 'error');
            }

            deleteModal.classList.remove('active');
            itemToDelete = null;
            deleteType = null;
        }

        // Edit Functions
        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;

            document.getElementById('expenseId').value = expense.id;
            document.getElementById('expenseDescription').value = expense.description;
            document.getElementById('expenseAmount').value = formatCurrency(expense.amount.toString());
            document.getElementById('expenseDate').value = expense.date;

            // Load categories and then set value
            loadParentCategories();
            document.getElementById('expenseCategory').value = expense.category;

            // Update subcategory dropdown for the selected category
            updateSubcategoryDropdown(expense.category);
            document.getElementById('expenseSubcategory').value = expense.subcategory;

            expenseSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update Expense';
            expenseCancelBtn.classList.remove('hidden');

            // Scroll to form
            document.getElementById('expenseForm').scrollIntoView({ behavior: 'smooth' });
        }

        function editIncome(id) {
            const income = incomes.find(i => i.id === id);
            if (!income) return;

            document.getElementById('incomeId').value = income.id;
            document.getElementById('incomeDescription').value = income.description;
            document.getElementById('incomeAmount').value = formatCurrency(income.amount.toString());
            document.getElementById('incomeDate').value = income.date;
            document.getElementById('incomeSource').value = income.source;

            incomeSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update Income';
            incomeCancelBtn.classList.remove('hidden');

            // Scroll to form
            document.getElementById('incomeForm').scrollIntoView({ behavior: 'smooth' });
        }

        function editWallet(id) {
            const wallet = wallets.find(w => w.id === id);
            if (!wallet) return;

            document.getElementById('walletId').value = wallet.id;
            document.getElementById('walletName').value = wallet.name;

            walletSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update Wallet';
            walletCancelBtn.classList.remove('hidden');

            // Scroll to form
            document.getElementById('walletForm').scrollIntoView({ behavior: 'smooth' });
        }

        function editCategory(id) {
            const category = categories.find(c => c.id === id);
            if (!category) return;

            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryType').value = category.type;

            if (category.type === 'sub') {
                parentCategoryGroup.classList.remove('hidden');
                loadParentCategories();
                setTimeout(() => {
                    document.getElementById('parentCategory').value = category.parentId;
                }, 100);
            } else {
                parentCategoryGroup.classList.add('hidden');
            }

            categorySubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update Category';
            categoryCancelBtn.classList.remove('hidden');

            // Scroll to form
            document.getElementById('categoryForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Delete confirmation function
        function confirmDelete(type, id, name) {
            itemToDelete = id;
            deleteType = type;
            let message = `Are you sure you want to delete this item?`;

            switch (type) {
                case 'expense':
                    message = `Are you sure you want to delete the expense: <strong>${name}</strong>?`;
                    break;
                case 'income':
                    message = `Are you sure you want to delete the income: <strong>${name}</strong>?`;
                    break;
                case 'wallet':
                    message = `Are you sure you want to delete the wallet: <strong>${name}</strong>? This will remove all associated expenses and incomes!`;
                    break;
                case 'category':
                    message = `Are you sure you want to delete the category: <strong>${name}</strong>?`;
                    break;
            }

            deleteMessage.innerHTML = message;
            deleteModal.classList.add('active');
        }

        // Reset form functions
        function resetExpenseForm() {
            document.getElementById('expenseId').value = '';
            expenseForm.reset();
            document.getElementById('expenseDate').valueAsDate = new Date();
            expenseSubmitBtn.innerHTML = '<i class="fas fa-minus-circle"></i> Add Expense';
            expenseCancelBtn.classList.add('hidden');
        }

        function resetIncomeForm() {
            document.getElementById('incomeId').value = '';
            incomeForm.reset();
            document.getElementById('incomeDate').valueAsDate = new Date();
            incomeSubmitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Income';
            incomeCancelBtn.classList.add('hidden');
        }

        function resetWalletForm() {
            document.getElementById('walletId').value = '';
            walletForm.reset();
            walletSubmitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Wallet';
            walletCancelBtn.classList.add('hidden');
        }

        function resetCategoryForm() {
            document.getElementById('categoryId').value = '';
            categoryForm.reset();
            document.getElementById('categoryType').value = '';
            parentCategoryGroup.classList.add('hidden');
            categorySubmitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Category';
            categoryCancelBtn.classList.add('hidden');
        }

        // Function to refresh all category UI
        async function refreshAllCategoryUI() {
            console.log('Refreshing all category UI...');
            await loadCategories(); // This will call updateCategoryDropdowns
            updateStats();
        }

        // Data loading functions
        async function loadExpenses() {
            expenses = await loadExpensesFromSupabase();
            const expensesList = document.getElementById('expensesList');

            // Filter expenses for current wallet if one is selected
            let displayExpenses = expenses;
            if (currentWalletId) {
                displayExpenses = expenses.filter(expense => expense.walletId === currentWalletId);
            }

            if (displayExpenses.length === 0) {
                expensesList.innerHTML = `
                    <div class="expense-item">
                        <div class="expense-details">
                            <div>No expenses yet. Add your first expense!</div>
                        </div>
                    </div>
                `;
                return;
            }

            expensesList.innerHTML = '';
            const sortedExpenses = [...displayExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedExpenses.forEach(expense => {
                const expenseDate = new Date(expense.date).toLocaleDateString();
                const wallet = wallets.find(w => w.id === expense.walletId);

                const expenseItem = document.createElement('div');
                expenseItem.className = 'expense-item';
                expenseItem.innerHTML = `
                    <div class="expense-details">
                        <div>${expense.description}</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">
                            ${expenseDate}  ${wallet ? wallet.name : 'Unknown Wallet'}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="expense-amount">
                            ${formatDisplayCurrency(expense.amount)}
                            <span class="expense-category">${expense.category} / ${expense.subcategory || '-'}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="editExpense('${expense.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" onclick="confirmDelete('expense', '${expense.id}', '${expense.description}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                expensesList.appendChild(expenseItem);
            });
        }

        async function loadIncomes() {
            incomes = await loadIncomesFromSupabase();
            const incomesList = document.getElementById('incomesList');

            // Filter incomes for current wallet if one is selected
            let displayIncomes = incomes;
            if (currentWalletId) {
                displayIncomes = incomes.filter(income => income.walletId === currentWalletId);
            }

            if (displayIncomes.length === 0) {
                incomesList.innerHTML = `
                    <div class="income-item">
                        <div class="income-details">
                            <div>No income yet. Add your first income!</div>
                        </div>
                    </div>
                `;
                return;
            }

            incomesList.innerHTML = '';
            const sortedIncomes = [...displayIncomes].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedIncomes.forEach(income => {
                const incomeDate = new Date(income.date).toLocaleDateString();
                const wallet = wallets.find(w => w.id === income.walletId);

                const incomeItem = document.createElement('div');
                incomeItem.className = 'income-item';
                incomeItem.innerHTML = `
                    <div class="income-details">
                        <div>${income.description}</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">
                            ${incomeDate}  ${wallet ? wallet.name : 'Unknown Wallet'}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="income-amount">
                            ${formatDisplayCurrency(income.amount)}
                            <span class="income-source">${income.source}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="editIncome('${income.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" onclick="confirmDelete('income', '${income.id}', '${income.description}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                incomesList.appendChild(incomeItem);
            });
        }

        async function loadWallets() {
            wallets = await loadWalletsFromSupabase();
            const walletsList = document.getElementById('walletsList');

            // Update global wallet selector - REMOVED BALANCE FROM DISPLAY
            globalWalletSelect.innerHTML = '<option value="">Select a wallet</option>';
            wallets.forEach(wallet => {
                const option = document.createElement('option');
                option.value = wallet.id;
                // Only show wallet name, no balance
                option.textContent = wallet.name;
                globalWalletSelect.appendChild(option);
            });

            // Set the current wallet in the selector
            if (currentWalletId && wallets.find(w => w.id === currentWalletId)) {
                globalWalletSelect.value = currentWalletId;
            } else if (wallets.length > 0) {
                currentWalletId = wallets[0].id;
                globalWalletSelect.value = currentWalletId;
            } else {
                currentWalletId = null;
            }

            if (wallets.length === 0) {
                walletsList.innerHTML = `
                    <div class="wallet-item">
                        <div class="wallet-details">
                            <div>No wallets yet. Add your first wallet!</div>
                        </div>
                    </div>
                `;
                return;
            }

            walletsList.innerHTML = '';
            wallets.forEach(wallet => {
                const balance = calculateWalletBalance(wallet.id);
                const walletItem = document.createElement('div');
                walletItem.className = 'wallet-item';
                walletItem.innerHTML = `
                    <div class="wallet-details">
                        <div><strong>${wallet.name}</strong></div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="wallet-balance" style="color: ${balance >= 0 ? 'var(--dark)' : 'var(--danger)'};">
                            ${formatDisplayCurrency(balance)}
                        </div>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="editWallet('${wallet.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" onclick="confirmDelete('wallet', '${wallet.id}', '${wallet.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                walletsList.appendChild(walletItem);
            });
        }

        async function loadCategories() {
            categories = await loadCategoriesFromSupabase();
            const categoriesList = document.getElementById('categoriesList');

            if (categories.length === 0) {
                categoriesList.innerHTML = `
                    <div class="category-item">
                        <div class="category-details">
                            <div>No categories yet. Add your first category!</div>
                        </div>
                    </div>
                `;
            } else {
                // Separate main categories and subcategories
                const mainCategories = categories.filter(c => c.type === 'main');
                const subcategories = categories.filter(c => c.type === 'sub');
                console.log('Main categories for display:', mainCategories);
                console.log('Subcategories for display:', subcategories);

                if (mainCategories.length === 0) {
                    categoriesList.innerHTML = `
                        <div class="category-item">
                            <div class="category-details">
                                <div>No main categories yet. Add your first main category!</div>
                            </div>
                        </div>
                    `;
                } else {
                    categoriesList.innerHTML = '';

                    mainCategories.forEach(category => {
                        const categoryItem = document.createElement('div');
                        categoryItem.className = 'category-item';
                        categoryItem.innerHTML = `
                            <div class="category-details">
                                <div><strong>${category.name}</strong></div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="category-actions">
                                    <button class="add-subcategory-btn" data-id="${category.id}">
                                        <i class="fas fa-plus"></i> Add Subcategory
                                    </button>
                                </div>
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="editCategory('${category.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-btn" onclick="confirmDelete('category', '${category.id}', '${category.name}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                        categoriesList.appendChild(categoryItem);

                        // Add event listener
                        const addSubcategoryBtn = categoryItem.querySelector('.add-subcategory-btn');
                        addSubcategoryBtn.addEventListener('click', () => {
                            console.log('Opening subcategory modal for parent ID:', category.id);
                            openSubcategoryModal(category.id);
                        });

                        // Add subcategories for this main category
                        const categorySubcategories = subcategories.filter(sc => sc.parentId === category.id);
                        categorySubcategories.forEach(subcategory => {
                            const subcategoryItem = document.createElement('div');
                            subcategoryItem.className = 'category-item subcategory-item';
                            subcategoryItem.innerHTML = `
                                <div class="category-details">
                                    <div>${subcategory.name}</div>
                                </div>
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="editCategory('${subcategory.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-btn" onclick="confirmDelete('category', '${subcategory.id}', '${subcategory.name}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            categoriesList.appendChild(subcategoryItem);
                        });
                    });
                }
            }
            updateCategoryDropdowns();
        }

        function updateCategoryDropdowns() {
            console.log('Updating category dropdowns with:', categories);

            // Update expense category dropdown
            const expenseCategorySelect = document.getElementById('expenseCategory');
            const expenseSubcategorySelect = document.getElementById('expenseSubcategory');

            // Clear existing options
            expenseCategorySelect.innerHTML = '<option value="">Select a category</option>';
            expenseSubcategorySelect.innerHTML = '<option value="">Select a subcategory (optional)</option>';

            // Get main categories only
            const mainCategories = categories.filter(c => c.type === 'main');
            console.log('Main categories for dropdown:', mainCategories);

            // Populate main categories dropdown
            mainCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                expenseCategorySelect.appendChild(option);
            });

            // Update parent category dropdown (for category form)
            const parentCategorySelect = document.getElementById('parentCategory');
            parentCategorySelect.innerHTML = '<option value="">Select a parent category</option>';
            mainCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                parentCategorySelect.appendChild(option);
            });

            // Remove any existing event listeners to prevent duplicates
            const newExpenseCategorySelect = expenseCategorySelect.cloneNode(true);
            expenseCategorySelect.parentNode.replaceChild(newExpenseCategorySelect, expenseCategorySelect);

            // Add fresh event listener to new element
            newExpenseCategorySelect.addEventListener('change', function() {
                updateSubcategoryDropdown(this.value);
            });

            // Update subcategory dropdown logic
            window.updateSubcategoryDropdown = function(selectedCategoryName) {
                // Clear subcategory dropdown
                expenseSubcategorySelect.innerHTML = '<option value="">Select a subcategory (optional)</option>';

                // Find the main category object
                const selectedMainCategory = categories.find(c => c.type === 'main' && c.name === selectedCategoryName);

                if (selectedMainCategory) {
                    const subcategories = categories.filter(c => c.type === 'sub' && c.parentId === selectedMainCategory.id);

                    subcategories.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory.name;
                        option.textContent = subcategory.name;
                        expenseSubcategorySelect.appendChild(option);
                    });
                }
            };
        }

        function updateStats() {
            const totalExpenseValue = document.getElementById('totalExpenseValue');
            const totalIncomeValue = document.getElementById('totalIncomeValue');
            const currentBalanceValue = document.getElementById('currentBalanceValue');

            let totalExpenses = 0;
            let totalIncome = 0;
            let currentBalance = 0;

            if (currentWalletId) {
                const walletExpenses = expenses.filter(expense => expense.walletId === currentWalletId);
                totalExpenses = walletExpenses.reduce((sum, expense) => sum + expense.amount, 0);

                const walletIncomes = incomes.filter(income => income.walletId === currentWalletId);
                totalIncome = walletIncomes.reduce((sum, income) => sum + income.amount, 0);

                currentBalance = totalIncome - totalExpenses;
            }

            totalIncomeValue.textContent = formatDisplayCurrency(totalIncome);
            totalExpenseValue.textContent = formatDisplayCurrency(totalExpenses);
            currentBalanceValue.textContent = formatDisplayCurrency(currentBalance);
            currentBalanceValue.style.color = currentBalance >= 0 ? 'var(--dark)' : 'var(--danger)';

            // For debugging
            if (currentWalletId) {
                const currentWallet = wallets.find(w => w.id === currentWalletId);
                console.log(`Stats for Wallet (${currentWallet ? currentWallet.name : 'Unknown'} - ${currentWalletId}):`);
                console.log('Total Income:', totalIncome);
                console.log('Total Expenses:', totalExpenses);
                console.log('Current Balance:', currentBalance);
            }
        }

        // Global Wallet Selector Handler
        globalWalletSelect.addEventListener('change', async function() {
            currentWalletId = this.value;

            // Reload data filtered by the new wallet
            await loadExpenses();
            await loadIncomes();

            // Update stats
            updateStats();
        });

        // Function to ensure wallet selector displays the current wallet
        function updateGlobalWalletSelector() {
            if (currentWalletId) {
                globalWalletSelect.value = currentWalletId;
            }
        }

        // Load all data after login/initial load
        async function loadAllData() {
            console.log('Loading all data...');
            try {
                // 1. Load Wallets (sets initial currentWalletId)
                await loadWallets();

                // 2. Load Categories (needed for other dropdowns)
                await loadCategories();

                // 3. Load Expenses and Incomes
                const [exp, inc] = await Promise.all([
                    loadExpenses(),
                    loadIncomes()
                ]);

                // 4. Update Stats
                updateStats();
                
            } catch (error) {
                console.error('Error loading all dashboard data:', error);
                showAlert('Failed to load dashboard data.', 'error');
            }
        }

        // --- Event Listeners and Initialization ---

        function initApp() {
            // Set today's date for date inputs
            document.getElementById('expenseDate').valueAsDate = new Date();
            document.getElementById('incomeDate').valueAsDate = new Date();

            // Add currency formatting to amount inputs
            document.getElementById('expenseAmount').addEventListener('input', function() {
                this.value = formatCurrency(this.value);
            });
            document.getElementById('incomeAmount').addEventListener('input', function() {
                this.value = formatCurrency(this.value);
            });

            // Tab switching logic
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));

                    this.classList.add('active');
                    document.getElementById(this.getAttribute('data-tab') + 'Tab').classList.add('active');

                    // Reload list data for the newly opened tab (Wallets and Categories don't load all the time)
                    switch (this.getAttribute('data-tab')) {
                        case 'wallets':
                            loadWallets();
                            break;
                        case 'categories':
                            loadCategories();
                            break;
                    }
                });
            });

            // Initial view setup
            checkAuthState();
        }

        // Modal triggers
        loginBtn.addEventListener('click', () => loginModal.classList.add('active'));
        signupBtn.addEventListener('click', () => signupModal.classList.add('active'));
        heroSignupBtn.addEventListener('click', () => signupModal.classList.add('active'));
        ctaSignupBtn.addEventListener('click', () => signupModal.classList.add('active'));
        document.getElementById('showLoginFromSignup').addEventListener('click', (e) => {
            e.preventDefault();
            signupModal.classList.remove('active');
            loginModal.classList.add('active');
        });
        document.getElementById('showSignupFromLogin').addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.classList.remove('active');
            signupModal.classList.add('active');
        });

        // Modal close buttons
        document.getElementById('closeSignupModal').addEventListener('click', () => signupModal.classList.remove('active'));
        document.getElementById('closeLoginModal').addEventListener('click', () => loginModal.classList.remove('active'));
        document.getElementById('closeSubcategoryModal').addEventListener('click', () => subcategoryModal.classList.remove('active'));
        document.getElementById('closeDeleteModal').addEventListener('click', () => deleteModal.classList.remove('active'));

        // Category form type change logic
        categoryTypeSelect.addEventListener('change', function() {
            if (this.value === 'sub') {
                parentCategoryGroup.classList.remove('hidden');
                loadParentCategories();
            } else {
                parentCategoryGroup.classList.add('hidden');
            }
        });

        // Form submissions
        signupForm.addEventListener('submit', handleSignup);
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        expenseForm.addEventListener('submit', handleAddExpense);
        incomeForm.addEventListener('submit', handleAddIncome);
        walletForm.addEventListener('submit', handleAddWallet);
        categoryForm.addEventListener('submit', handleAddCategory);
        subcategoryForm.addEventListener('submit', handleAddSubcategory);

        // Form cancel buttons
        expenseCancelBtn.addEventListener('click', resetExpenseForm);
        incomeCancelBtn.addEventListener('click', resetIncomeForm);
        walletCancelBtn.addEventListener('click', resetWalletForm);
        categoryCancelBtn.addEventListener('click', resetCategoryForm);

        // Delete modal buttons
        cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.remove('active'));
        confirmDeleteBtn.addEventListener('click', handleDeleteItem);

        // Insufficient balance modal buttons
        addFundsBtn.addEventListener('click', () => {
            insufficientBalanceModal.classList.remove('active');
            // Switch to income tab to add funds
            document.querySelector('[data-tab="income"]').click();
            showAlert('Please add income to your wallet first', 'warning');
        });

        cancelExpenseBtn.addEventListener('click', () => {
            insufficientBalanceModal.classList.remove('active');
            pendingExpense = null;
        });

        // Password strength indicator
        signupPassword.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            passwordStrength.className = 'strength-bar';
            if (password.length > 0) {
                if (strength <= 2) passwordStrength.classList.add('strength-weak');
                else if (strength === 3) passwordStrength.classList.add('strength-medium');
                else passwordStrength.classList.add('strength-strong');
            }
        });

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        // Set up auth state listener
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                checkAuthState();
            }
        });
    </script>
</body>
</html>