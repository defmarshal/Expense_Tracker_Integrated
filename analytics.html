<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - FinTrack</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        :root {
            --primary: #9333EA;
            --primary-dark: #7E22CE;
            --primary-light: #C084FC;
            --secondary: #A78BFA;
            --success: #10B981;
            --success-dark: #059669;
            --danger: #EF4444;
            --warning: #F59E0B;
            --light: #F9F5FF;
            --light-gray: #F3F0FF;
            --dark: #2D1B4E;
            --text: #4B3B5C;
            --gray: #9B8BA8;
            --gray-light: #E9E0F5;
            --shadow: 0 2px 8px rgba(147, 51, 234, 0.08);
            --gradient: linear-gradient(135deg, #9333EA 0%, #A78BFA 100%);
            --income-gradient: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }

        body {
            background: linear-gradient(180deg, #F9F5FF 0%, #FFFFFF 100%);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }

        header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(147, 51, 234, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
            text-decoration: none;
        }

        .logo i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link {
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary);
            background-color: rgba(147, 51, 234, 0.1);
        }

        .auth-section {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-outline {
            background-color: transparent;
            border: 1.5px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(147, 51, 234, 0.08);
        }

        .analytics-container {
            max-width: 1100px;
            margin: 80px auto 2rem;
            padding: 0 1rem;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.3rem;
        }

        .page-subtitle {
            font-size: 0.95rem;
            color: var(--gray);
            margin-bottom: 0;
        }

        .selectors-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.2rem;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            border: 1px solid rgba(147, 51, 234, 0.05);
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .card-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0.4rem 0;
        }

        .stat-value.income {
            color: var(--success);
        }

        .stat-value.expense {
            color: var(--primary);
        }

        .stat-value.balance {
            color: var(--dark);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.2rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            height: 320px;
            position: relative;
            border: 1px solid rgba(147, 51, 234, 0.05);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .chart-select {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1.5px solid var(--gray-light);
            background: white;
            color: var(--text);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
        }

        .chart-wrapper {
            position: relative;
            height: calc(100% - 50px);
            width: 100%;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .insight-card {
            background: white;
            border-radius: 12px;
            padding: 1.2rem;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
            border: 1px solid rgba(147, 51, 234, 0.05);
        }

        .insight-card:hover {
            transform: translateY(-2px);
        }

        .insight-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0.8rem;
        }

        .insight-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.95rem;
        }

        .insight-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark);
        }

        .insight-content {
            color: var(--gray);
            line-height: 1.4;
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }

        .insight-value {
            font-size: 1.3rem;
            font-weight: 700;
            margin-top: 0.4rem;
            color: var(--dark);
        }

        .trend-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            margin-top: 0.4rem;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
            font-size: 0.9rem;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.15);
        }

        .back-btn {
            margin-bottom: 1rem;
        }

        .wallet-selector-container, .month-selector-container {
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 12px;
            border-radius: 10px;
            border: 1.5px solid var(--gray-light);
            box-shadow: var(--shadow);
            gap: 8px;
        }

        .wallet-selector-container label, .month-selector-container label {
            font-size: 0.8rem;
            color: var(--gray);
            font-weight: 500;
            margin: 0;
        }

        .comparison-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 1rem;
            padding: 10px;
            background: rgba(147, 51, 234, 0.02);
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .report-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
            border: 1px solid rgba(147, 51, 234, 0.05);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(147, 51, 234, 0.1);
            transition: background-color 0.2s;
        }

        .report-header:hover {
            background-color: rgba(147, 51, 234, 0.02);
        }

        .report-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .report-toggle {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .report-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .report-content {
            padding: 1rem;
            transition: max-height 0.3s ease;
            overflow-x: auto;
        }

        .report-content.collapsed {
            display: none;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .report-table th {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray-light);
            font-weight: 600;
            color: var(--dark);
            background-color: rgba(147, 51, 234, 0.03);
        }

        .report-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray-light);
        }

        .category-row {
            font-weight: 600;
            background-color: rgba(147, 51, 234, 0.04);
        }

        .subcategory-row {
            padding-left: 24px !important;
            background-color: rgba(147, 51, 234, 0.01);
        }

        .amount-cell {
            text-align: right;
            font-weight: 500;
        }

        .percentage-cell {
            text-align: center;
            font-size: 0.8rem;
            color: var(--gray);
            width: 70px;
        }

        .total-row {
            font-weight: 700;
            background-color: rgba(147, 51, 234, 0.08);
            border-top: 2px solid var(--primary);
        }

        .no-data-message {
            text-align: center;
            padding: 1.5rem 1rem;
            color: var(--gray);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            header {
                padding: 0.6rem 0.8rem;
            }

            .analytics-container {
                margin-top: 70px;
                padding: 0 0.8rem;
            }

            .page-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .page-subtitle {
                font-size: 0.85rem;
            }

            .nav-links {
                display: none;
            }

            .analytics-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 0.8rem;
            }

            .card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.3rem;
            }

            .chart-container {
                height: 280px;
                padding: 1rem;
            }

            .insights-grid {
                grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
                gap: 0.8rem;
            }

            .insight-card {
                padding: 1rem;
            }

            .selectors-container {
                flex-direction: column;
                width: 100%;
                gap: 0.8rem;
            }

            .wallet-selector-container, .month-selector-container {
                width: 100%;
            }

            .comparison-legend {
                gap: 8px;
            }

            .report-table {
                font-size: 0.8rem;
            }

            .report-table th, .report-table td {
                padding: 8px 10px;
            }

            .subcategory-row {
                padding-left: 20px !important;
            }
        }

        @media (max-width: 480px) {
            header {
                padding: 0.5rem 0.6rem;
            }

            .logo {
                font-size: 1.1rem;
                gap: 6px;
            }

            .logo i {
                font-size: 1.2rem;
            }

            .auth-section .btn span {
                display: none;
            }

            .auth-section .btn {
                padding: 8px 10px;
                gap: 0;
            }

            .page-title {
                font-size: 1.3rem;
            }

            .analytics-container {
                margin-top: 65px;
            }

            .analytics-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }

            .chart-container {
                height: 260px;
                padding: 0.8rem;
            }

            .card {
                padding: 0.9rem;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .stat-label {
                font-size: 0.7rem;
            }

            .insight-card {
                padding: 0.9rem;
            }

            .report-table {
                font-size: 0.75rem;
            }

            .report-table th, .report-table td {
                padding: 6px 8px;
            }

            .percentage-cell {
                width: 60px;
                font-size: 0.7rem;
            }

            .chart-select {
                padding: 6px 8px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo">
            <i class="fas fa-chart-pie"></i>
            <span>FinTrack</span>
        </a>
        
        <div class="nav-links">
            <a href="index.html" class="nav-link">
                <i class="fas fa-home"></i>
                Dashboard
            </a>
            <a href="analytics.html" class="nav-link active">
                <i class="fas fa-chart-bar"></i>
                Analytics
            </a>
        </div>
        
        <div class="auth-section">
            <button id="loginBtn" class="btn btn-outline">
                <i class="fas fa-sign-in-alt"></i>
                <span>Sign In</span>
            </button>
            <button id="signupBtn" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>
                <span>Join</span>
            </button>
            <button id="logoutBtn" class="btn btn-outline hidden">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sign Out</span>
            </button>
        </div>
    </header>

    <div class="analytics-container">
        <a href="index.html" class="btn btn-outline back-btn">
            <i class="fas fa-arrow-left"></i>
            Back
        </a>
        
        <div class="page-header">
            <div>
                <h1 class="page-title">Analytics</h1>
                <p class="page-subtitle">Your financial insights at a glance</p>
            </div>
            <div class="selectors-container">
                <div class="wallet-selector-container">
                    <label for="walletSelect">Wallet:</label>
                    <select id="walletSelect" class="chart-select">
                        <option value="all">All</option>
                    </select>
                </div>
                <div class="month-selector-container">
                    <label for="monthSelect">Month:</label>
                    <select id="monthSelect" class="chart-select"></select>
                </div>
            </div>
        </div>

        <div id="noDataAlert" class="alert alert-warning hidden">
            <i class="fas fa-exclamation-triangle"></i>
            <span>No data yet. Add expenses to see analytics.</span>
        </div>

        <div id="analyticsContent">
            <div class="analytics-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Balance</h3>
                        <div class="card-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                    <div class="stat-value balance" id="totalBalance">Rp 0</div>
                    <div class="stat-label" id="balanceLabel">This month</div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Income</h3>
                        <div class="card-icon" style="background: var(--income-gradient);">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                    </div>
                    <div class="stat-value income" id="totalIncome">Rp 0</div>
                    <div class="stat-label" id="incomeLabel">This month</div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Expenses</h3>
                        <div class="card-icon" style="background: var(--danger);">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                    <div class="stat-value expense" id="totalExpenses">Rp 0</div>
                    <div class="stat-label" id="expenseLabel">This month</div>
                </div>
            </div>

            <div class="report-container">
                <div class="report-header" id="reportHeader">
                    <div class="report-title">
                        <i class="fas fa-file-invoice"></i>
                        Expense Summary
                    </div>
                    <button class="report-toggle" id="reportToggle">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="report-content" id="reportContent">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="amount-cell">Amount</th>
                                <th class="percentage-cell">%</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title" id="categoryChartTitle">By Category</h3>
                </div>
                <div class="chart-wrapper">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title" id="trendChartTitle">Trend</h3>
                    <select id="trendRange" class="chart-select">
                        <option value="3">3mo</option>
                        <option value="6" selected>6mo</option>
                        <option value="12">12mo</option>
                    </select>
                </div>
                <div class="chart-wrapper">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title" id="comparisonChartTitle">Daily Trend</h3>
                    <select id="comparisonRange" class="chart-select">
                        <option value="3">3mo</option>
                        <option value="6" selected>6mo</option>
                        <option value="9">9mo</option>
                        <option value="12">12mo</option>
                    </select>
                </div>
                <div class="chart-wrapper">
                    <canvas id="comparisonChart"></canvas>
                </div>
                <div class="comparison-legend" id="comparisonLegend"></div>
            </div>

            <div class="insights-grid">
                <div class="insight-card">
                    <div class="insight-header">
                        <div class="insight-icon" style="background: var(--success);">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                        <h3 class="insight-title">Savings Rate</h3>
                    </div>
                    <p class="insight-content">% of income saved</p>
                    <div class="insight-value" id="savingsRate">0%</div>
                    <div class="trend-indicator" id="savingsTrend">
                        <i class="fas fa-arrow-up trend-up"></i>
                        <span>Up</span>
                    </div>
                </div>
                
                <div class="insight-card">
                    <div class="insight-header">
                        <div class="insight-icon" style="background: var(--warning);">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h3 class="insight-title">Top Category</h3>
                    </div>
                    <p class="insight-content">Highest spending</p>
                    <div class="insight-value" id="topCategory">-</div>
                    <div class="insight-content" id="topCategoryAmount" style="color: var(--dark); font-weight: 500;">Rp 0</div>
                </div>
                
                <div class="insight-card">
                    <div class="insight-header">
                        <div class="insight-icon" style="background: var(--primary);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3 class="insight-title">Avg/Month</h3>
                    </div>
                    <p class="insight-content">Average spending</p>
                    <div class="insight-value" id="monthlyAverage">Rp 0</div>
                    <div class="trend-indicator" id="averageTrend">
                        <i class="fas fa-arrow-down trend-down"></i>
                        <span>Down</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="alertContainer" style="position: fixed; top: 80px; right: 12px; z-index: 3000; max-width: 320px;"></div>

    <script>
        const SUPABASE_URL = 'https://slgzgaojmgzjhtuaptod.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZ3pnYW9qbWd6amh0dWFwdG9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNzQyMzMsImV4cCI6MjA3ODg1MDIzM30.aD9cjbekiufRaatuNaAEP2uD2uU7ggpPor6jtSGM-F4';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const walletSelect = document.getElementById('walletSelect');
        const monthSelect = document.getElementById('monthSelect');
        const trendRange = document.getElementById('trendRange');
        const comparisonRange = document.getElementById('comparisonRange');
        const noDataAlert = document.getElementById('noDataAlert');
        const analyticsContent = document.getElementById('analyticsContent');
        const alertContainer = document.getElementById('alertContainer');
        const reportHeader = document.getElementById('reportHeader');
        const reportToggle = document.getElementById('reportToggle');
        const reportContent = document.getElementById('reportContent');
        const reportTableBody = document.getElementById('reportTableBody');

        let expenses = [];
        let incomes = [];
        let wallets = [];
        let categories = [];
        let currentWalletId = 'all';
        let selectedMonth = null;
        let availableMonths = [];
        let isReportExpanded = true;

        let categoryChart = null;
        let trendChart = null;
        let comparisonChart = null;

        function formatDisplayCurrency(amount) {
            return `Rp ${amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }

        async function checkAuthState() {
            try {
                console.log('Checking auth state...');
                const { data: { user } } = await supabase.auth.getUser();
                console.log('Current user:', user);
                
                if (user && user.email_confirmed_at) {
                    console.log('User authenticated and confirmed');
                    loginBtn.classList.add('hidden');
                    signupBtn.classList.add('hidden');
                    logoutBtn.classList.remove('hidden');
                    await loadData();
                } else if (user) {
                    console.log('User not confirmed');
                    showAlert('Verify your email first', 'warning');
                    loginBtn.classList.remove('hidden');
                    signupBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    showNoDataMessage();
                } else {
                    console.log('No user logged in');
                    loginBtn.classList.remove('hidden');
                    signupBtn.classList.remove('hidden');
                    logoutBtn.classList.add('hidden');
                    showNoDataMessage();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showNoDataMessage();
            }
        }

        async function loadData() {
            try {
                console.log('Loading data...');
                await loadWallets();
                await loadExpenses();
                await loadIncomes();
                await loadCategories();
                
                console.log('Expenses:', expenses.length);
                console.log('Incomes:', incomes.length);
                
                if (expenses.length === 0 && incomes.length === 0) {
                    showNoDataMessage();
                } else {
                    hideNoDataMessage();
                    generateAvailableMonths();
                    console.log('About to update analytics, selectedMonth:', selectedMonth);
                    updateAnalytics();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showNoDataMessage();
            }
        }

        function generateAvailableMonths() {
            const allDates = [
                ...expenses.map(e => e.date),
                ...incomes.map(i => i.date)
            ];
            
            const uniqueMonths = [...new Set(allDates.map(date => {
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();
            
            availableMonths = uniqueMonths;
            console.log('Available months:', availableMonths);
            updateMonthSelector();
            
            if (availableMonths.length > 0 && !selectedMonth) {
                selectedMonth = availableMonths[0];
                console.log('Selected month set to:', selectedMonth);
            }
        }

        function updateMonthSelector() {
            monthSelect.innerHTML = '';
            availableMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                const [year, monthNum] = month.split('-');
                const monthName = new Date(year, monthNum - 1).toLocaleDateString('en-US', { 
                    month: 'short', 
                    year: '2-digit' 
                });
                option.textContent = monthName;
                monthSelect.appendChild(option);
            });
            
            if (selectedMonth && availableMonths.includes(selectedMonth)) {
                monthSelect.value = selectedMonth;
            } else if (availableMonths.length > 0) {
                monthSelect.value = availableMonths[0];
            }
        }

        async function loadWallets() {
            try {
                console.log('Loading wallets...');
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.log('No user for wallets');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('wallets')
                    .select('*')
                    .eq('user_id', user.id);
                
                if (error) {
                    console.error('Wallet load error:', error);
                    throw error;
                }
                wallets = data.map(w => ({ id: w.id, name: w.name }));
                console.log('Wallets loaded:', wallets.length);
                updateWalletSelector();
            } catch (error) {
                console.error('Error loading wallets:', error);
            }
        }

        async function loadExpenses() {
            try {
                console.log('Loading expenses...');
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.log('No user for expenses');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('date', { ascending: false });
                
                if (error) {
                    console.error('Expense load error:', error);
                    throw error;
                }
                expenses = data.map(e => ({
                    id: e.id,
                    description: e.description,
                    amount: e.amount,
                    date: e.date,
                    category: e.category,
                    subcategory: e.subcategory,
                    walletId: e.wallet_id
                }));
                console.log('Expenses loaded:', expenses.length);
                if (expenses.length > 0) {
                    console.log('First expense:', expenses[0]);
                }
            } catch (error) {
                console.error('Error loading expenses:', error);
            }
        }

        async function loadIncomes() {
            try {
                console.log('Loading incomes...');
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.log('No user for incomes');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('incomes')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('date', { ascending: false });
                
                if (error) {
                    console.error('Income load error:', error);
                    throw error;
                }
                incomes = data.map(i => ({
                    id: i.id,
                    description: i.description,
                    amount: i.amount,
                    date: i.date,
                    source: i.source,
                    walletId: i.wallet_id
                }));
                console.log('Incomes loaded:', incomes.length);
            } catch (error) {
                console.error('Error loading incomes:', error);
            }
        }

        async function loadCategories() {
            try {
                console.log('Loading categories...');
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.log('No user for categories');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: true });
                
                if (error) {
                    console.error('Category load error:', error);
                    throw error;
                }
                categories = data.map(c => ({
                    id: c.id,
                    name: c.name,
                    type: c.type || 'main',
                    parentId: c.parent_id
                }));
                console.log('Categories loaded:', categories.length);
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function updateWalletSelector() {
            walletSelect.innerHTML = '<option value="all">All Wallets</option>';
            wallets.forEach(wallet => {
                const option = document.createElement('option');
                option.value = wallet.id;
                option.textContent = wallet.name;
                walletSelect.appendChild(option);
            });
        }

        function filterDataByWallet(data) {
            if (currentWalletId === 'all') return data;
            return data.filter(item => item.walletId === currentWalletId);
        }

        function getTrendData(endMonth, period) {
            const months = availableMonths.sort();
            let endIndex = months.indexOf(endMonth);
            if (endIndex === -1) endIndex = months.length - 1;
            
            const startIndex = Math.max(0, endIndex - period + 1);
            const trendMonths = months.slice(startIndex, endIndex + 1);
            
            const incomeData = trendMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const monthlyIncome = filterDataByWallet(incomes).filter(income => {
                    const incomeDate = new Date(income.date);
                    return incomeDate.getMonth() + 1 === parseInt(monthNum) && 
                           incomeDate.getFullYear() === parseInt(year);
                });
                return monthlyIncome.reduce((sum, income) => sum + income.amount, 0);
            });
            
            const expenseData = trendMonths.map(month => {
                const [year, monthNum] = month.split('-');
                const monthlyExpenses = filterDataByWallet(expenses).filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate.getMonth() + 1 === parseInt(monthNum) && 
                           expenseDate.getFullYear() === parseInt(year);
                });
                return monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            });
            
            return { months: trendMonths, income: incomeData, expense: expenseData };
        }

        function getDailyExpenseData(month) {
            const [year, monthNum] = month.split('-');
            const daysInMonth = new Date(year, monthNum, 0).getDate();
            const dailyData = Array(daysInMonth).fill(0);
            
            const monthExpenses = filterDataByWallet(expenses).filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === parseInt(monthNum) && 
                       expenseDate.getFullYear() === parseInt(year);
            });
            
            monthExpenses.forEach(expense => {
                const day = new Date(expense.date).getDate();
                dailyData[day - 1] += expense.amount;
            });
            
            return dailyData;
        }

        function getDailyComparisonData(period) {
            if (!selectedMonth) return null;
            
            const [currentYear, currentMonthNum] = selectedMonth.split('-');
            const daysInCurrentMonth = new Date(currentYear, currentMonthNum, 0).getDate();
            const currentMonthDaily = getDailyExpenseData(selectedMonth);
            
            const months = availableMonths.sort();
            const currentMonthIndex = months.indexOf(selectedMonth);
            if (currentMonthIndex === -1) return null;
            
            const startIndex = Math.max(0, currentMonthIndex - period);
            const historicalMonths = months.slice(startIndex, currentMonthIndex);
            
            const dailyAverages = Array(daysInCurrentMonth).fill(0);
            const dayCounts = Array(daysInCurrentMonth).fill(0);
            
            historicalMonths.forEach(month => {
                const [year, monthNum] = month.split('-');
                const daysInHistoricalMonth = new Date(year, monthNum, 0).getDate();
                const historicalDailyData = getDailyExpenseData(month);
                
                for (let day = 0; day < daysInCurrentMonth; day++) {
                    if (day < daysInHistoricalMonth) {
                        dailyAverages[day] += historicalDailyData[day];
                        dayCounts[day]++;
                    } else {
                        dailyAverages[day] += historicalDailyData[daysInHistoricalMonth - 1];
                        dayCounts[day]++;
                    }
                }
            });
            
            const historicalAverageDaily = dailyAverages.map((sum, index) => 
                dayCounts[index] > 0 ? sum / dayCounts[index] : 0
            );
            
            const currentMonthCumulative = [];
            const historicalAverageCumulative = [];
            
            let currentSum = 0;
            let historicalSum = 0;
            
            for (let i = 0; i < daysInCurrentMonth; i++) {
                currentSum += currentMonthDaily[i];
                historicalSum += historicalAverageDaily[i];
                currentMonthCumulative.push(currentSum);
                historicalAverageCumulative.push(historicalSum);
            }
            
            return {
                days: Array.from({length: daysInCurrentMonth}, (_, i) => i + 1),
                currentMonthDaily: currentMonthDaily,
                currentMonthCumulative: currentMonthCumulative,
                historicalAverageDaily: historicalAverageDaily,
                historicalAverageCumulative: historicalAverageCumulative
            };
        }

        function generateMonthlyExpenseReport() {
            if (!selectedMonth) return null;
            
            const filteredExpenses = filterDataByWallet(expenses);
            const [selectedYear, selectedMonthNum] = selectedMonth.split('-');
            
            const monthlyExpenses = filteredExpenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === parseInt(selectedMonthNum) && 
                       expenseDate.getFullYear() === parseInt(selectedYear);
            });
            
            if (monthlyExpenses.length === 0) return null;
            
            const totalExpenses = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const categoryData = {};
            
            monthlyExpenses.forEach(expense => {
                const category = expense.category || 'Uncategorized';
                const subcategory = expense.subcategory || 'General';
                
                if (!categoryData[category]) {
                    categoryData[category] = { total: 0, subcategories: {} };
                }
                
                categoryData[category].total += expense.amount;
                
                if (!categoryData[category].subcategories[subcategory]) {
                    categoryData[category].subcategories[subcategory] = 0;
                }
                categoryData[category].subcategories[subcategory] += expense.amount;
            });
            
            return { totalExpenses, categoryData };
        }

        function updateMonthlyExpenseReport() {
            const reportData = generateMonthlyExpenseReport();
            reportTableBody.innerHTML = '';
            
            if (!reportData) {
                reportTableBody.innerHTML = `<tr><td colspan="3" class="no-data-message">No data</td></tr>`;
                return;
            }
            
            const { totalExpenses, categoryData } = reportData;
            
            Object.keys(categoryData).forEach(category => {
                const categoryTotal = categoryData[category].total;
                const percentage = Math.round((categoryTotal / totalExpenses) * 100);
                
                const categoryRow = document.createElement('tr');
                categoryRow.className = 'category-row';
                categoryRow.innerHTML = `
                    <td>${category}</td>
                    <td class="amount-cell">${formatDisplayCurrency(categoryTotal)}</td>
                    <td class="percentage-cell">${percentage}%</td>
                `;
                reportTableBody.appendChild(categoryRow);
                
                Object.keys(categoryData[category].subcategories).forEach(subcategory => {
                    const subcategoryAmount = categoryData[category].subcategories[subcategory];
                    const subPercentage = Math.round((subcategoryAmount / categoryTotal) * 100);
                    
                    const subcategoryRow = document.createElement('tr');
                    subcategoryRow.className = 'subcategory-row';
                    subcategoryRow.innerHTML = `
                        <td>${subcategory}</td>
                        <td class="amount-cell">${formatDisplayCurrency(subcategoryAmount)}</td>
                        <td class="percentage-cell">${subPercentage}%</td>
                    `;
                    reportTableBody.appendChild(subcategoryRow);
                });
            });
            
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td>Total</td>
                <td class="amount-cell">${formatDisplayCurrency(totalExpenses)}</td>
                <td class="percentage-cell">100%</td>
            `;
            reportTableBody.appendChild(totalRow);
        }

        function updateAnalytics() {
            updateSummaryCards();
            updateCategoryChart();
            updateTrendChart();
            updateComparisonChart();
            updateMonthlyExpenseReport();
            updateInsights();
        }

        function updateSummaryCards() {
            if (!selectedMonth) return;
            
            const filteredExpenses = filterDataByWallet(expenses);
            const filteredIncomes = filterDataByWallet(incomes);
            const [selectedYear, selectedMonthNum] = selectedMonth.split('-');
            
            const monthlyExpenses = filteredExpenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === parseInt(selectedMonthNum) && 
                       expenseDate.getFullYear() === parseInt(selectedYear);
            });
            
            const monthlyIncomes = filteredIncomes.filter(income => {
                const incomeDate = new Date(income.date);
                return incomeDate.getMonth() + 1 === parseInt(selectedMonthNum) && 
                       incomeDate.getFullYear() === parseInt(selectedYear);
            });
            
            const totalExpensesAmount = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalIncomeAmount = monthlyIncomes.reduce((sum, income) => sum + income.amount, 0);
            const totalBalance = totalIncomeAmount - totalExpensesAmount;
            
            document.getElementById('totalBalance').textContent = formatDisplayCurrency(totalBalance);
            document.getElementById('totalIncome').textContent = formatDisplayCurrency(totalIncomeAmount);
            document.getElementById('totalExpenses').textContent = formatDisplayCurrency(totalExpensesAmount);
        }

        function updateCategoryChart() {
            if (!selectedMonth) return;
            
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (categoryChart) categoryChart.destroy();
            
            const filteredExpenses = filterDataByWallet(expenses);
            const [selectedYear, selectedMonthNum] = selectedMonth.split('-');
            
            const monthFilteredExpenses = filteredExpenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === parseInt(selectedMonthNum) && 
                       expenseDate.getFullYear() === parseInt(selectedYear);
            });
            
            const categoryTotals = {};
            monthFilteredExpenses.forEach(expense => {
                const category = expense.category || 'Other';
                categoryTotals[category] = (categoryTotals[category] || 0) + expense.amount;
            });
            
            const categories = Object.keys(categoryTotals);
            const amounts = Object.values(categoryTotals);
            
            const backgroundColors = categories.map((_, index) => {
                const hue = (index * 137.5) % 360;
                return `hsl(${hue}, 65%, 60%)`;
            });
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: amounts,
                        backgroundColor: backgroundColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 10, font: { size: 10 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${formatDisplayCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTrendChart() {
            if (!selectedMonth) return;
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();
            
            const period = parseInt(trendRange.value);
            const trendData = getTrendData(selectedMonth, period);
            
            const labels = trendData.months.map(month => {
                const [year, monthNum] = month.split('-');
                return new Date(year, monthNum - 1).toLocaleDateString('en-US', { 
                    month: 'short', 
                    year: '2-digit' 
                });
            });
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Income',
                            data: trendData.income,
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 3
                        },
                        {
                            label: 'Expenses',
                            data: trendData.expense,
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { boxWidth: 10, font: { size: 10 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatDisplayCurrency(context.raw || 0)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (v) => formatDisplayCurrency(v), font: { size: 9 } }
                        }
                    }
                }
            });
        }

        function updateComparisonChart() {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            if (comparisonChart) comparisonChart.destroy();
            
            const period = parseInt(comparisonRange.value);
            const comparisonData = getDailyComparisonData(period);
            if (!comparisonData) return;
            
            updateComparisonLegend([
                'Current Daily',
                'Current Cumulative',
                'Average Daily',
                'Average Cumulative'
            ], [
                'rgba(239, 68, 68, 0.8)',
                'rgba(239, 68, 68, 1)',
                'rgba(147, 51, 234, 0.8)',
                'rgba(147, 51, 234, 1)'
            ]);
            
            comparisonChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: comparisonData.days,
                    datasets: [
                        {
                            label: 'Current Daily',
                            data: comparisonData.currentMonthDaily,
                            borderColor: 'rgba(239, 68, 68, 0.8)',
                            backgroundColor: 'rgba(239, 68, 68, 0.05)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Current Cumulative',
                            data: comparisonData.currentMonthCumulative,
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'Average Daily',
                            data: comparisonData.historicalAverageDaily,
                            borderColor: 'rgba(147, 51, 234, 0.8)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Average Cumulative',
                            data: comparisonData.historicalAverageCumulative,
                            borderColor: 'rgba(147, 51, 234, 1)',
                            borderWidth: 3,
                            tension: 0.3,
                            fill: false,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (v) => formatDisplayCurrency(v), font: { size: 9 } } }
                    }
                }
            });
        }

        function updateComparisonLegend(labels, colors) {
            const legendContainer = document.getElementById('comparisonLegend');
            legendContainer.innerHTML = '';
            labels.forEach((label, index) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = colors[index];
                const labelText = document.createElement('span');
                labelText.textContent = label;
                legendItem.appendChild(colorBox);
                legendItem.appendChild(labelText);
                legendContainer.appendChild(legendItem);
            });
        }

        function updateInsights() {
            if (!selectedMonth) return;
            
            const filteredExpenses = filterDataByWallet(expenses);
            const filteredIncomes = filterDataByWallet(incomes);
            const [selectedYear, selectedMonthNum] = selectedMonth.split('-');
            
            const monthlyExpenses = filteredExpenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === parseInt(selectedMonthNum) && 
                       expenseDate.getFullYear() === parseInt(selectedYear);
            });
            
            const monthlyIncomes = filteredIncomes.filter(income => {
                const incomeDate = new Date(income.date);
                return incomeDate.getMonth() + 1 === parseInt(selectedMonthNum) && 
                       incomeDate.getFullYear() === parseInt(selectedYear);
            });
            
            const totalExpensesAmount = monthlyExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalIncomeAmount = monthlyIncomes.reduce((sum, income) => sum + income.amount, 0);
            
            const savingsRate = totalIncomeAmount > 0 ? 
                Math.round(((totalIncomeAmount - totalExpensesAmount) / totalIncomeAmount) * 100) : 0;
            document.getElementById('savingsRate').textContent = `${savingsRate}%`;
            
            const categoryTotals = {};
            monthlyExpenses.forEach(expense => {
                const category = expense.category || 'Other';
                categoryTotals[category] = (categoryTotals[category] || 0) + expense.amount;
            });
            
            let topCategory = '-';
            let topCategoryAmount = 0;
            Object.keys(categoryTotals).forEach(category => {
                if (categoryTotals[category] > topCategoryAmount) {
                    topCategory = category;
                    topCategoryAmount = categoryTotals[category];
                }
            });
            
            document.getElementById('topCategory').textContent = topCategory;
            document.getElementById('topCategoryAmount').textContent = formatDisplayCurrency(topCategoryAmount);
            
            const sixMonthsAgo = new Date(selectedYear, selectedMonthNum - 1 - 6, 1);
            const lastSixMonthsExpenses = filteredExpenses.filter(expense => {
                return new Date(expense.date) >= sixMonthsAgo;
            });
            
            const monthlyTotals = {};
            lastSixMonthsExpenses.forEach(expense => {
                const expenseDate = new Date(expense.date);
                const monthKey = `${expenseDate.getFullYear()}-${expenseDate.getMonth() + 1}`;
                monthlyTotals[monthKey] = (monthlyTotals[monthKey] || 0) + expense.amount;
            });
            
            const monthlyValues = Object.values(monthlyTotals);
            const monthlyAverage = monthlyValues.length > 0 ? 
                monthlyValues.reduce((sum, amount) => sum + amount, 0) / monthlyValues.length : 0;
            
            document.getElementById('monthlyAverage').textContent = formatDisplayCurrency(Math.round(monthlyAverage));
        }

        function showNoDataMessage() {
            noDataAlert.classList.remove('hidden');
            analyticsContent.classList.add('hidden');
        }

        function hideNoDataMessage() {
            noDataAlert.classList.add('hidden');
            analyticsContent.classList.remove('hidden');
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 
                         type === 'warning' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle';
            alert.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }

        function toggleReport() {
            isReportExpanded = !isReportExpanded;
            if (isReportExpanded) {
                reportContent.classList.remove('collapsed');
                reportToggle.classList.remove('collapsed');
            } else {
                reportContent.classList.add('collapsed');
                reportToggle.classList.add('collapsed');
            }
        }

        walletSelect.addEventListener('change', function() {
            currentWalletId = this.value;
            updateAnalytics();
        });

        monthSelect.addEventListener('change', function() {
            selectedMonth = this.value;
            console.log('Month changed to:', selectedMonth);
            updateAnalytics();
        });

        trendRange.addEventListener('change', updateTrendChart);
        comparisonRange.addEventListener('change', updateComparisonChart);
        reportHeader.addEventListener('click', toggleReport);

        loginBtn.addEventListener('click', () => window.location.href = 'index.html');
        signupBtn.addEventListener('click', () => window.location.href = 'index.html');

        logoutBtn.addEventListener('click', async () => {
            try {
                await supabase.auth.signOut();
                showAlert('Logged out', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking auth state...');
            checkAuthState();
        });
        
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                checkAuthState();
            }
        });
    </script>
</body>
</html>