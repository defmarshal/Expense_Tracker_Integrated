<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTrack - Smart Expense Tracking</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        :root {
            /* Purple-based casual theme */
            --primary: #9333EA;
            --primary-dark: #7E22CE;
            --primary-light: #C084FC;
            --secondary: #A78BFA;
            --success: #10B981;
            --success-dark: #059669;
            --danger: #EF4444;
            --warning: #F59E0B;
            --light: #F9F5FF;
            --light-gray: #F3F0FF;
            --dark: #2D1B4E;
            --text: #4B3B5C;
            --gray: #9B8BA8;
            --gray-light: #E9E0F5;
            --shadow: 0 2px 8px rgba(147, 51, 234, 0.08);
            --gradient: linear-gradient(135deg, #9333EA 0%, #A78BFA 100%);
            --income-gradient: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }

        body {
            background: linear-gradient(180deg, #F9F5FF 0%, #FFFFFF 100%);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Navigation Links Styles */
        .nav-links {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-link {
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.9rem;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary);
            background-color: rgba(147, 51, 234, 0.1);
        }

        header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(147, 51, 234, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
        }

        .logo i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .auth-section {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--success-dark);
        }

        .btn-outline {
            background-color: transparent;
            border: 1.5px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(147, 51, 234, 0.08);
        }

        /* Landing Page Styles */
        .landing-page {
            display: none;
        }

        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, #F9F5FF 0%, #FFFFFF 100%);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            background: var(--gradient);
            opacity: 0.05;
            top: -300px;
            right: -150px;
            z-index: 0;
        }

        .hero-content {
            max-width: 800px;
            z-index: 1;
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.1;
        }

        .hero p {
            font-size: 1.2rem;
            color: var(--gray);
            margin-bottom: 2rem;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .hero-image {
            max-width: 800px;
            width: 100%;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(147, 51, 234, 0.12);
            overflow: hidden;
            margin-top: 1.5rem;
            border: 1px solid rgba(147, 51, 234, 0.1);
        }

        .features {
            padding: 4rem 2rem;
            background-color: var(--light);
        }

        .section-header {
            text-align: center;
            max-width: 650px;
            margin: 0 auto 3rem;
        }

        .section-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
            color: var(--dark);
        }

        .section-subtitle {
            font-size: 1.1rem;
            color: var(--gray);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            max-width: 1100px;
            margin: 0 auto;
        }

        .feature-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid rgba(147, 51, 234, 0.05);
        }

        .feature-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 20px rgba(147, 51, 234, 0.12);
        }

        .feature-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            background: var(--gradient);
            color: white;
            font-size: 1.5rem;
        }

        .feature-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.8rem;
            color: var(--dark);
        }

        .feature-description {
            color: var(--gray);
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .cta {
            padding: 4rem 2rem;
            background: var(--gradient);
            color: white;
            text-align: center;
        }

        .cta h2 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .cta p {
            font-size: 1.1rem;
            max-width: 550px;
            margin: 0 auto 2rem;
            opacity: 0.95;
        }

        .cta-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-white {
            background: white;
            color: var(--primary);
        }

        .btn-white:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        footer {
            padding: 3rem 2rem 1.5rem;
            background: var(--dark);
            color: white;
        }

        .footer-content {
            max-width: 1100px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .footer-column h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 0.6rem;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: color 0.3s;
            font-size: 0.9rem;
        }

        .footer-links a:hover {
            color: white;
        }

        .footer-bottom {
            max-width: 1100px;
            margin: 0 auto;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
        }

        /* Dashboard Styles */
        .dashboard-container {
            display: none;
            min-height: 100vh;
            padding-top: 70px;
            padding-bottom: 2rem;
            background: linear-gradient(180deg, #F9F5FF 0%, #FFFFFF 100%);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .dashboard-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 1.2rem;
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid rgba(147, 51, 234, 0.05);
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0.4rem 0;
        }

        .stat-value.income {
            color: var(--success);
        }

        .stat-value.expense {
            color: var(--primary);
        }

        .stat-value.balance {
            color: var(--dark);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .dashboard-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
            gap: 0.5rem;
        }

        .tab {
            flex: 1;
            padding: 0.8rem 1rem;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--gray);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-card {
            background: white;
            border-radius: 14px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(147, 51, 234, 0.05);
        }

        .form-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.2rem;
            color: var(--dark);
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        label {
            display: block;
            margin-bottom: 0.4rem;
            font-weight: 500;
            color: var(--text);
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1.5px solid var(--gray-light);
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s;
            min-width: 0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: white;
        }

        select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239B8BA8%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.3-5.4-13z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 0.6em auto;
            padding-right: 32px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .expense-list, .wallet-list, .category-list, .income-list {
            background: white;
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(147, 51, 234, 0.05);
        }

        .expense-item, .wallet-item, .category-item, .income-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--gray-light);
            gap: 1rem;
        }

        .expense-item:last-child, .wallet-item:last-child, .category-item:last-child, .income-item:last-child {
            border-bottom: none;
        }

        .expense-details, .wallet-details, .category-details, .income-details {
            flex: 1;
            min-width: 0;
        }

        .expense-amount, .wallet-balance, .income-amount {
            font-weight: 600;
            font-size: 1rem;
            color: var(--dark);
        }

        .expense-amount {
            color: var(--primary);
        }

        .income-amount {
            color: var(--success);
        }

        .expense-category, .income-source {
            background: var(--light-gray);
            padding: 3px 10px;
            border-radius: 16px;
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 0.3rem;
            display: inline-block;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-shrink: 0;
        }

        .edit-btn, .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
        }

        .edit-btn {
            color: var(--primary);
        }

        .edit-btn:hover {
            background: rgba(147, 51, 234, 0.1);
        }

        .delete-btn {
            color: var(--danger);
        }

        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(45, 27, 78, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 1rem;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(45, 27, 78, 0.15);
            width: 100%;
            max-width: 450px;
            padding: 0;
            overflow: hidden;
            transform: translateY(30px) scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            background: var(--gradient);
            color: white;
            padding: 1.5rem;
            text-align: center;
            position: relative;
        }

        .modal-header.income {
            background: var(--income-gradient);
        }

        .modal-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }

        .modal-subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        .password-strength {
            height: 3px;
            background: #eee;
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0;
            transition: width 0.3s, background 0.3s;
        }

        .strength-weak {
            background: var(--danger);
            width: 33%;
        }

        .strength-medium {
            background: var(--warning);
            width: 66%;
        }

        .strength-strong {
            background: var(--success);
            width: 100%;
        }

        /* Alert Styles */
        .alert {
            padding: 11px 14px;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
            font-size: 0.9rem;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .alert-error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .alert-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .hidden {
            display: none !important;
        }

        .currency-input {
            position: relative;
        }

        .currency-input input {
            padding-left: 32px;
        }

        .currency-symbol {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .subcategory-item {
            padding-left: 1.5rem;
            color: var(--gray);
            border-left: 2px solid var(--gray-light);
            margin-left: 0.8rem;
        }

        .category-actions {
            display: flex;
            gap: 0.5rem;
        }

        .add-subcategory-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 4px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .wallet-selector-container {
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 12px;
            border-radius: 10px;
            border: 1.5px solid var(--gray-light);
            box-shadow: var(--shadow);
            gap: 8px;
        }

        .wallet-selector-container select {
            border: none;
            background: transparent;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .wallet-selector-container select:focus {
            outline: none;
            box-shadow: none;
        }

        .insufficient-balance-modal .modal-header {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        }

        .balance-warning {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1.2rem;
            padding: 1rem;
            border-radius: 10px;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.15);
        }

        .balance-warning i {
            font-size: 1.4rem;
            color: var(--danger);
        }

        .balance-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 1.2rem;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-light);
            font-size: 0.9rem;
        }

        .balance-item:last-child {
            border-bottom: none;
        }

        .month-filter {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.2rem;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        .month-filter label {
            margin-bottom: 0;
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
        }

        .month-filter select {
            flex: 1;
            min-width: 120px;
        }

        .expense-summary {
            background: white;
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1.2rem;
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid rgba(147, 51, 234, 0.05);
        }

        .expense-summary h3 {
            margin-bottom: 0.8rem;
            color: var(--text);
            font-size: 1rem;
        }

        .expense-summary-amount {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .no-expenses-message {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--gray);
            font-style: italic;
            font-size: 0.95rem;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            header {
                padding: 0.6rem 0.8rem;
            }

            .logo {
                font-size: 1.1rem;
                gap: 6px;
            }

            .logo i {
                font-size: 1.3rem;
            }

            .dashboard-title {
                font-size: 1.4rem;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .dashboard-tabs {
                flex-direction: row;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .dashboard-stats {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 0.8rem;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
            }

            .dashboard-stats::-webkit-scrollbar {
                display: none;
            }

            .stat-card {
                flex: 0 0 auto;
                width: 75%;
                min-width: 150px;
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.4rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            .expense-item, .wallet-item, .income-item, .category-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .expense-item > div:last-child, 
            .income-item > div:last-child, 
            .wallet-item > div:last-child,
            .category-item > div:last-child {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .edit-btn, .delete-btn {
                padding: 8px;
            }

            .nav-links {
                gap: 0.5rem;
            }

            .nav-link span {
                display: none;
            }

            .nav-link {
                padding: 6px;
                font-size: 0.8rem;
            }

            .month-filter {
                flex-direction: column;
                align-items: stretch;
                gap: 0.8rem;
            }

            .month-filter select {
                min-width: auto;
            }

            input, select {
                font-size: 16px;
            }

            .modal {
                max-width: 95%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 0.8rem;
            }

            header {
                padding: 0.5rem 0.6rem;
            }

            .auth-section .btn span {
                display: none;
            }

            .auth-section .btn {
                padding: 8px 10px;
                gap: 0;
            }

            .auth-section {
                gap: 6px;
            }

            .logo {
                font-size: 1rem;
            }

            .logo i {
                font-size: 1.2rem;
            }

            .dashboard-title {
                font-size: 1.2rem;
            }

            .form-card,
            .expense-list, .wallet-list, .category-list, .income-list {
                padding: 1.2rem;
            }

            .modal-body, .modal-header {
                padding: 1.2rem;
            }

            .modal-title {
                font-size: 1.4rem;
            }

            .section-title {
                font-size: 1.8rem;
            }

            .hero h1 {
                font-size: 2rem;
            }

            .hero p {
                font-size: 1rem;
            }

            .tab {
                padding: 0.6rem 0.8rem;
                font-size: 0.75rem;
            }

            .stat-card {
                width: 100%;
                min-width: 100px;
                padding: 0.8rem;
            }

            .stat-value {
                font-size: 1.2rem;
            }

            .form-title {
                font-size: 1.1rem;
            }

            label {
                font-size: 0.85rem;
            }

            input, select {
                padding: 9px 10px;
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-chart-pie"></i>
            <span>FinTrack</span>
        </div>
        
        <div class="nav-links">
            <a href="index.html" class="nav-link active">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="analytics.html" class="nav-link">
                <i class="fas fa-chart-bar"></i>
                <span>Analytics</span>
            </a>
        </div>
        
        <div class="auth-section">
            <button id="loginBtn" class="btn btn-outline">
                <i class="fas fa-sign-in-alt"></i>
                <span>Sign In</span>
            </button>
            <button id="signupBtn" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>
                <span>Join</span>
            </button>
            <button id="logoutBtn" class="btn btn-outline hidden">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sign Out</span>
            </button>
        </div>
    </header>

    <div id="landingPage" class="landing-page">
        <section class="hero">
            <div class="hero-content">
                <h1>Track Expenses.<br>Master Your Finances.</h1>
                <p>FinTrack helps you understand where your money goes with beautiful visuals and powerful insights.</p>
                <div class="hero-buttons">
                    <button id="heroSignupBtn" class="btn btn-primary">
                        <i class="fas fa-rocket"></i>
                        Start Free Trial
                    </button>
                    <button class="btn btn-outline">
                        <i class="fas fa-play-circle"></i>
                        Watch Demo
                    </button>
                </div>
                <div class="hero-image">
                    <div style="background: var(--gradient); height: 320px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem;">
                        FinTrack Dashboard Preview
                    </div>
                </div>
            </div>
        </section>

        <section class="features">
            <div class="section-header">
                <h2 class="section-title">Everything You Need</h2>
                <p class="section-subtitle">Manage your finances with ease</p>
            </div>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <h3 class="feature-title">Multiple Wallets</h3>
                    <p class="feature-description">Track expenses across multiple wallets and bank accounts.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-tags"></i>
                    </div>
                    <h3 class="feature-title">Smart Categories</h3>
                    <p class="feature-description">Organize expenses with custom categories.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3 class="feature-title">Visual Reports</h3>
                    <p class="feature-description">Understand spending patterns instantly.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3 class="feature-title">Income Tracking</h3>
                    <p class="feature-description">Track all your income sources.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3 class="feature-title">Secure & Private</h3>
                    <p class="feature-description">Enterprise-grade security for your data.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-sync"></i>
                    </div>
                    <h3 class="feature-title">Real-time Sync</h3>
                    <p class="feature-description">Stay updated across all devices.</p>
                </div>
            </div>
        </section>

        <section class="cta">
            <h2>Ready to take control?</h2>
            <p>Join thousands of users who've transformed their finances with FinTrack.</p>
            <div class="cta-buttons">
                <button id="ctaSignupBtn" class="btn btn-white">
                    <i class="fas fa-rocket"></i>
                    Get Started Free
                </button>
            </div>
        </section>

        <footer>
            <div class="footer-content">
                <div class="footer-column">
                    <h3>FinTrack</h3>
                    <ul class="footer-links">
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Blog</a></li>
                        <li><a href="#">Press</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Product</h3>
                    <ul class="footer-links">
                        <li><a href="#">Features</a></li>
                        <li><a href="#">Security</a></li>
                        <li><a href="#">Roadmap</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Resources</h3>
                    <ul class="footer-links">
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Community</a></li>
                        <li><a href="#">Guides</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Legal</h3>
                    <ul class="footer-links">
                        <li><a href="#">Privacy</a></li>
                        <li><a href="#">Terms</a></li>
                        <li><a href="#">GDPR</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 FinTrack. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <div id="dashboardContainer" class="dashboard-container">
        <div class="container">
            <div style="margin-bottom: 1rem;">
                <a href="analytics.html" class="btn btn-outline">
                    <i class="fas fa-chart-bar"></i>
                    Analytics
                </a>
            </div>
            
            <div class="dashboard-header">
                <h1 class="dashboard-title">Dashboard</h1>
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div class="wallet-selector-container">
                        <label for="globalWalletSelect" style="font-size: 0.8rem; color: var(--gray); margin-bottom: 0;">Wallet:</label>
                        <select id="globalWalletSelect">
                            <option value="">Select wallet</option>
                        </select>
                    </div>
                    <span id="userEmail" style="color: var(--gray); font-size: 0.85rem;"></span>
                </div>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-label">Income</div>
                    <div class="stat-value income" id="totalIncome">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Expenses</div>
                    <div class="stat-value expense" id="totalExpenses">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Balance</div>
                    <div class="stat-value balance" id="currentWalletBalance">Rp 0</div>
                </div>
            </div>

            <div class="dashboard-tabs">
                <div class="tab active" data-tab="expenses">This Month</div>
                <div class="tab" data-tab="historical">History</div>
                <div class="tab" data-tab="income">Income</div>
                <div class="tab" data-tab="wallets">Wallets</div>
                <div class="tab" data-tab="categories">Categories</div>
            </div>

            <div id="expensesTab" class="tab-content active">
                <div class="form-card">
                    <h2 class="form-title">Add Expense</h2>
                    <form id="expenseForm">
                        <input type="hidden" id="expenseId">
                        <div class="form-group">
                            <label for="expenseDescription">What did you spend on?</label>
                            <input type="text" id="expenseDescription" placeholder="e.g., Lunch, Gas" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expenseAmount">Amount</label>
                                <div class="currency-input">
                                    <span class="currency-symbol">Rp</span>
                                    <input type="text" id="expenseAmount" placeholder="0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="expenseDate">Date</label>
                                <input type="date" id="expenseDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expenseCategory">Category</label>
                                <select id="expenseCategory" required>
                                    <option value="">Select category</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="expenseSubcategory">Subcategory</label>
                                <select id="expenseSubcategory">
                                    <option value="">Optional</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary" id="expenseSubmitBtn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="expenseCancelBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="expense-list">
                    <h2 class="form-title">This Month</h2>
                    <div id="expensesList">
                        <div class="expense-item">
                            <div class="expense-details">No expenses yet</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="historicalTab" class="tab-content">
                <div class="month-filter">
                    <label for="monthSelect">Month:</label>
                    <select id="monthSelect"></select>
                    <label for="yearSelect">Year:</label>
                    <select id="yearSelect"></select>
                </div>
                
                <div class="expense-summary">
                    <h3>Total for <span id="selectedMonthYear">this month</span></h3>
                    <div class="expense-summary-amount" id="monthlyExpenseTotal">Rp 0</div>
                </div>
                
                <div class="expense-list">
                    <h2 class="form-title">Expenses</h2>
                    <div id="historicalExpensesList">
                        <div class="expense-item">
                            <div class="expense-details">Select a month</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="incomeTab" class="tab-content">
                <div class="form-card">
                    <h2 class="form-title">Add Income</h2>
                    <form id="incomeForm">
                        <input type="hidden" id="incomeId">
                        <div class="form-group">
                            <label for="incomeDescription">Source</label>
                            <input type="text" id="incomeDescription" placeholder="e.g., Salary, Freelance" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="incomeAmount">Amount</label>
                                <div class="currency-input">
                                    <span class="currency-symbol">Rp</span>
                                    <input type="text" id="incomeAmount" placeholder="0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="incomeDate">Date</label>
                                <input type="date" id="incomeDate" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="incomeSource">Type</label>
                            <select id="incomeSource" required>
                                <option value="">Select type</option>
                                <option value="Salary">Salary</option>
                                <option value="Freelance">Freelance</option>
                                <option value="Investment">Investment</option>
                                <option value="Gift">Gift</option>
                                <option value="Bonus">Bonus</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-success" id="incomeSubmitBtn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="incomeCancelBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="income-list">
                    <h2 class="form-title">Income</h2>
                    <div id="incomesList">
                        <div class="income-item">
                            <div class="income-details">No income yet</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="walletsTab" class="tab-content">
                <div class="form-card">
                    <h2 class="form-title">Add Wallet</h2>
                    <form id="walletForm">
                        <input type="hidden" id="walletId">
                        <div class="form-group">
                            <label for="walletName">Wallet Name</label>
                            <input type="text" id="walletName" placeholder="e.g., Cash, Bank Account" required>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary" id="walletSubmitBtn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="walletCancelBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="wallet-list">
                    <h2 class="form-title">My Wallets</h2>
                    <div id="walletsList">
                        <div class="wallet-item">
                            <div class="wallet-details">No wallets yet</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="categoriesTab" class="tab-content">
                <div class="form-card">
                    <div class="form-title">Add Category</div>
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">
                        <div class="form-group">
                            <label for="categoryType">Type</label>
                            <select id="categoryType" required>
                                <option value="">Select type</option>
                                <option value="main">Main Category</option>
                                <option value="sub">Subcategory</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="categoryName">Name</label>
                            <input type="text" id="categoryName" placeholder="e.g., Food, Transport" required>
                        </div>
                        <div class="form-group hidden" id="parentCategoryGroup">
                            <label for="parentCategory">Parent Category</label>
                            <select id="parentCategory">
                                <option value="">Select parent</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary" id="categorySubmitBtn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="categoryCancelBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="category-list">
                    <h2 class="form-title">Categories</h2>
                    <div id="categoriesList">
                        <div class="category-item">
                            <div class="category-details">No categories yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="subcategoryModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeSubcategoryModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Add Subcategory</h2>
                <p class="modal-subtitle">Quick add</p>
            </div>
            <div class="modal-body">
                <form id="subcategoryForm">
                    <div class="form-group">
                        <label for="subcategoryName">Name</label>
                        <input type="text" id="subcategoryName" placeholder="e.g., Groceries" required>
                    </div>
                    <input type="hidden" id="parentCategoryId">
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);">
                <button class="modal-close" id="closeDeleteModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Delete?</h2>
                <p class="modal-subtitle">This can't be undone</p>
            </div>
            <div class="modal-body">
                <p id="deleteMessage" style="margin-bottom: 1.5rem; font-size: 0.95rem;"></p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" id="cancelDeleteBtn" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn" id="confirmDeleteBtn" style="flex: 1; background: #EF4444; color: white;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay insufficient-balance-modal" id="insufficientBalanceModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeInsufficientBalanceModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Not Enough Balance</h2>
                <p class="modal-subtitle">Need more funds</p>
            </div>
            <div class="modal-body">
                <div class="balance-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <h3 style="font-size: 0.95rem; margin-bottom: 0.3rem;">Insufficient funds</h3>
                        <p style="font-size: 0.85rem; opacity: 0.9;">Add income to proceed</p>
                    </div>
                </div>
                <div class="balance-details">
                    <div class="balance-item">
                        <span>Expense:</span>
                        <strong id="expenseAmountDetail">Rp 0</strong>
                    </div>
                    <div class="balance-item">
                        <span>Balance:</span>
                        <strong id="walletBalanceDetail">Rp 0</strong>
                    </div>
                    <div class="balance-item">
                        <span>After:</span>
                        <strong id="remainingBalanceDetail" style="color: var(--danger);">Rp 0</strong>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" id="addFundsBtn" style="flex: 1;">
                        <i class="fas fa-plus"></i> Add Income
                    </button>
                    <button class="btn btn-outline" id="cancelExpenseBtn" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="signupModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeSignupModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Join FinTrack</h2>
                <p class="modal-subtitle">Start tracking today</p>
            </div>
            <div class="modal-body">
                <form id="signupForm">
                    <div class="form-group">
                        <label for="signupEmail">Email</label>
                        <input type="email" id="signupEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create password" required>
                        <div class="password-strength">
                            <div class="strength-bar" id="passwordStrength"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </form>
                <div style="text-align: center; margin-top: 1.2rem;">
                    <p style="font-size: 0.9rem;">Already have an account? <a href="#" id="showLoginFromSignup" style="color: var(--primary); text-decoration: none; font-weight: 600;">Sign in</a></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeLoginModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Welcome Back</h2>
                <p class="modal-subtitle">Sign in to continue</p>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </form>
                <div style="text-align: center; margin-top: 1.2rem;">
                    <p style="font-size: 0.9rem;">Don't have an account? <a href="#" id="showSignupFromLogin" style="color: var(--primary); text-decoration: none; font-weight: 600;">Join now</a></p>
                </div>
            </div>
        </div>
    </div>

    <div id="alertContainer" style="position: fixed; top: 80px; right: 12px; z-index: 3000; max-width: 350px;"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://slgzgaojmgzjhtuaptod.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZ3pnYW9qbWd6amh0dWFwdG9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNzQyMzMsImV4cCI6MjA3ODg1MDIzM30.aD9cjbekiufRaatuNaAEP2uD2uU7ggpPor6jtSGM-F4';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM Elements
        const signupModal = document.getElementById('signupModal');
        const loginModal = document.getElementById('loginModal');
        const subcategoryModal = document.getElementById('subcategoryModal');
        const insufficientBalanceModal = document.getElementById('insufficientBalanceModal');
        const deleteModal = document.getElementById('deleteModal');
        const signupBtn = document.getElementById('signupBtn');
        const loginBtn = document.getElementById('loginBtn');
        const heroSignupBtn = document.getElementById('heroSignupBtn');
        const ctaSignupBtn = document.getElementById('ctaSignupBtn');
        const closeSignupModal = document.getElementById('closeSignupModal');
        const closeLoginModal = document.getElementById('closeLoginModal');
        const closeSubcategoryModal = document.getElementById('closeSubcategoryModal');
        const closeInsufficientBalanceModal = document.getElementById('closeInsufficientBalanceModal');
        const closeDeleteModal = document.getElementById('closeDeleteModal');
        const showSignupFromLogin = document.getElementById('showSignupFromLogin');
        const showLoginFromSignup = document.getElementById('showLoginFromSignup');
        const signupForm = document.getElementById('signupForm');
        const loginForm = document.getElementById('loginForm');
        const subcategoryForm = document.getElementById('subcategoryForm');
        const incomeForm = document.getElementById('incomeForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const landingPage = document.getElementById('landingPage');
        const passwordStrength = document.getElementById('passwordStrength');
        const signupPassword = document.getElementById('signupPassword');
        const alertContainer = document.getElementById('alertContainer');
        const userEmail = document.getElementById('userEmail');
        
        // Dashboard elements
        const expenseForm = document.getElementById('expenseForm');
        const walletForm = document.getElementById('walletForm');
        const categoryForm = document.getElementById('categoryForm');
        const globalWalletSelect = document.getElementById('globalWalletSelect');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const categoryType = document.getElementById('categoryType');
        const parentCategoryGroup = document.getElementById('parentCategoryGroup');
        const parentCategory = document.getElementById('parentCategory');
        const expenseCategory = document.getElementById('expenseCategory');
        const expenseSubcategory = document.getElementById('expenseSubcategory');
        
        // Form buttons
        const expenseSubmitBtn = document.getElementById('expenseSubmitBtn');
        const expenseCancelBtn = document.getElementById('expenseCancelBtn');
        const incomeSubmitBtn = document.getElementById('incomeSubmitBtn');
        const incomeCancelBtn = document.getElementById('incomeCancelBtn');
        const walletSubmitBtn = document.getElementById('walletSubmitBtn');
        const walletCancelBtn = document.getElementById('walletCancelBtn');
        const categorySubmitBtn = document.getElementById('categorySubmitBtn');
        const categoryCancelBtn = document.getElementById('categoryCancelBtn');
        
        // Delete modal elements
        const deleteMessage = document.getElementById('deleteMessage');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        
        // Insufficient balance modal elements
        const expenseAmountDetail = document.getElementById('expenseAmountDetail');
        const walletBalanceDetail = document.getElementById('walletBalanceDetail');
        const remainingBalanceDetail = document.getElementById('remainingBalanceDetail');
        const addFundsBtn = document.getElementById('addFundsBtn');
        const cancelExpenseBtn = document.getElementById('cancelExpenseBtn');

        // Historical expenses elements
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const historicalExpensesList = document.getElementById('historicalExpensesList');
        const monthlyExpenseTotal = document.getElementById('monthlyExpenseTotal');
        const selectedMonthYear = document.getElementById('selectedMonthYear');

        // Data storage
        let expenses = [];
        let incomes = [];
        let wallets = [];
        let categories = [];
        let currentWalletId = null;
        let pendingExpense = null;
        let itemToDelete = null;
        let deleteType = null;
        let isProgrammaticChange = false;

        // Currency formatting functions
        function formatCurrency(value) {
            const numericValue = value.replace(/\D/g, '');
            return numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function parseCurrency(formattedValue) {
            return parseInt(formattedValue.replace(/\./g, '')) || 0;
        }

        function formatDisplayCurrency(amount) {
            return `Rp ${amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }

        function isValidUUID(str) {
            if (!str) return false;
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            return uuidRegex.test(str);
        }

        function calculateWalletBalance(walletId) {
            const walletExpenses = expenses.filter(expense => expense.walletId === walletId);
            const totalExpenses = walletExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            const walletIncome = incomes.filter(income => income.walletId === walletId);
            const totalIncome = walletIncome.reduce((sum, income) => sum + income.amount, 0);
            
            return totalIncome - totalExpenses;
        }

        function confirmDelete(type, id, name) {
            itemToDelete = id;
            deleteType = type;
            deleteMessage.textContent = `Delete "${name}"? This can't be undone.`;
            deleteModal.classList.add('active');
        }

        async function refreshAllCategoryUI() {
            await loadCategories();
            updateCategoryDropdowns();
        }

        function initApp() {
            logoutBtn.classList.add('hidden');
            loginBtn.classList.remove('hidden');
            signupBtn.classList.remove('hidden');
            
            document.getElementById('expenseDate').valueAsDate = new Date();
            document.getElementById('incomeDate').valueAsDate = new Date();
            
            setupTabs();
            setupCurrencyInputs();
            setupCategoryTypeToggle();
            
            checkAuthState();
        }

        // Event Listeners
        signupBtn.addEventListener('click', () => signupModal.classList.add('active'));
        loginBtn.addEventListener('click', () => loginModal.classList.add('active'));
        heroSignupBtn.addEventListener('click', () => signupModal.classList.add('active'));
        ctaSignupBtn.addEventListener('click', () => signupModal.classList.add('active'));
        closeSignupModal.addEventListener('click', () => signupModal.classList.remove('active'));
        closeLoginModal.addEventListener('click', () => loginModal.classList.remove('active'));
        closeSubcategoryModal.addEventListener('click', () => subcategoryModal.classList.remove('active'));
        closeInsufficientBalanceModal.addEventListener('click', () => insufficientBalanceModal.classList.remove('active'));
        closeDeleteModal.addEventListener('click', () => deleteModal.classList.remove('active'));
        cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.remove('active'));

        showSignupFromLogin.addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.classList.remove('active');
            signupModal.classList.add('active');
        });

        showLoginFromSignup.addEventListener('click', (e) => {
            e.preventDefault();
            signupModal.classList.remove('active');
            loginModal.classList.add('active');
        });

        window.addEventListener('click', (e) => {
            if (e.target === signupModal) signupModal.classList.remove('active');
            if (e.target === loginModal) loginModal.classList.remove('active');
            if (e.target === subcategoryModal) subcategoryModal.classList.remove('active');
            if (e.target === insufficientBalanceModal) insufficientBalanceModal.classList.remove('active');
            if (e.target === deleteModal) deleteModal.classList.remove('active');
        });

        addFundsBtn.addEventListener('click', () => {
            insufficientBalanceModal.classList.remove('active');
            document.querySelector('[data-tab="income"]').click();
            showAlert('Add income to your wallet', 'warning');
        });

        cancelExpenseBtn.addEventListener('click', () => {
            insufficientBalanceModal.classList.remove('active');
            pendingExpense = null;
        });

        signupPassword.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            passwordStrength.className = 'strength-bar';
            
            if (password.length > 0) {
                if (strength <= 2) passwordStrength.classList.add('strength-weak');
                else if (strength === 3) passwordStrength.classList.add('strength-medium');
                else passwordStrength.classList.add('strength-strong');
            }
        });

        // Form submissions
        signupForm.addEventListener('submit', handleSignup);
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        expenseForm.addEventListener('submit', handleAddExpense);
        incomeForm.addEventListener('submit', handleAddIncome);
        walletForm.addEventListener('submit', handleAddWallet);
        categoryForm.addEventListener('submit', handleAddCategory);
        subcategoryForm.addEventListener('submit', handleAddSubcategory);

        expenseCancelBtn.addEventListener('click', resetExpenseForm);
        incomeCancelBtn.addEventListener('click', resetIncomeForm);
        walletCancelBtn.addEventListener('click', resetWalletForm);
        categoryCancelBtn.addEventListener('click', resetCategoryForm);

        if (globalWalletSelect) {
            globalWalletSelect.addEventListener('change', async function() {
                currentWalletId = this.value;
                
                if (currentWalletId) {
                    await loadExpenses();
                    await loadIncomes();
                    updateStats();
                } else {
                    document.getElementById('expensesList').innerHTML = `
                        <div class="expense-item">
                            <div class="expense-details">Select a wallet</div>
                        </div>
                    `;
                    document.getElementById('incomesList').innerHTML = `
                        <div class="income-item">
                            <div class="income-details">Select a wallet</div>
                        </div>
                    `;
                    updateStats();
                }
            });
        }

        monthSelect.addEventListener('change', function() {
            if (!isProgrammaticChange) {
                updateHistoricalExpensesView();
            }
        });

        yearSelect.addEventListener('change', function() {
            if (!isProgrammaticChange) {
                updateHistoricalExpensesView();
            }
        });

        function setupTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}Tab`) {
                            content.classList.add('active');
                            
                            if (tabId === 'expenses') {
                                updateCurrentMonthExpenses();
                            } else if (tabId === 'historical') {
                                updateHistoricalExpensesView();
                            }
                        }
                    });
                });
            });
        }

        function setupCurrencyInputs() {
            const expenseAmount = document.getElementById('expenseAmount');
            const incomeAmount = document.getElementById('incomeAmount');
            
            expenseAmount.addEventListener('input', function() {
                this.value = formatCurrency(this.value);
            });
            
            incomeAmount.addEventListener('input', function() {
                this.value = formatCurrency(this.value);
            });
        }

        function setupCategoryTypeToggle() {
            categoryType.addEventListener('change', function() {
                if (this.value === 'sub') {
                    parentCategoryGroup.classList.remove('hidden');
                    loadParentCategories();
                } else {
                    parentCategoryGroup.classList.add('hidden');
                }
            });
        }

        function openSubcategoryModal(parentId) {
            document.getElementById('parentCategoryId').value = parentId;
            subcategoryModal.classList.add('active');
        }

        // Authentication Functions
        async function handleSignup(e) {
            e.preventDefault();
            
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!email || !password) {
                showAlert('Please enter email and password', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showAlert('Passwords don\'t match', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signUp({ 
                    email, 
                    password,
                    options: {
                        emailRedirectTo: window.location.origin
                    }
                });
                
                if (error) {
                    showAlert(error.message, 'error');
                } else {
                    if (data.user && data.session) {
                        showAlert('Account created!', 'success');
                        signupModal.classList.remove('active');
                        signupForm.reset();
                        passwordStrength.className = 'strength-bar';
                        showDashboard(email);
                    } else {
                        showAlert('Check your email to verify', 'success');
                        signupModal.classList.remove('active');
                        signupForm.reset();
                    }
                }
            } catch (error) {
                showAlert('Signup error', 'error');
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAlert('Please enter email and password', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                
                if (error) {
                    showAlert(error.message, 'error');
                } else {
                    showAlert('Welcome back!', 'success');
                    loginModal.classList.remove('active');
                    showDashboard(email);
                }
            } catch (error) {
                showAlert('Login error', 'error');
            }
        }
        
        async function handleLogout() {
            try {
                await supabase.auth.signOut();
                showAlert('Logged out', 'success');
                hideDashboard();
            } catch (error) {
                hideDashboard();
            }
        }

        async function checkAuthState() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user && user.email_confirmed_at) {
                    showDashboard(user.email);
                } else if (user) {
                    showAlert('Verify your email first', 'warning');
                    await supabase.auth.signOut();
                } else {
                    hideDashboard();
                }
            } catch (error) {
                hideDashboard();
            }
        }

        async function showDashboard(email) {
            landingPage.style.display = 'none';
            dashboardContainer.style.display = 'block';
            loginBtn.classList.add('hidden');
            signupBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            
            if (email) userEmail.textContent = email;
            
            await loadWallets();
            await loadCategories();
            await loadExpenses();
            await loadIncomes();
            updateStats();
            
            if (wallets.length > 0 && !currentWalletId) {
                currentWalletId = wallets[0].id;
                updateGlobalWalletSelector();
                updateStats();
            }
            
            updateCategoryDropdowns();
        }

        function hideDashboard() {
            landingPage.style.display = 'block';
            dashboardContainer.style.display = 'none';
            loginBtn.classList.remove('hidden');
            signupBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
        }

        async function loadExpenses() {
            expenses = await loadExpensesFromSupabase();
            updateCurrentMonthExpenses();
            updateHistoricalExpensesView();
            updateMonthYearFilters();
        }

        function updateCurrentMonthExpenses() {
            const expensesList = document.getElementById('expensesList');
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let displayExpenses = expenses;
            if (currentWalletId) {
                displayExpenses = expenses.filter(expense => expense.walletId === currentWalletId);
            }
            
            displayExpenses = displayExpenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
            
            if (displayExpenses.length === 0) {
                expensesList.innerHTML = `<div class="expense-item"><div class="expense-details">No expenses yet</div></div>`;
                return;
            }
            
            renderExpenseList(displayExpenses, expensesList);
        }

        function updateHistoricalExpensesView() {
            const selectedMonth = monthSelect.value;
            const selectedYear = yearSelect.value;
            
            if (!selectedMonth || !selectedYear) {
                const now = new Date();
                monthSelect.value = now.getMonth().toString();
                yearSelect.value = now.getFullYear().toString();
                historicalExpensesList.innerHTML = `<div class="no-expenses-message">Select a month</div>`;
                monthlyExpenseTotal.textContent = formatDisplayCurrency(0);
                return;
            }
            
            let displayExpenses = expenses;
            if (currentWalletId) {
                displayExpenses = expenses.filter(expense => expense.walletId === currentWalletId);
            }
            
            displayExpenses = displayExpenses.filter(expense => {
                const expenseDate = new Date(expense.date);
                return expenseDate.getMonth() === parseInt(selectedMonth) && 
                    expenseDate.getFullYear() === parseInt(selectedYear);
            });
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            selectedMonthYear.textContent = `${monthNames[selectedMonth]} ${selectedYear}`;
            
            const monthlyTotal = displayExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            monthlyExpenseTotal.textContent = formatDisplayCurrency(monthlyTotal);
            
            if (displayExpenses.length === 0) {
                historicalExpensesList.innerHTML = `<div class="no-expenses-message">No expenses</div>`;
                return;
            }
            
            renderExpenseList(displayExpenses, historicalExpensesList);
        }

        function renderExpenseList(expensesArray, containerElement) {
            containerElement.innerHTML = '';
            const sortedExpenses = [...expensesArray].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExpenses.forEach(expense => {
                const expenseDate = new Date(expense.date).toLocaleDateString();
                const wallet = wallets.find(w => w.id === expense.walletId);
                
                let categoryText = expense.category;
                if (expense.subcategory) {
                    categoryText += ` > ${expense.subcategory}`;
                }
                
                const expenseItem = document.createElement('div');
                expenseItem.className = 'expense-item';
                expenseItem.innerHTML = `
                    <div class="expense-details">
                        <div style="font-weight: 500;">${expense.description}</div>
                        <div style="font-size: 0.8rem; color: var(--gray);">
                            ${expenseDate}  ${wallet ? wallet.name : 'Unknown'}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div>
                            <div class="expense-amount">${formatDisplayCurrency(expense.amount)}</div>
                            <span class="expense-category">${categoryText}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="editExpense('${expense.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" onclick="confirmDelete('expense', '${expense.id}', '${expense.description}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                containerElement.appendChild(expenseItem);
            });
        }

        function updateMonthYearFilters() {
            isProgrammaticChange = true;
            
            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';
            
            const years = [...new Set(expenses.map(expense => new Date(expense.date).getFullYear()))];
            years.sort((a, b) => b - a);
            
            if (years.length === 0) {
                years.push(new Date().getFullYear());
            }
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            monthNames.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            
            const now = new Date();
            monthSelect.value = now.getMonth().toString();
            yearSelect.value = now.getFullYear().toString();
            
            isProgrammaticChange = false;
        }

        // Supabase Data Functions (simplified versions)
        async function saveExpense(expense) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('Not authenticated');
                
                if (expense.id) {
                    const { data, error } = await supabase
                        .from('expenses')
                        .update({
                            description: expense.description,
                            amount: expense.amount,
                            date: expense.date,
                            category: expense.category,
                            subcategory: expense.subcategory,
                            wallet_id: expense.walletId
                        })
                        .eq('id', expense.id)
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                } else {
                    const { data, error } = await supabase
                        .from('expenses')
                        .insert([{
                            description: expense.description,
                            amount: expense.amount,
                            date: expense.date,
                            category: expense.category,
                            subcategory: expense.subcategory,
                            wallet_id: expense.walletId,
                            user_id: user.id
                        }])
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Error saving expense:', error);
                return expense;
            }
        }

        async function saveIncome(income) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('Not authenticated');
                
                if (income.id) {
                    const { data, error } = await supabase
                        .from('incomes')
                        .update({
                            description: income.description,
                            amount: income.amount,
                            date: income.date,
                            source: income.source,
                            wallet_id: income.walletId
                        })
                        .eq('id', income.id)
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                } else {
                    const { data, error } = await supabase
                        .from('incomes')
                        .insert([{
                            description: income.description,
                            amount: income.amount,
                            date: income.date,
                            source: income.source,
                            wallet_id: income.walletId,
                            user_id: user.id
                        }])
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Error saving income:', error);
                return income;
            }
        }

        async function saveWallet(wallet) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('Not authenticated');
                
                if (wallet.id) {
                    const { data, error } = await supabase
                        .from('wallets')
                        .update({ name: wallet.name })
                        .eq('id', wallet.id)
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                } else {
                    const { data, error } = await supabase
                        .from('wallets')
                        .insert([{ name: wallet.name, user_id: user.id }])
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Error saving wallet:', error);
                return wallet;
            }
        }

        async function saveCategory(category) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('Not authenticated');
                
                const categoryData = {
                    name: category.name,
                    type: category.type,
                    user_id: user.id
                };
                
                if (category.parentId && isValidUUID(category.parentId)) {
                    categoryData.parent_id = category.parentId;
                }
                
                if (category.id) {
                    const { data, error } = await supabase
                        .from('categories')
                        .update(categoryData)
                        .eq('id', category.id)
                        .select();
                    
                    if (error) throw error;
                    return { id: data[0].id, name: data[0].name, type: data[0].type, parentId: data[0].parent_id };
                } else {
                    const { data, error } = await supabase
                        .from('categories')
                        .insert([categoryData])
                        .select();
                    
                    if (error) throw error;
                    return { id: data[0].id, name: data[0].name, type: data[0].type, parentId: data[0].parent_id };
                }
            } catch (error) {
                console.error('Error saving category:', error);
                return category;
            }
        }

        // Delete functions
        async function deleteExpense(id) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const { error } = await supabase.from('expenses').delete().eq('id', id).eq('user_id', user.id);
                if (error) throw error;
                return true;
            } catch (error) {
                return true;
            }
        }

        async function deleteIncome(id) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const { error } = await supabase.from('incomes').delete().eq('id', id).eq('user_id', user.id);
                if (error) throw error;
                return true;
            } catch (error) {
                return true;
            }
        }

        async function deleteWallet(id) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const { error } = await supabase.from('wallets').delete().eq('id', id).eq('user_id', user.id);
                if (error) throw error;
                return true;
            } catch (error) {
                return true;
            }
        }

        async function deleteCategory(id) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                const { error } = await supabase.from('categories').delete().eq('id', id).eq('user_id', user.id);
                if (error) throw error;
                return true;
            } catch (error) {
                return true;
            }
        }

        // Load functions
        async function loadExpensesFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('date', { ascending: false });
                
                if (error) throw error;
                return data.map(expense => ({
                    id: expense.id,
                    description: expense.description,
                    amount: expense.amount,
                    date: expense.date,
                    category: expense.category,
                    subcategory: expense.subcategory,
                    walletId: expense.wallet_id
                }));
            } catch (error) {
                return [];
            }
        }

        async function loadIncomesFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                
                const { data, error } = await supabase
                    .from('incomes')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('date', { ascending: false });
                
                if (error) throw error;
                return data.map(income => ({
                    id: income.id,
                    description: income.description,
                    amount: income.amount,
                    date: income.date,
                    source: income.source,
                    walletId: income.wallet_id
                }));
            } catch (error) {
                return [];
            }
        }

        async function loadWalletsFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                
                const { data, error } = await supabase
                    .from('wallets')
                    .select('*')
                    .eq('user_id', user.id);
                
                if (error) throw error;
                return data.map(wallet => ({ id: wallet.id, name: wallet.name }));
            } catch (error) {
                return [];
            }
        }

        async function loadCategoriesFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                return data.map(category => ({
                    id: category.id,
                    name: category.name,
                    type: category.type || 'main',
                    parentId: category.parent_id
                }));
            } catch (error) {
                return [];
            }
        }

        async function handleAddExpense(e) {
            e.preventDefault();
            
            const id = document.getElementById('expenseId').value;
            const description = document.getElementById('expenseDescription').value;
            const amount = parseCurrency(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const subcategory = document.getElementById('expenseSubcategory').value;
            const walletId = currentWalletId;
            
            if (!walletId) {
                showAlert('Select a wallet first', 'error');
                return;
            }
            
            if (amount <= 0) {
                showAlert('Enter a valid amount', 'error');
                return;
            }
            
            if (!id) {
                const walletBalance = calculateWalletBalance(walletId);
                if (walletBalance < amount) {
                    pendingExpense = { description, amount, date, category, subcategory, walletId };
                    expenseAmountDetail.textContent = formatDisplayCurrency(amount);
                    walletBalanceDetail.textContent = formatDisplayCurrency(walletBalance);
                    remainingBalanceDetail.textContent = formatDisplayCurrency(walletBalance - amount);
                    insufficientBalanceModal.classList.add('active');
                    return;
                }
            }
            
            const expense = { id, description, amount, date, category, subcategory, walletId };
            const savedExpense = await saveExpense(expense);
            
            if (id) {
                const index = expenses.findIndex(e => e.id === id);
                if (index !== -1) expenses[index] = savedExpense;
                showAlert('Expense updated', 'success');
            } else {
                expenses.push(savedExpense);
                showAlert('Expense added', 'success');
            }
            
            resetExpenseForm();
            await loadExpenses();
            updateStats();
        }

        async function handleAddIncome(e) {
            e.preventDefault();
            
            const id = document.getElementById('incomeId').value;
            const description = document.getElementById('incomeDescription').value;
            const amount = parseCurrency(document.getElementById('incomeAmount').value);
            const date = document.getElementById('incomeDate').value;
            const source = document.getElementById('incomeSource').value;
            const walletId = currentWalletId;
            
            if (!walletId) {
                showAlert('Select a wallet first', 'error');
                return;
            }
            
            if (amount <= 0) {
                showAlert('Enter a valid amount', 'error');
                return;
            }
            
            const income = { id, description, amount, date, source, walletId };
            const savedIncome = await saveIncome(income);
            
            if (id) {
                const index = incomes.findIndex(i => i.id === id);
                if (index !== -1) incomes[index] = savedIncome;
                showAlert('Income updated', 'success');
            } else {
                incomes.push(savedIncome);
                showAlert('Income added', 'success');
            }
            
            resetIncomeForm();
            await loadIncomes();
            updateStats();
        }

        async function handleAddWallet(e) {
            e.preventDefault();
            
            const id = document.getElementById('walletId').value;
            const name = document.getElementById('walletName').value;
            
            const wallet = { id, name };
            const savedWallet = await saveWallet(wallet);
            
            if (id) {
                const index = wallets.findIndex(w => w.id === id);
                if (index !== -1) wallets[index] = savedWallet;
                showAlert('Wallet updated', 'success');
            } else {
                wallets.push(savedWallet);
                if (wallets.length === 1) {
                    currentWalletId = savedWallet.id;
                    updateGlobalWalletSelector();
                }
                showAlert('Wallet added', 'success');
            }
            
            resetWalletForm();
            await loadWallets();
            updateStats();
        }

        async function handleAddCategory(e) {
            e.preventDefault();
            
            const id = document.getElementById('categoryId').value;
            const type = document.getElementById('categoryType').value;
            const name = document.getElementById('categoryName').value;
            let parentId = null;
            
            if (type === 'sub') {
                parentId = document.getElementById('parentCategory').value;
                if (!parentId) {
                    showAlert('Select a parent category', 'error');
                    return;
                }
            }
            
            const category = { id, name, type, parentId };
            const savedCategory = await saveCategory(category);
            
            if (id) {
                const index = categories.findIndex(c => c.id === id);
                if (index !== -1) categories[index] = savedCategory;
                showAlert('Category updated', 'success');
            } else {
                categories.push(savedCategory);
                showAlert('Category added', 'success');
            }
            
            resetCategoryForm();
            await refreshAllCategoryUI();
        }

        async function handleAddSubcategory(e) {
            e.preventDefault();
            
            const name = document.getElementById('subcategoryName').value;
            const parentId = document.getElementById('parentCategoryId').value;
            
            if (!name || !parentId) {
                showAlert('Enter subcategory name', 'error');
                return;
            }
            
            const newSubcategory = { name, type: 'sub', parentId };
            const savedSubcategory = await saveCategory(newSubcategory);
            
            categories.push(savedSubcategory);
            showAlert('Subcategory added', 'success');
            subcategoryForm.reset();
            subcategoryModal.classList.remove('active');
            
            await refreshAllCategoryUI();
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            
            document.getElementById('expenseId').value = expense.id;
            document.getElementById('expenseDescription').value = expense.description;
            document.getElementById('expenseAmount').value = formatCurrency(expense.amount.toString());
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseCategory').value = expense.category;
            
            setTimeout(() => {
                document.getElementById('expenseSubcategory').value = expense.subcategory || '';
            }, 100);
            
            expenseSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update';
            expenseCancelBtn.classList.remove('hidden');
            document.getElementById('expenseForm').scrollIntoView({ behavior: 'smooth' });
        }

        function editIncome(id) {
            const income = incomes.find(i => i.id === id);
            if (!income) return;
            
            document.getElementById('incomeId').value = income.id;
            document.getElementById('incomeDescription').value = income.description;
            document.getElementById('incomeAmount').value = formatCurrency(income.amount.toString());
            document.getElementById('incomeDate').value = income.date;
            document.getElementById('incomeSource').value = income.source;
            
            incomeSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update';
            incomeCancelBtn.classList.remove('hidden');
            document.getElementById('incomeForm').scrollIntoView({ behavior: 'smooth' });
        }

        function editWallet(id) {
            const wallet = wallets.find(w => w.id === id);
            if (!wallet) return;
            
            document.getElementById('walletId').value = wallet.id;
            document.getElementById('walletName').value = wallet.name;
            
            walletSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update';
            walletCancelBtn.classList.remove('hidden');
            document.getElementById('walletForm').scrollIntoView({ behavior: 'smooth' });
        }

        function editCategory(id) {
            const category = categories.find(c => c.id === id);
            if (!category) return;
            
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryType').value = category.type;
            
            if (category.type === 'sub') {
                parentCategoryGroup.classList.remove('hidden');
                loadParentCategories();
                setTimeout(() => {
                    document.getElementById('parentCategory').value = category.parentId;
                }, 100);
            } else {
                parentCategoryGroup.classList.add('hidden');
            }
            
            categorySubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update';
            categoryCancelBtn.classList.remove('hidden');
            document.getElementById('categoryForm').scrollIntoView({ behavior: 'smooth' });
        }

        function resetExpenseForm() {
            document.getElementById('expenseId').value = '';
            expenseForm.reset();
            document.getElementById('expenseDate').valueAsDate = new Date();
            expenseSubmitBtn.innerHTML = '<i class="fas fa-plus"></i> Add';
            expenseCancelBtn.classList.add('hidden');
        }

        function resetIncomeForm() {
            document.getElementById('incomeId').value = '';
            incomeForm.reset();
            document.getElementById('incomeDate').valueAsDate = new Date();
            incomeSubmitBtn.innerHTML = '<i class="fas fa-plus"></i> Add';
            incomeCancelBtn.classList.add('hidden');
        }

        function resetWalletForm() {
            document.getElementById('walletId').value = '';
            walletForm.reset();
            walletSubmitBtn.innerHTML = '<i class="fas fa-plus"></i> Add';
            walletCancelBtn.classList.add('hidden');
        }

        function resetCategoryForm() {
            document.getElementById('categoryId').value = '';
            categoryForm.reset();
            document.getElementById('categoryType').value = '';
            parentCategoryGroup.classList.add('hidden');
            categorySubmitBtn.innerHTML = '<i class="fas fa-plus"></i> Add';
            categoryCancelBtn.classList.add('hidden');
        }

        async function loadIncomes() {
            incomes = await loadIncomesFromSupabase();
            const incomesList = document.getElementById('incomesList');
            
            let displayIncomes = incomes;
            if (currentWalletId) {
                displayIncomes = incomes.filter(income => income.walletId === currentWalletId);
            }
            
            if (displayIncomes.length === 0) {
                incomesList.innerHTML = `<div class="income-item"><div class="income-details">No income yet</div></div>`;
                return;
            }
            
            incomesList.innerHTML = '';
            const sortedIncomes = [...displayIncomes].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedIncomes.forEach(income => {
                const incomeDate = new Date(income.date).toLocaleDateString();
                const wallet = wallets.find(w => w.id === income.walletId);
                
                const incomeItem = document.createElement('div');
                incomeItem.className = 'income-item';
                incomeItem.innerHTML = `
                    <div class="income-details">
                        <div style="font-weight: 500;">${income.description}</div>
                        <div style="font-size: 0.8rem; color: var(--gray);">
                            ${incomeDate}  ${wallet ? wallet.name : 'Unknown'}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div>
                            <div class="income-amount">${formatDisplayCurrency(income.amount)}</div>
                            <span class="income-source">${income.source}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="editIncome('${income.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" onclick="confirmDelete('income', '${income.id}', '${income.description}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                incomesList.appendChild(incomeItem);
            });
        }
        
        async function loadWallets() {
            wallets = await loadWalletsFromSupabase();
            const walletsList = document.getElementById('walletsList');
            
            globalWalletSelect.innerHTML = '<option value="">Select wallet</option>';
            wallets.forEach(wallet => {
                const option = document.createElement('option');
                option.value = wallet.id;
                option.textContent = wallet.name;
                globalWalletSelect.appendChild(option);
            });
            
            if (currentWalletId) {
                globalWalletSelect.value = currentWalletId;
            } else if (wallets.length > 0) {
                currentWalletId = wallets[0].id;
                globalWalletSelect.value = currentWalletId;
            }
            
            walletsList.innerHTML = '';
            
            if (wallets.length === 0) {
                walletsList.innerHTML = `<div class="wallet-item"><div class="wallet-details">No wallets yet</div></div>`;
                return;
            }
            
            wallets.forEach(wallet => {
                const walletItem = document.createElement('div');
                walletItem.className = 'wallet-item';
                const balance = calculateWalletBalance(wallet.id);
                
                walletItem.innerHTML = `
                    <div class="wallet-details">
                        <div style="font-weight: 500;">${wallet.name}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="wallet-balance">${formatDisplayCurrency(balance)}</div>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="editWallet('${wallet.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" onclick="confirmDelete('wallet', '${wallet.id}', '${wallet.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                walletsList.appendChild(walletItem);
            });
        }
        
        async function loadCategories() {
            try {
                categories = await loadCategoriesFromSupabase();
                renderCategoriesList();
                updateCategoryDropdowns();
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function renderCategoriesList() {
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';
            
            if (categories.length === 0) {
                categoriesList.innerHTML = `<div class="category-item"><div class="category-details">No categories yet</div></div>`;
                return;
            }
            
            const mainCategories = categories.filter(c => c.type === 'main');
            const subcategories = categories.filter(c => c.type === 'sub');
            
            if (mainCategories.length === 0) {
                categoriesList.innerHTML = `<div class="category-item"><div class="category-details">No main categories</div></div>`;
            } else {
                mainCategories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-item';
                    categoryItem.innerHTML = `
                        <div class="category-details">
                            <div style="font-weight: 500;">${category.name}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="category-actions">
                                <button class="add-subcategory-btn" data-id="${category.id}">
                                    <i class="fas fa-plus"></i> Sub
                                </button>
                            </div>
                            <div class="action-buttons">
                                <button class="edit-btn" onclick="editCategory('${category.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-btn" onclick="confirmDelete('category', '${category.id}', '${category.name}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    categoriesList.appendChild(categoryItem);
                    
                    const addSubcategoryBtn = categoryItem.querySelector('.add-subcategory-btn');
                    addSubcategoryBtn.addEventListener('click', () => {
                        openSubcategoryModal(category.id);
                    });
                    
                    const categorySubcategories = subcategories.filter(sc => sc.parentId === category.id);
                    categorySubcategories.forEach(subcategory => {
                        const subcategoryItem = document.createElement('div');
                        subcategoryItem.className = 'category-item subcategory-item';
                        subcategoryItem.innerHTML = `
                            <div class="category-details">
                                <div>${subcategory.name}</div>
                            </div>
                            <div class="action-buttons">
                                <button class="edit-btn" onclick="editCategory('${subcategory.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-btn" onclick="confirmDelete('category', '${subcategory.id}', '${subcategory.name}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        categoriesList.appendChild(subcategoryItem);
                    });
                });
            }
        }

        function loadParentCategories() {
            parentCategory.innerHTML = '<option value="">Select parent</option>';
            const mainCategories = categories.filter(c => c.type === 'main');
            
            mainCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                parentCategory.appendChild(option);
            });
        }
        
        function updateCategoryDropdowns() {
            const expenseCategorySelect = document.getElementById('expenseCategory');
            const expenseSubcategorySelect = document.getElementById('expenseSubcategory');
            
            expenseCategorySelect.innerHTML = '<option value="">Select category</option>';
            expenseSubcategorySelect.innerHTML = '<option value="">Optional</option>';
            
            const mainCategories = categories.filter(c => c.type === 'main');
            
            mainCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                expenseCategorySelect.appendChild(option);
            });
            
            const parentCategorySelect = document.getElementById('parentCategory');
            parentCategorySelect.innerHTML = '<option value="">Select parent</option>';
            mainCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                parentCategorySelect.appendChild(option);
            });
            
            const newExpenseCategorySelect = expenseCategorySelect.cloneNode(true);
            expenseCategorySelect.parentNode.replaceChild(newExpenseCategorySelect, expenseCategorySelect);
            
            newExpenseCategorySelect.addEventListener('change', function() {
                const selectedCategory = this.value;
                const expenseSubcategorySelect = document.getElementById('expenseSubcategory');
                expenseSubcategorySelect.innerHTML = '<option value="">Optional</option>';
                
                if (selectedCategory) {
                    const mainCategory = categories.find(c => c.name === selectedCategory && c.type === 'main');
                    if (mainCategory) {
                        const subcategories = categories.filter(c => c.type === 'sub' && c.parentId === mainCategory.id);
                        subcategories.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.name;
                            option.textContent = subcategory.name;
                            expenseSubcategorySelect.appendChild(option);
                        });
                    }
                }
            });
        }
        
        function updateStats() {
            if (!currentWalletId) {
                document.getElementById('totalIncome').textContent = formatDisplayCurrency(0);
                document.getElementById('totalExpenses').textContent = formatDisplayCurrency(0);
                document.getElementById('currentWalletBalance').textContent = formatDisplayCurrency(0);
                return;
            }

            const walletExpenses = expenses.filter(expense => expense.walletId === currentWalletId);
            const walletIncomes = incomes.filter(income => income.walletId === currentWalletId);
            
            const totalExpenses = walletExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalExpenses').textContent = formatDisplayCurrency(totalExpenses);
            
            const totalIncome = walletIncomes.reduce((sum, income) => sum + income.amount, 0);
            document.getElementById('totalIncome').textContent = formatDisplayCurrency(totalIncome);
            
            const currentWalletBalance = totalIncome - totalExpenses;
            document.getElementById('currentWalletBalance').textContent = formatDisplayCurrency(currentWalletBalance);
        }

        function updateGlobalWalletSelector() {
            if (globalWalletSelect && currentWalletId) {
                globalWalletSelect.value = currentWalletId;
            }
        }

        confirmDeleteBtn.addEventListener('click', async () => {
            if (!itemToDelete || !deleteType) return;
            
            try {
                let success = false;
                
                switch (deleteType) {
                    case 'expense':
                        success = await deleteExpense(itemToDelete);
                        if (success) {
                            expenses = expenses.filter(e => e.id !== itemToDelete);
                            showAlert('Expense deleted', 'success');
                        }
                        break;
                    case 'income':
                        success = await deleteIncome(itemToDelete);
                        if (success) {
                            incomes = incomes.filter(i => i.id !== itemToDelete);
                            showAlert('Income deleted', 'success');
                        }
                        break;
                    case 'wallet':
                        success = await deleteWallet(itemToDelete);
                        if (success) {
                            wallets = wallets.filter(w => w.id !== itemToDelete);
                            expenses = expenses.filter(e => e.walletId !== itemToDelete);
                            incomes = incomes.filter(i => i.walletId !== itemToDelete);
                            
                            if (currentWalletId === itemToDelete) {
                                currentWalletId = wallets.length > 0 ? wallets[0].id : null;
                                updateGlobalWalletSelector();
                            }
                            showAlert('Wallet deleted', 'success');
                        }
                        break;
                    case 'category':
                        success = await deleteCategory(itemToDelete);
                        if (success) {
                            categories = categories.filter(c => c.id !== itemToDelete);
                            showAlert('Category deleted', 'success');
                        }
                        break;
                }
                
                if (success) {
                    await loadExpenses();
                    await loadIncomes();
                    await loadWallets();
                    await loadCategories();
                    updateStats();
                }
            } catch (error) {
                showAlert('Error deleting', 'error');
            }
            
            deleteModal.classList.remove('active');
            itemToDelete = null;
            deleteType = null;
        });

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 
                         type === 'warning' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle';
            alert.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            alertContainer.appendChild(alert);
            
            setTimeout(() => alert.remove(), 4000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setTimeout(() => {
                const expenseCategorySelect = document.getElementById('expenseCategory');
                if (expenseCategorySelect && expenseCategorySelect.options.length <= 1) {
                    updateCategoryDropdowns();
                }
            }, 500);
        });

        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                checkAuthState();
            }
        });
    </script>
</body>
</html>