<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinTrack - Smart Expense Tracking</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        :root {
            --primary: #007AFF;
            --primary-dark: #0056CC;
            --secondary: #5856D6;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --light: #F5F5F7;
            --dark: #1D1D1F;
            --gray: #86868B;
            --gray-light: #D2D2D7;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.07);
            --gradient: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            --income-gradient: linear-gradient(135deg, #34C759 0%, #28A745 100%);
        }

        body {
            background-color: white;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-wrap: break-word;
        }

        /* Navigation Links Styles */
        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            color: var(--dark);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary);
            background-color: rgba(0, 122, 255, 0.1);
        }

        /* Update header padding for better spacing */
        header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .logo i {
            font-size: 1.8rem;
            color: var(--primary);
        }

        .auth-section {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 980px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #28A745;
            transform: scale(1.05);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }


        

        /* Landing Page Styles */
        .landing-page {
            display: none;
        }

        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0 2rem;
            background: linear-gradient(135deg, #F5F5F7 0%, #FFFFFF 100%);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            width: 800px;
            height: 800px;
            border-radius: 50%;
            background: var(--gradient);
            opacity: 0.03;
            top: -400px;
            right: -200px;
            z-index: 0;
        }

        .hero-content {
            max-width: 900px;
            z-index: 1;
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.1;
        }

        .hero p {
            font-size: 1.4rem;
            color: var(--gray);
            margin-bottom: 2.5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 3rem;
        }

        .hero-image {
            max-width: 900px;
            width: 100%;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-top: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .features {
            padding: 6rem 2rem;
            background-color: var(--light);
        }

        .section-header {
            text-align: center;
            max-width: 700px;
            margin: 0 auto 4rem;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--dark);
        }

        .section-subtitle {
            font-size: 1.2rem;
            color: var(--gray);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .feature-card {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-10px);
        }

        .feature-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            background: var(--gradient);
            color: white;
            font-size: 1.8rem;
        }

        .feature-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark);
        }

        .feature-description {
            color: var(--gray);
            line-height: 1.6;
        }

        .benefits {
            padding: 6rem 2rem;
            background: white;
        }

        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 3rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .benefit-item {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
        }

        .benefit-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .benefit-content h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .benefit-content p {
            color: var(--gray);
        }

        .cta {
            padding: 6rem 2rem;
            background: var(--gradient);
            color: white;
            text-align: center;
        }

        .cta h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .cta p {
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto 2.5rem;
            opacity: 0.9;
        }

        .cta-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn-white {
            background: white;
            color: var(--primary);
        }

        .btn-white:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .btn-transparent {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .btn-transparent:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        footer {
            padding: 4rem 2rem 2rem;
            background: var(--dark);
            color: white;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 3rem;
        }

        .footer-column h3 {
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 0.8rem;
        }

        .footer-links a {
            color: var(--gray-light);
            text-decoration: none;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: white;
        }

        .footer-bottom {
            max-width: 1200px;
            margin: 3rem auto 0;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            color: var(--gray);
            font-size: 0.9rem;
        }

        /* Dashboard Styles */
        .dashboard-container {
            display: none;
            min-height: 100vh;
            padding-top: 80px;
            background: var(--light);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .stat-value.income {
            color: var(--success);
        }

        .stat-value.expense {
            color: var(--primary);
        }

        .stat-value.balance {
            color: var(--dark);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .dashboard-tabs {
            display: flex;
            background: white;
            border-radius: 16px;
            padding: 0.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--gray);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .form-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--dark);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }

        /* --- MODIFIED: Added appearance: none and background-color --- */
        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-light);
            border-radius: 12px;
            font-size: 1rem;
            transition: border 0.3s;
            min-width: 0;
            
            /* Force custom appearance, remove iOS native styling */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            /* Explicitly set background to white */
            background-color: white;
        }

        /* --- ADDED: Restore dropdown arrow for select elements --- */
        select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2386868B%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.3-5.4-13z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 16px top 50%;
            background-size: .65em auto;
        }

        /* --- ADDED: Fix for date input text alignment after appearance:none --- */
        input[type="date"] {
            line-height: 1.6; /* Match other inputs */
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .expense-list, .wallet-list, .category-list, .income-list {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow);
        }

        .expense-item, .wallet-item, .category-item, .income-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .expense-item:last-child, .wallet-item:last-child, .category-item:last-child, .income-item:last-child {
            border-bottom: none;
        }

        .expense-details, .wallet-details, .category-details, .income-details {
            flex: 1;
        }

        .expense-amount, .wallet-balance, .income-amount {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--dark);
        }

        .expense-amount {
            color: var(--danger);
        }

        .income-amount {
            color: var(--success);
        }

        .expense-category, .income-source {
            background: var(--light);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .edit-btn, .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn {
            color: var(--primary);
        }

        .edit-btn:hover {
            background: rgba(0, 122, 255, 0.1);
        }

        .delete-btn {
            color: var(--danger);
        }

        .delete-btn:hover {
            background: rgba(255, 59, 48, 0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            padding: 0;
            overflow: hidden;
            transform: translateY(50px) scale(0.9);
            transition: transform 0.5s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            background: var(--gradient);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .modal-header.income {
            background: var(--income-gradient);
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .modal-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .password-strength {
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0;
            transition: width 0.3s, background 0.3s;
        }

        .strength-weak {
            background: var(--danger);
            width: 33%;
        }

        .strength-medium {
            background: var(--warning);
            width: 66%;
        }

        .strength-strong {
            background: var(--success);
            width: 100%;
        }

        /* Alert Styles */
        .alert {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background-color: rgba(52, 199, 89, 0.1);
            color: var(--success);
            border: 1px solid rgba(52, 199, 89, 0.2);
        }

        .alert-error {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .alert-warning {
            background-color: rgba(255, 149, 0, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 149, 0, 0.2);
        }

        /* Hidden utility class */
        .hidden {
            display: none !important;
        }

        /* Currency input styling */
        .currency-input {
            position: relative;
        }

        .currency-input input {
            padding-left: 40px;
        }

        .currency-symbol {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-weight: 500;
        }

        /* Subcategory styles */
        .subcategory-item {
            padding-left: 2rem;
            color: var(--gray);
            border-left: 2px solid var(--gray-light);
            margin-left: 1rem;
        }

        .category-actions {
            display: flex;
            gap: 0.5rem;
        }

        .add-subcategory-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Wallet Selector Styles */
        .wallet-selector-container {
            display: flex;
            align-items: center;
            background: white;
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid var(--gray-light);
            box-shadow: var(--shadow);
        }

        .wallet-selector-container select {
            border: none;
            background: transparent;
            font-weight: 600;
            color: var(--dark);
            cursor: pointer;
        }

        .wallet-selector-container select:focus {
            outline: none;
            box-shadow: none;
        }

        /* Insufficient Balance Modal */
        .insufficient-balance-modal .modal-header {
            background: var(--danger);
        }

        .balance-warning {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 12px;
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.2);
        }

        .balance-warning i {
            font-size: 1.5rem;
            color: var(--danger);
        }

        .balance-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 1.5rem;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .balance-item:last-child {
            border-bottom: none;
        }
        
        /* * =========================================
         * MODIFIED & NEW RESPONSIVE STYLES
         * =========================================
        */

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }
            
            .hero p {
                font-size: 1.2rem;
            }
            
            .hero-buttons, .cta-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .section-title {
                font-size: 2rem;
            }
            
            .feature-card {
                padding: 2rem;
            }
            
            header {
                padding: 1rem;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .dashboard-tabs {
                flex-direction: column;
            }
            
            .category-actions {
                flex-direction: column;
            }
            
            .wallet-selector-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            /* --- NEW: Mobile Optimizations --- */

            /* Reduce section padding on tablets */
            .features, .benefits, .cta {
                padding: 4rem 2rem;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            /* Stack list items vertically */
            .expense-item, .wallet-item, .income-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .category-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            /* Ensure the bottom row (amount + buttons) spans full width */
            .expense-item > div:last-child, 
            .income-item > div:last-child, 
            .wallet-item > div:last-child {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .category-item > div:last-child {
                width: 100%;
            }

            /* Improve touch target size */
            .edit-btn, .delete-btn {
                padding: 10px;
                font-size: 1.1rem; /* Make icon slightly larger */
            }

            .add-subcategory-btn {
                padding: 8px 12px;
            }

            /* Prevent input zoom on iOS */
            input, select {
                font-size: 16px;
            }

            .nav-links {
                gap: 1rem;
            }
            
            .nav-link span {
                display: none;
            }
            
            .nav-link {
                padding: 8px;
            }            
        }

        /* --- NEW: Added breakpoint for small phones --- */
        @media (max-width: 480px) {
            .container {
                padding: 0 1rem;
            }

            /* Icon-only buttons in header */
            .auth-section .btn span {
                display: none;
            }

            .auth-section .btn {
                padding: 10px 12px;
                gap: 0;
            }
            
            .auth-section {
                gap: 8px;
            }

            .logo {
                font-size: 1.3rem;
            }
            .logo i {
                font-size: 1.5rem;
            }

            /* Further reduce fonts */
            .hero h1 {
                font-size: 2.2rem;
            }
            .hero p {
                font-size: 1.1rem;
            }
            .section-title {
                font-size: 1.8rem;
            }
            .section-subtitle {
                font-size: 1rem;
            }
            
            /* Further reduce padding */
            .features, .benefits, .cta {
                padding: 4rem 1.5rem;
            }
            .form-card,
            .expense-list, .wallet-list, .category-list, .income-list {
                padding: 1.5rem;
            }
            
            .modal-body {
                padding: 1.5rem;
            }
            .modal-header {
                padding: 1.5rem;
            }
            .modal-title {
                font-size: 1.5rem;
            }

            .dashboard-title {
                font-size: 1.5rem;
            }

            /* Make category/source tags smaller */
            .expense-category, .income-source {
                display: block;
                margin-top: 4px;
                text-align: right;
            }

            .expense-amount, .income-amount {
                text-align: right;
            }

            .nav-links {
                gap: 0.5rem;
            }            
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-chart-pie"></i>
            <span>FinTrack</span>
        </div>
        
        <!-- Add this navigation section -->
        <div class="nav-links">
            <a href="index.html" class="nav-link active">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="analytics.html" class="nav-link">
                <i class="fas fa-chart-bar"></i>
                <span>Analytics</span>
            </a>
        </div>
        
        <div class="auth-section">
            <button id="loginBtn" class="btn btn-outline">
                <i class="fas fa-sign-in-alt"></i>
                <span>Sign In</span>
            </button>
            <button id="signupBtn" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>
                <span>Get Started</span>
            </button>
            <button id="logoutBtn" class="btn btn-outline hidden">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sign Out</span>
            </button>
        </div>
    </header>

    <div id="landingPage" class="landing-page">
        <section class="hero">
            <div class="hero-content">
                <h1>Track Expenses.<br>Master Your Finances.</h1>
                <p>FinTrack helps you understand where your money goes with beautiful visuals and powerful insights.</p>
                <div class="hero-buttons">
                    <button id="heroSignupBtn" class="btn btn-primary">
                        <i class="fas fa-rocket"></i>
                        Start Free Trial
                    </button>
                    <button class="btn btn-outline">
                        <i class="fas fa-play-circle"></i>
                        Watch Demo
                    </button>
                </div>
                <div class="hero-image">
                    <div style="background: var(--gradient); height: 400px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                        FinTrack Dashboard Preview
                    </div>
                </div>
            </div>
        </section>

        <section class="features">
            <div class="section-header">
                <h2 class="section-title">Everything You Need to Manage Expenses</h2>
                <p class="section-subtitle">FinTrack provides all the tools you need to take control of your financial life</p>
            </div>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <h3 class="feature-title">Multiple Wallets</h3>
                    <p class="feature-description">Track expenses across multiple wallets, bank accounts, and credit cards in one place.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-tags"></i>
                    </div>
                    <h3 class="feature-title">Smart Categories</h3>
                    <p class="feature-description">Automatically categorize expenses and create custom categories for better organization.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h3 class="feature-title">Visual Reports</h3>
                    <p class="feature-description">Understand your spending patterns with beautiful charts and visualizations.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3 class="feature-title">Income Tracking</h3>
                    <p class="feature-description">Track all your income sources and see how they contribute to your financial health.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3 class="feature-title">Secure & Private</h3>
                    <p class="feature-description">Your data is encrypted and secure with enterprise-grade security infrastructure.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-sync"></i>
                    </div>
                    <h3 class="feature-title">Real-time Sync</h3>
                    <p class="feature-description">Your data syncs instantly across all devices so you're always up to date.</p>
                </div>
            </div>
        </section>

        <section class="benefits">
            <div class="section-header">
                <h2 class="section-title">Why Choose FinTrack?</h2>
                <p class="section-subtitle">Join thousands of users who have transformed their financial lives</p>
            </div>
            <div class="benefits-grid">
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Save Time</h3>
                        <p>Automate expense tracking and categorization to spend less time managing finances.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Gain Insights</h3>
                        <p>Discover spending patterns and identify opportunities to save more money.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Achieve Goals</h3>
                        <p>Set financial goals and track your progress with personalized recommendations.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Share with Partners</h3>
                        <p>Easily share expense tracking with family members or business partners.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Export Data</h3>
                        <p>Download your financial data in multiple formats for tax preparation or analysis.</p>
                    </div>
                </div>
                <div class="benefit-item">
                    <div class="benefit-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    <div class="benefit-content">
                        <h3>Premium Support</h3>
                        <p>Get help when you need it with our responsive customer support team.</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="cta">
            <h2>Ready to Transform Your Finances?</h2>
            <p>Join FinTrack today and start your journey to financial clarity and control.</p>
            <div class="cta-buttons">
                <button id="ctaSignupBtn" class="btn btn-white">
                    <i class="fas fa-rocket"></i>
                    Get Started Free
                </button>
                <button class="btn btn-transparent">
                    <i class="fas fa-calendar"></i>
                    Book a Demo
                </button>
            </div>
        </section>

        <footer>
            <div class="footer-content">
                <div class="footer-column">
                    <h3>FinTrack</h3>
                    <ul class="footer-links">
                        <li><a href="#">About Us</a></li>
                        <li><a href="#">Careers</a></li>
                        <li><a href="#">Press</a></li>
                        <li><a href="#">Blog</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Product</h3>
                    <ul class="footer-links">
                        <li><a href="#">Features</a></li>
                        <li><a href="#">Pricing</a></li>
                        <li><a href="#">Security</a></li>
                        <li><a href="#">Roadmap</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Resources</h3>
                    <ul class="footer-links">
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Community</a></li>
                        <li><a href="#">Guides</a></li>
                        <li><a href="#">API</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Legal</h3>
                    <ul class="footer-links">
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Cookie Policy</a></li>
                        <li><a href="#">GDPR</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2023 FinTrack. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <div id="dashboardContainer" class="dashboard-container">
        <div class="container">
            <!-- Add this back button -->
            <div style="margin-bottom: 1.5rem;">
                <a href="analytics.html" class="btn btn-outline">
                    <i class="fas fa-chart-bar"></i>
                    View Analytics
                </a>
            </div>
            
            <div class="dashboard-header">
                <h1 class="dashboard-title">Financial Dashboard</h1>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div class="wallet-selector-container">
                        <label for="globalWalletSelect" style="font-size: 0.9rem; color: var(--gray); margin-right: 8px;">Current Wallet:</label>
                        <select id="globalWalletSelect" style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--gray-light);">
                            <option value="">Select a wallet</option>
                        </select>
                    </div>
                    <span id="userEmail" style="color: var(--gray);"></span>
                </div>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value income" id="totalIncome">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Expenses</div>
                    <div class="stat-value expense" id="totalExpenses">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Current Wallet Balance</div>
                    <div class="stat-value balance" id="currentWalletBalance">Rp 0</div>
                </div>
            </div>

            <div class="dashboard-tabs">
                <div class="tab active" data-tab="expenses">Expenses</div>
                <div class="tab" data-tab="income">Income</div>
                <div class="tab" data-tab="wallets">Wallets</div>
                <div class="tab" data-tab="categories">Categories</div>
            </div>

            <div id="expensesTab" class="tab-content active">
                <div class="form-card">
                    <h2 class="form-title">Add New Expense</h2>
                    <form id="expenseForm">
                        <input type="hidden" id="expenseId">
                        <div class="form-group">
                            <label for="expenseDescription">Description</label>
                            <input type="text" id="expenseDescription" placeholder="What did you spend on?" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expenseAmount">Amount</label>
                                <div class="currency-input">
                                    <span class="currency-symbol">Rp</span>
                                    <input type="text" id="expenseAmount" placeholder="0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="expenseDate">Date</label>
                                <input type="date" id="expenseDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expenseCategory">Category</label>
                                <select id="expenseCategory" required>
                                    <option value="">Select a category</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="expenseSubcategory">Subcategory</label>
                                <select id="expenseSubcategory">
                                    <option value="">Select a subcategory (optional)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary" id="expenseSubmitBtn">
                                <i class="fas fa-minus-circle"></i> Add Expense
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="expenseCancelBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="expense-list">
                    <h2 class="form-title">Recent Expenses</h2>
                    <div id="expensesList">
                        <div class="expense-item">
                            <div class="expense-details">
                                <div>No expenses yet. Add your first expense!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="incomeTab" class="tab-content">
                <div class="form-card">
                    <h2 class="form-title">Add New Income</h2>
                    <form id="incomeForm">
                        <input type="hidden" id="incomeId">
                        <div class="form-group">
                            <label for="incomeDescription">Description</label>
                            <input type="text" id="incomeDescription" placeholder="Where did this income come from?" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="incomeAmount">Amount</label>
                                <div class="currency-input">
                                    <span class="currency-symbol">Rp</span>
                                    <input type="text" id="incomeAmount" placeholder="0" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="incomeDate">Date</label>
                                <input type="date" id="incomeDate" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="incomeSource">Income Source</label>
                            <select id="incomeSource" required>
                                <option value="">Select income source</option>
                                <option value="Salary">Salary</option>
                                <option value="Freelance">Freelance</option>
                                <option value="Investment">Investment</option>
                                <option value="Gift">Gift</option>
                                <option value="Bonus">Bonus</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-success" id="incomeSubmitBtn">
                                <i class="fas fa-plus-circle"></i> Add Income
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="incomeCancelBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="income-list">
                    <h2 class="form-title">Recent Income</h2>
                    <div id="incomesList">
                        <div class="income-item">
                            <div class="income-details">
                                <div>No income yet. Add your first income!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="walletsTab" class="tab-content">
                <div class="form-card">
                    <h2 class="form-title">Add New Wallet</h2>
                    <form id="walletForm">
                        <input type="hidden" id="walletId">
                        <div class="form-group">
                            <label for="walletName">Wallet Name</label>
                            <input type="text" id="walletName" placeholder="e.g., Cash, Bank Account, Credit Card" required>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary" id="walletSubmitBtn">
                                <i class="fas fa-plus-circle"></i> Add Wallet
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="walletCancelBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="wallet-list">
                    <h2 class="form-title">Your Wallets</h2>
                    <div id="walletsList">
                        <div class="wallet-item">
                            <div class="wallet-details">
                                <div>No wallets yet. Add your first wallet!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="categoriesTab" class="tab-content">
                <div class="form-card">
                    <div class="form-title">Add New Category</div>
                    <form id="categoryForm">
                        <input type="hidden" id="categoryId">
                        <div class="form-group">
                            <label for="categoryType">Category Type</label>
                            <select id="categoryType" required>
                                <option value="">Select type</option>
                                <option value="main">Main Category</option>
                                <option value="sub">Subcategory</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="categoryName">Category Name</label>
                            <input type="text" id="categoryName" placeholder="e.g., Food, Transportation" required>
                        </div>
                        <div class="form-group hidden" id="parentCategoryGroup">
                            <label for="parentCategory">Parent Category</label>
                            <select id="parentCategory">
                                <option value="">Select a parent category</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary" id="categorySubmitBtn">
                                <i class="fas fa-plus-circle"></i> Add Category
                            </button>
                            <button type="button" class="btn btn-outline hidden" id="categoryCancelBtn">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="category-list">
                    <h2 class="form-title">Your Categories</h2>
                    <div id="categoriesList">
                        <div class="category-item">
                            <div class="category-details">
                                <div>No categories yet. Add your first category!</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="subcategoryModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeSubcategoryModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Add Subcategory</h2>
                <p class="modal-subtitle">Create a new subcategory</p>
            </div>
            <div class="modal-body">
                <form id="subcategoryForm">
                    <div class="form-group">
                        <label for="subcategoryName">Subcategory Name</label>
                        <input type="text" id="subcategoryName" placeholder="e.g., Groceries, Restaurants" required>
                    </div>
                    <input type="hidden" id="parentCategoryId">
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px;">
                        <i class="fas fa-plus-circle"></i> Add Subcategory
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <div class="modal-header" style="background: var(--danger);">
                <button class="modal-close" id="closeDeleteModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Confirm Deletion</h2>
                <p class="modal-subtitle">This action cannot be undone</p>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Are you sure you want to delete this item?</p>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-outline" id="cancelDeleteBtn" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-danger" id="confirmDeleteBtn" style="flex: 1; background: var(--danger);">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay insufficient-balance-modal" id="insufficientBalanceModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeInsufficientBalanceModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Insufficient Balance</h2>
                <p class="modal-subtitle">Your wallet doesn't have enough funds</p>
            </div>
            <div class="modal-body">
                <div class="balance-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>
                        <h3>Expense exceeds wallet balance</h3>
                        <p>You cannot add this expense because your wallet doesn't have sufficient funds.</p>
                    </div>
                </div>
                <div class="balance-details">
                    <div class="balance-item">
                        <span>Expense Amount:</span>
                        <strong id="expenseAmountDetail">Rp 0</strong>
                    </div>
                    <div class="balance-item">
                        <span>Current Wallet Balance:</span>
                        <strong id="walletBalanceDetail">Rp 0</strong>
                    </div>
                    <div class="balance-item">
                        <span>Remaining After Expense:</span>
                        <strong id="remainingBalanceDetail" style="color: var(--danger);">Rp 0</strong>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" id="addFundsBtn" style="flex: 1;">
                        <i class="fas fa-plus-circle"></i> Add Income
                    </button>
                    <button class="btn btn-outline" id="cancelExpenseBtn" style="flex: 1;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="signupModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeSignupModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Create Account</h2>
                <p class="modal-subtitle">Start your journey to financial clarity</p>
            </div>
            <div class="modal-body">
                <form id="signupForm">
                    <div class="form-group">
                        <label for="signupEmail">Email Address</label>
                        <input type="email" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="signupPassword">Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a password" required>
                        <div class="password-strength">
                            <div class="strength-bar" id="passwordStrength"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px;">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </form>
                <div style="text-align: center; margin-top: 20px;">
                    <p>Already have an account? <a href="#" id="showLoginFromSignup" style="color: var(--primary); text-decoration: none; font-weight: 600;">Sign in here</a></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <button class="modal-close" id="closeLoginModal">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="modal-title">Welcome Back</h2>
                <p class="modal-subtitle">Sign in to your account</p>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input type="email" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px;">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </form>
                <div style="text-align: center; margin-top: 20px;">
                    <p>Don't have an account? <a href="#" id="showSignupFromLogin" style="color: var(--primary); text-decoration: none; font-weight: 600;">Sign up here</a></p>
                </div>
            </div>
        </div>
    </div>

    <div id="alertContainer" style="position: fixed; top: 100px; right: 20px; z-index: 3000; max-width: 400px;"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://slgzgaojmgzjhtuaptod.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZ3pnYW9qbWd6amh0dWFwdG9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNzQyMzMsImV4cCI6MjA3ODg1MDIzM30.aD9cjbekiufRaatuNaAEP2uD2uU7ggpPor6jtSGM-F4';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM Elements
        const signupModal = document.getElementById('signupModal');
        const loginModal = document.getElementById('loginModal');
        const subcategoryModal = document.getElementById('subcategoryModal');
        const insufficientBalanceModal = document.getElementById('insufficientBalanceModal');
        const deleteModal = document.getElementById('deleteModal');
        const signupBtn = document.getElementById('signupBtn');
        const loginBtn = document.getElementById('loginBtn');
        const heroSignupBtn = document.getElementById('heroSignupBtn');
        const ctaSignupBtn = document.getElementById('ctaSignupBtn');
        const closeSignupModal = document.getElementById('closeSignupModal');
        const closeLoginModal = document.getElementById('closeLoginModal');
        const closeSubcategoryModal = document.getElementById('closeSubcategoryModal');
        const closeInsufficientBalanceModal = document.getElementById('closeInsufficientBalanceModal');
        const closeDeleteModal = document.getElementById('closeDeleteModal');
        const showSignupFromLogin = document.getElementById('showSignupFromLogin');
        const showLoginFromSignup = document.getElementById('showLoginFromSignup');
        const signupForm = document.getElementById('signupForm');
        const loginForm = document.getElementById('loginForm');
        const subcategoryForm = document.getElementById('subcategoryForm');
        const incomeForm = document.getElementById('incomeForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const dashboardContainer = document.getElementById('dashboardContainer');
        const landingPage = document.getElementById('landingPage');
        const passwordStrength = document.getElementById('passwordStrength');
        const signupPassword = document.getElementById('signupPassword');
        const alertContainer = document.getElementById('alertContainer');
        const userEmail = document.getElementById('userEmail');
        
        // Dashboard elements
        const expenseForm = document.getElementById('expenseForm');
        const walletForm = document.getElementById('walletForm');
        const categoryForm = document.getElementById('categoryForm');
        const globalWalletSelect = document.getElementById('globalWalletSelect');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const categoryType = document.getElementById('categoryType');
        const parentCategoryGroup = document.getElementById('parentCategoryGroup');
        const parentCategory = document.getElementById('parentCategory');
        const expenseCategory = document.getElementById('expenseCategory');
        const expenseSubcategory = document.getElementById('expenseSubcategory');
        
        // Form buttons
        const expenseSubmitBtn = document.getElementById('expenseSubmitBtn');
        const expenseCancelBtn = document.getElementById('expenseCancelBtn');
        const incomeSubmitBtn = document.getElementById('incomeSubmitBtn');
        const incomeCancelBtn = document.getElementById('incomeCancelBtn');
        const walletSubmitBtn = document.getElementById('walletSubmitBtn');
        const walletCancelBtn = document.getElementById('walletCancelBtn');
        const categorySubmitBtn = document.getElementById('categorySubmitBtn');
        const categoryCancelBtn = document.getElementById('categoryCancelBtn');
        
        // Delete modal elements
        const deleteMessage = document.getElementById('deleteMessage');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        
        // Insufficient balance modal elements
        const expenseAmountDetail = document.getElementById('expenseAmountDetail');
        const walletBalanceDetail = document.getElementById('walletBalanceDetail');
        const remainingBalanceDetail = document.getElementById('remainingBalanceDetail');
        const addFundsBtn = document.getElementById('addFundsBtn');
        const cancelExpenseBtn = document.getElementById('cancelExpenseBtn');

        // Data storage
        let expenses = [];
        let incomes = [];
        let wallets = [];
        let categories = [];
        let currentWalletId = null;
        let pendingExpense = null;
        let itemToDelete = null;
        let deleteType = null;

        // Currency formatting functions
        function formatCurrency(value) {
            const numericValue = value.replace(/\D/g, '');
            return numericValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function parseCurrency(formattedValue) {
            return parseInt(formattedValue.replace(/\./g, '')) || 0;
        }

        function formatDisplayCurrency(amount) {
            return `Rp ${amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`;
        }

        // Helper function to check if a string is a valid UUID
        function isValidUUID(str) {
            if (!str) return false;
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            return uuidRegex.test(str);
        }

        // Calculate wallet balance - purely based on income minus expenses
        function calculateWalletBalance(walletId) {
            const walletExpenses = expenses.filter(expense => expense.walletId === walletId);
            const totalExpenses = walletExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            const walletIncome = incomes.filter(income => income.walletId === walletId);
            const totalIncome = walletIncome.reduce((sum, income) => sum + income.amount, 0);
            
            // Simple calculation: income minus expenses
            return totalIncome - totalExpenses;
        }

        // Initialize the app
        function initApp() {
            logoutBtn.classList.add('hidden');
            loginBtn.classList.remove('hidden');
            signupBtn.classList.remove('hidden');
            
            document.getElementById('expenseDate').valueAsDate = new Date();
            document.getElementById('incomeDate').valueAsDate = new Date();
            
            setupTabs();
            setupCurrencyInputs();
            setupCategoryTypeToggle();
            
            checkAuthState();
        }

        // Event Listeners
        signupBtn.addEventListener('click', () => signupModal.classList.add('active'));
        loginBtn.addEventListener('click', () => loginModal.classList.add('active'));
        heroSignupBtn.addEventListener('click', () => signupModal.classList.add('active'));
        ctaSignupBtn.addEventListener('click', () => signupModal.classList.add('active'));
        closeSignupModal.addEventListener('click', () => signupModal.classList.remove('active'));
        closeLoginModal.addEventListener('click', () => loginModal.classList.remove('active'));
        closeSubcategoryModal.addEventListener('click', () => subcategoryModal.classList.remove('active'));
        closeInsufficientBalanceModal.addEventListener('click', () => insufficientBalanceModal.classList.remove('active'));
        closeDeleteModal.addEventListener('click', () => deleteModal.classList.remove('active'));
        cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.remove('active'));

        showSignupFromLogin.addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.classList.remove('active');
            signupModal.classList.add('active');
        });

        showLoginFromSignup.addEventListener('click', (e) => {
            e.preventDefault();
            signupModal.classList.remove('active');
            loginModal.classList.add('active');
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === signupModal) signupModal.classList.remove('active');
            if (e.target === loginModal) loginModal.classList.remove('active');
            if (e.target === subcategoryModal) subcategoryModal.classList.remove('active');
            if (e.target === insufficientBalanceModal) insufficientBalanceModal.classList.remove('active');
            if (e.target === deleteModal) deleteModal.classList.remove('active');
        });

        // Insufficient balance modal buttons
        addFundsBtn.addEventListener('click', () => {
            insufficientBalanceModal.classList.remove('active');
            // Switch to income tab to add funds
            document.querySelector('[data-tab="income"]').click();
            showAlert('Please add income to your wallet first', 'warning');
        });

        cancelExpenseBtn.addEventListener('click', () => {
            insufficientBalanceModal.classList.remove('active');
            pendingExpense = null;
        });

        // Password strength indicator
        signupPassword.addEventListener('input', function() {
            const password = this.value;
            let strength = 0;
            
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            passwordStrength.className = 'strength-bar';
            
            if (password.length > 0) {
                if (strength <= 2) passwordStrength.classList.add('strength-weak');
                else if (strength === 3) passwordStrength.classList.add('strength-medium');
                else passwordStrength.classList.add('strength-strong');
            }
        });

        // Form submissions
        signupForm.addEventListener('submit', handleSignup);
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        expenseForm.addEventListener('submit', handleAddExpense);
        incomeForm.addEventListener('submit', handleAddIncome);
        walletForm.addEventListener('submit', handleAddWallet);
        categoryForm.addEventListener('submit', handleAddCategory);
        subcategoryForm.addEventListener('submit', handleAddSubcategory);

        // Cancel buttons
        expenseCancelBtn.addEventListener('click', resetExpenseForm);
        incomeCancelBtn.addEventListener('click', resetIncomeForm);
        walletCancelBtn.addEventListener('click', resetWalletForm);
        categoryCancelBtn.addEventListener('click', resetCategoryForm);

        // Global wallet selector event listener - UPDATED
        if (globalWalletSelect) {
            globalWalletSelect.addEventListener('change', async function() {
                currentWalletId = this.value;
                console.log('Wallet changed to:', currentWalletId);
                
                if (currentWalletId) {
                    await loadExpenses();
                    await loadIncomes();
                    updateStats();
                } else {
                    // If no wallet selected, clear everything
                    document.getElementById('expensesList').innerHTML = `
                        <div class="expense-item">
                            <div class="expense-details">
                                <div>Please select a wallet to view expenses</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('incomesList').innerHTML = `
                        <div class="income-item">
                            <div class="income-details">
                                <div>Please select a wallet to view income</div>
                            </div>
                        </div>
                    `;
                    updateStats();
                }
            });
        }

        // Tab switching setup
        function setupTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show corresponding content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}Tab`) {
                            content.classList.add('active');
                            
                            // If switching to expenses tab, ensure category dropdowns are updated
                            if (tabId === 'expenses') {
                                console.log('Switched to expenses tab, updating category dropdowns...');
                                updateCategoryDropdowns();
                            }
                        }
                    });
                });
            });
        }

        // Currency input setup
        function setupCurrencyInputs() {
            const expenseAmount = document.getElementById('expenseAmount');
            const incomeAmount = document.getElementById('incomeAmount');
            
            expenseAmount.addEventListener('input', function() {
                this.value = formatCurrency(this.value);
            });
            
            incomeAmount.addEventListener('input', function() {
                this.value = formatCurrency(this.value);
            });
        }

        // Category type toggle setup
        function setupCategoryTypeToggle() {
            categoryType.addEventListener('change', function() {
                if (this.value === 'sub') {
                    parentCategoryGroup.classList.remove('hidden');
                    loadParentCategories();
                } else {
                    parentCategoryGroup.classList.add('hidden');
                }
            });
        }

        // Open subcategory modal
        function openSubcategoryModal(parentId) {
            document.getElementById('parentCategoryId').value = parentId;
            subcategoryModal.classList.add('active');
        }

        // Authentication Functions
        async function handleSignup(e) {
            e.preventDefault();
            
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!email || !password) {
                showAlert('Please enter both email and password', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signUp({ 
                    email, 
                    password,
                    options: {
                        emailRedirectTo: window.location.origin
                    }
                });
                
                if (error) {
                    showAlert(error.message, 'error');
                } else {
                    if (data.user && data.session) {
                        // User is immediately confirmed (might be due to Supabase settings)
                        showAlert('Account created successfully! Welcome to FinTrack.', 'success');
                        signupModal.classList.remove('active');
                        signupForm.reset();
                        passwordStrength.className = 'strength-bar';
                        showDashboard(email);
                    } else {
                        // Email confirmation required
                        showAlert('Account created successfully! Please check your email for verification link.', 'success');
                        signupModal.classList.remove('active');
                        signupForm.reset();
                        passwordStrength.className = 'strength-bar';
                        // Don't show dashboard until email is confirmed
                    }
                }
            } catch (error) {
                console.error('Signup error:', error);
                // Don't automatically fall back to demo mode on error
                showAlert('Error creating account. Please try again.', 'error');
            }
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAlert('Please enter both email and password', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                
                if (error) {
                    if (error.message.includes('Email not confirmed')) {
                        showAlert('Please check your email and confirm your account before signing in.', 'error');
                    } else {
                        showAlert(error.message, 'error');
                    }
                } else {
                    showAlert('Login successful!', 'success');
                    loginModal.classList.remove('active');
                    showDashboard(email);
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('Error signing in. Please try again.', 'error');
            }
        }
        
        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) showAlert(error.message, 'error');
                else showAlert('Logged out successfully', 'success');
                hideDashboard();
            } catch (error) {
                console.error('Logout error:', error);
                hideDashboard();
            }
        }

        // Check authentication state
        async function checkAuthState() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    // Check if email is confirmed using the auth user data
                    if (user.email_confirmed_at) {
                        showDashboard(user.email);
                    } else {
                        showAlert('Please confirm your email address before accessing the dashboard.', 'warning');
                        // You might want to sign them out here, or show a confirmation reminder
                        await supabase.auth.signOut();
                    }
                } else {
                    hideDashboard();
                }
            } catch (error) {
                console.error('Auth state check error:', error);
                hideDashboard();
            }
        }

        async function showDashboard(email) {
            landingPage.style.display = 'none';
            dashboardContainer.style.display = 'block';
            loginBtn.classList.add('hidden');
            signupBtn.classList.add('hidden');
            logoutBtn.classList.remove('hidden');
            
            if (email) userEmail.textContent = email;
            
            await loadWallets();
            await loadCategories(); // This will call updateCategoryDropdowns internally
            await loadExpenses();
            await loadIncomes();
            updateStats();
            
            // Set the first wallet as current if none is selected
            if (wallets.length > 0 && !currentWalletId) {
                currentWalletId = wallets[0].id;
                updateGlobalWalletSelector();
                updateStats();
            }
            
            // Force update category dropdowns one more time to ensure they're populated
            updateCategoryDropdowns();
        }

        function hideDashboard() {
            landingPage.style.display = 'block';
            dashboardContainer.style.display = 'none';
            loginBtn.classList.remove('hidden');
            signupBtn.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
        }

        // Supabase Data Functions
        async function saveExpense(expense) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                if (expense.id) {
                    // Update existing expense
                    const { data, error } = await supabase
                        .from('expenses')
                        .update({
                            description: expense.description,
                            amount: expense.amount,
                            date: expense.date,
                            category: expense.category,
                            subcategory: expense.subcategory,
                            wallet_id: expense.walletId
                        })
                        .eq('id', expense.id)
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                } else {
                    // Create new expense
                    const { data, error } = await supabase
                        .from('expenses')
                        .insert([{
                            description: expense.description,
                            amount: expense.amount,
                            date: expense.date,
                            category: expense.category,
                            subcategory: expense.subcategory,
                            wallet_id: expense.walletId,
                            user_id: user.id
                        }])
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Error saving expense:', error);
                const expenses = JSON.parse(localStorage.getItem('fintrack_expenses') || '[]');
                
                if (expense.id) {
                    // Update existing
                    const index = expenses.findIndex(e => e.id === expense.id);
                    if (index !== -1) {
                        expenses[index] = expense;
                    }
                } else {
                    // Create new
                    expense.id = expense.id || Date.now().toString();
                    expenses.push(expense);
                }
                
                localStorage.setItem('fintrack_expenses', JSON.stringify(expenses));
                return expense;
            }
        }

        // Save income to Supabase or localStorage
        async function saveIncome(income) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                if (income.id) {
                    // Update existing income
                    const { data, error } = await supabase
                        .from('incomes')
                        .update({
                            description: income.description,
                            amount: income.amount,
                            date: income.date,
                            source: income.source,
                            wallet_id: income.walletId
                        })
                        .eq('id', income.id)
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                } else {
                    // Create new income
                    const { data, error } = await supabase
                        .from('incomes')
                        .insert([{
                            description: income.description,
                            amount: income.amount,
                            date: income.date,
                            source: income.source,
                            wallet_id: income.walletId,
                            user_id: user.id
                        }])
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Error saving income:', error);
                const incomes = JSON.parse(localStorage.getItem('fintrack_incomes') || '[]');
                
                if (income.id) {
                    // Update existing
                    const index = incomes.findIndex(i => i.id === income.id);
                    if (index !== -1) {
                        incomes[index] = income;
                    }
                } else {
                    // Create new
                    income.id = income.id || `income-${Date.now()}`;
                    incomes.push(income);
                }
                
                localStorage.setItem('fintrack_incomes', JSON.stringify(incomes));
                return income;
            }
        }

        async function saveWallet(wallet) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                if (wallet.id) {
                    // Update existing wallet
                    const { data, error } = await supabase
                        .from('wallets')
                        .update({
                            name: wallet.name
                        })
                        .eq('id', wallet.id)
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                } else {
                    // Create new wallet
                    const { data, error } = await supabase
                        .from('wallets')
                        .insert([{
                            name: wallet.name,
                            user_id: user.id
                        }])
                        .select();
                    
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Error saving wallet:', error);
                const wallets = JSON.parse(localStorage.getItem('fintrack_wallets') || '[]');
                
                if (wallet.id) {
                    // Update existing
                    const index = wallets.findIndex(w => w.id === wallet.id);
                    if (index !== -1) {
                        wallets[index] = wallet;
                    }
                } else {
                    // Create new
                    wallet.id = wallet.id || `wallet-${Date.now()}`;
                    wallets.push(wallet);
                }
                
                localStorage.setItem('fintrack_wallets', JSON.stringify(wallets));
                return wallet;
            }
        }

        // Updated saveCategory function - let Supabase handle ID generation
        async function saveCategory(category) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                // Prepare the data for insertion
                const categoryData = {
                    name: category.name,
                    type: category.type,
                    user_id: user.id
                };
                
                // Only add parent_id if it exists and is a valid UUID
                if (category.parentId && isValidUUID(category.parentId)) {
                    categoryData.parent_id = category.parentId;
                }
                
                console.log('Saving to database:', categoryData);
                
                if (category.id) {
                    // Update existing category
                    const { data, error } = await supabase
                        .from('categories')
                        .update(categoryData)
                        .eq('id', category.id)
                        .select();
                    
                    if (error) {
                        console.error('Supabase update error:', error);
                        throw error;
                    }
                    
                    console.log('Database response:', data);
                    return {
                        id: data[0].id,
                        name: data[0].name,
                        type: data[0].type,
                        parentId: data[0].parent_id
                    };
                } else {
                    // Create new category
                    const { data, error } = await supabase
                        .from('categories')
                        .insert([categoryData])
                        .select();
                    
                    if (error) {
                        console.error('Supabase insert error:', error);
                        throw error;
                    }
                    
                    console.log('Database response:', data);
                    
                    // Return the saved category
                    return {
                        id: data[0].id,
                        name: data[0].name,
                        type: data[0].type,
                        parentId: data[0].parent_id
                    };
                }
            } catch (error) {
                console.error('Error saving category:', error);
                showAlert('Error saving category: ' + error.message, 'error');
                
                // Fallback to localStorage
                const localCategories = JSON.parse(localStorage.getItem('fintrack_categories') || '[]');
                
                if (category.id) {
                    // Update existing
                    const index = localCategories.findIndex(c => c.id === category.id);
                    if (index !== -1) {
                        localCategories[index] = category;
                    }
                } else {
                    // Create new
                    category.id = category.id || Date.now().toString();
                    localCategories.push(category);
                }
                
                localStorage.setItem('fintrack_categories', JSON.stringify(localCategories));
                return category;
            }
        }

        // Delete functions
        async function deleteExpense(id) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                const { error } = await supabase
                    .from('expenses')
                    .delete()
                    .eq('id', id)
                    .eq('user_id', user.id);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error deleting expense:', error);
                const expenses = JSON.parse(localStorage.getItem('fintrack_expenses') || '[]');
                const filteredExpenses = expenses.filter(expense => expense.id !== id);
                localStorage.setItem('fintrack_expenses', JSON.stringify(filteredExpenses));
                return true;
            }
        }

        async function deleteIncome(id) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                const { error } = await supabase
                    .from('incomes')
                    .delete()
                    .eq('id', id)
                    .eq('user_id', user.id);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error deleting income:', error);
                const incomes = JSON.parse(localStorage.getItem('fintrack_incomes') || '[]');
                const filteredIncomes = incomes.filter(income => income.id !== id);
                localStorage.setItem('fintrack_incomes', JSON.stringify(filteredIncomes));
                return true;
            }
        }

        async function deleteWallet(id) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                const { error } = await supabase
                    .from('wallets')
                    .delete()
                    .eq('id', id)
                    .eq('user_id', user.id);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error deleting wallet:', error);
                const wallets = JSON.parse(localStorage.getItem('fintrack_wallets') || '[]');
                const filteredWallets = wallets.filter(wallet => wallet.id !== id);
                localStorage.setItem('fintrack_wallets', JSON.stringify(filteredWallets));
                return true;
            }
        }

        async function deleteCategory(id) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User not authenticated');
                
                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', id)
                    .eq('user_id', user.id);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error deleting category:', error);
                const categories = JSON.parse(localStorage.getItem('fintrack_categories') || '[]');
                const filteredCategories = categories.filter(category => category.id !== id);
                localStorage.setItem('fintrack_categories', JSON.stringify(filteredCategories));
                return true;
            }
        }

        async function loadExpensesFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('date', { ascending: false });
                
                if (error) throw error;
                
                return data.map(expense => ({
                    id: expense.id,
                    description: expense.description,
                    amount: expense.amount,
                    date: expense.date,
                    category: expense.category,
                    subcategory: expense.subcategory,
                    walletId: expense.wallet_id
                }));
            } catch (error) {
                console.error('Error loading expenses:', error);
                return JSON.parse(localStorage.getItem('fintrack_expenses') || '[]');
            }
        }

        // Load incomes from Supabase or localStorage
        async function loadIncomesFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                
                const { data, error } = await supabase
                    .from('incomes')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('date', { ascending: false });
                
                if (error) throw error;
                
                return data.map(income => ({
                    id: income.id,
                    description: income.description,
                    amount: income.amount,
                    date: income.date,
                    source: income.source,
                    walletId: income.wallet_id
                }));
            } catch (error) {
                console.error('Error loading incomes:', error);
                return JSON.parse(localStorage.getItem('fintrack_incomes') || '[]');
            }
        }

        async function loadWalletsFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                
                const { data, error } = await supabase
                    .from('wallets')
                    .select('*')
                    .eq('user_id', user.id);
                
                if (error) throw error;
                
                return data.map(wallet => ({
                    id: wallet.id,
                    name: wallet.name
                }));
            } catch (error) {
                console.error('Error loading wallets:', error);
                return JSON.parse(localStorage.getItem('fintrack_wallets') || '[]');
            }
        }

        async function loadCategoriesFromSupabase() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return [];
                
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: true });
                
                if (error) {
                    console.error('Supabase load error:', error);
                    throw error;
                }
                
                console.log('Raw data from database:', data);
                
                // Transform data to match our app structure
                const transformedData = data.map(category => ({
                    id: category.id,
                    name: category.name,
                    type: category.type || 'main',
                    parentId: category.parent_id
                }));
                
                console.log('Transformed categories:', transformedData);
                return transformedData;
            } catch (error) {
                console.error('Error loading categories:', error);
                return JSON.parse(localStorage.getItem('fintrack_categories') || '[]');
            }
        }

        // Expense Functions - UPDATED
        async function handleAddExpense(e) {
            e.preventDefault();
            
            const id = document.getElementById('expenseId').value;
            const description = document.getElementById('expenseDescription').value;
            const amount = parseCurrency(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const subcategory = document.getElementById('expenseSubcategory').value;
            
            // Use the current wallet instead of selecting from form
            const walletId = currentWalletId;
            
            if (!walletId) {
                showAlert('Please select a wallet from the top-right selector first', 'error');
                return;
            }
            
            if (amount <= 0) {
                showAlert('Please enter a valid amount', 'error');
                return;
            }
            
            // Find the current wallet
            const currentWallet = wallets.find(w => w.id === walletId);
            if (!currentWallet) {
                showAlert('Selected wallet not found', 'error');
                return;
            }
            
            // VALIDATION: Check if wallet has sufficient balance (only for new expenses)
            if (!id) {
                const walletBalance = calculateWalletBalance(walletId);
                if (walletBalance < amount) {
                    // Store the pending expense for potential future use
                    pendingExpense = { description, amount, date, category, subcategory, walletId };
                    
                    // Show insufficient balance modal with details
                    expenseAmountDetail.textContent = formatDisplayCurrency(amount);
                    walletBalanceDetail.textContent = formatDisplayCurrency(walletBalance);
                    remainingBalanceDetail.textContent = formatDisplayCurrency(walletBalance - amount);
                    
                    insufficientBalanceModal.classList.add('active');
                    return;
                }
            }
            
            const expense = { id, description, amount, date, category, subcategory, walletId };
            console.log('Saving expense:', expense);
            
            const savedExpense = await saveExpense(expense);
            
            if (id) {
                // Update existing expense
                const index = expenses.findIndex(e => e.id === id);
                if (index !== -1) {
                    expenses[index] = savedExpense;
                }
                showAlert('Expense updated successfully!', 'success');
            } else {
                // Add new expense
                expenses.push(savedExpense);
                showAlert('Expense added successfully!', 'success');
            }
            
            resetExpenseForm();
            await loadExpenses(); // Wait for expenses to reload
            updateStats(); // Force stats update
            
            console.log('After adding expense - Expenses:', expenses);
        }

        // Income Functions
        async function handleAddIncome(e) {
            e.preventDefault();
            
            const id = document.getElementById('incomeId').value;
            const description = document.getElementById('incomeDescription').value;
            const amount = parseCurrency(document.getElementById('incomeAmount').value);
            const date = document.getElementById('incomeDate').value;
            const source = document.getElementById('incomeSource').value;
            
            // Use the current wallet instead of selecting from form
            const walletId = currentWalletId;
            
            if (!walletId) {
                showAlert('Please select a wallet from the top-right selector', 'error');
                return;
            }
            
            if (amount <= 0) {
                showAlert('Please enter a valid amount', 'error');
                return;
            }
            
            // Find the current wallet
            const currentWallet = wallets.find(w => w.id === walletId);
            if (!currentWallet) {
                showAlert('Selected wallet not found', 'error');
                return;
            }
            
            const income = { id, description, amount, date, source, walletId };
            const savedIncome = await saveIncome(income);
            
            if (id) {
                // Update existing income
                const index = incomes.findIndex(i => i.id === id);
                if (index !== -1) {
                    incomes[index] = savedIncome;
                }
                showAlert('Income updated successfully!', 'success');
            } else {
                // Add new income
                incomes.push(savedIncome);
                showAlert('Income added successfully!', 'success');
            }
            
            resetIncomeForm();
            await loadIncomes();
            updateStats();
        }

        // Wallet Functions
        async function handleAddWallet(e) {
            e.preventDefault();
            
            const id = document.getElementById('walletId').value;
            const name = document.getElementById('walletName').value;
            
            const wallet = { id, name };
            const savedWallet = await saveWallet(wallet);
            
            if (id) {
                // Update existing wallet
                const index = wallets.findIndex(w => w.id === id);
                if (index !== -1) {
                    wallets[index] = savedWallet;
                }
                showAlert('Wallet updated successfully!', 'success');
            } else {
                // Add new wallet
                wallets.push(savedWallet);
                
                // If this is the first wallet, set it as current
                if (wallets.length === 1) {
                    currentWalletId = savedWallet.id;
                    updateGlobalWalletSelector();
                }
                showAlert('Wallet added successfully!', 'success');
            }
            
            resetWalletForm();
            await loadWallets();
            updateStats();
        }

        // Category Functions
        async function handleAddCategory(e) {
            e.preventDefault();
            
            const id = document.getElementById('categoryId').value;
            const type = document.getElementById('categoryType').value;
            const name = document.getElementById('categoryName').value;
            let parentId = null;
            
            if (type === 'sub') {
                parentId = document.getElementById('parentCategory').value;
                if (!parentId) {
                    showAlert('Please select a parent category for the subcategory', 'error');
                    return;
                }
            }
            
            const category = { id, name, type, parentId };
            
            console.log('Adding/updating category:', category);
            
            try {
                const savedCategory = await saveCategory(category);
                console.log('Saved category:', savedCategory);
                
                if (id) {
                    // Update existing category
                    const index = categories.findIndex(c => c.id === id);
                    if (index !== -1) {
                        categories[index] = savedCategory;
                    }
                    showAlert('Category updated successfully!', 'success');
                } else {
                    // Add new category
                    categories.push(savedCategory);
                    showAlert(`${type === 'main' ? 'Category' : 'Subcategory'} added successfully!`, 'success');
                }
                
                resetCategoryForm();
                
                // Force refresh all category-related UI
                await refreshAllCategoryUI();
                
            } catch (error) {
                console.error('Error in handleAddCategory:', error);
                showAlert('Error adding category: ' + error.message, 'error');
            }
        }

        // Subcategory Functions
        async function handleAddSubcategory(e) {
            e.preventDefault();
            
            const name = document.getElementById('subcategoryName').value;
            const parentId = document.getElementById('parentCategoryId').value;
            
            if (!name) {
                showAlert('Please enter a subcategory name', 'error');
                return;
            }
            
            if (!parentId) {
                showAlert('Parent category ID is missing', 'error');
                return;
            }
            
            const newSubcategory = { 
                name, 
                type: 'sub', 
                parentId: parentId
            };
            
            console.log('Adding subcategory:', newSubcategory);
            
            try {
                const savedSubcategory = await saveCategory(newSubcategory);
                console.log('Saved subcategory:', savedSubcategory);
                
                categories.push(savedSubcategory);
                
                showAlert('Subcategory added successfully!', 'success');
                subcategoryForm.reset();
                subcategoryModal.classList.remove('active');
                
                // Force refresh all category-related UI
                await refreshAllCategoryUI();
                
            } catch (error) {
                console.error('Error in handleAddSubcategory:', error);
                showAlert('Error adding subcategory: ' + error.message, 'error');
            }
        }

        // Edit functions
        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            
            document.getElementById('expenseId').value = expense.id;
            document.getElementById('expenseDescription').value = expense.description;
            document.getElementById('expenseAmount').value = formatCurrency(expense.amount.toString());
            document.getElementById('expenseDate').value = expense.date;
            document.getElementById('expenseCategory').value = expense.category;
            
            // Update subcategory dropdown based on selected category
            const categoryChangeEvent = new Event('change');
            document.getElementById('expenseCategory').dispatchEvent(categoryChangeEvent);
            
            setTimeout(() => {
                document.getElementById('expenseSubcategory').value = expense.subcategory || '';
            }, 100);
            
            expenseSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update Expense';
            expenseCancelBtn.classList.remove('hidden');
            
            // Scroll to form
            document.getElementById('expenseForm').scrollIntoView({ behavior: 'smooth' });
        }

        function editIncome(id) {
            const income = incomes.find(i => i.id === id);
            if (!income) return;
            
            document.getElementById('incomeId').value = income.id;
            document.getElementById('incomeDescription').value = income.description;
            document.getElementById('incomeAmount').value = formatCurrency(income.amount.toString());
            document.getElementById('incomeDate').value = income.date;
            document.getElementById('incomeSource').value = income.source;
            
            incomeSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update Income';
            incomeCancelBtn.classList.remove('hidden');
            
            // Scroll to form
            document.getElementById('incomeForm').scrollIntoView({ behavior: 'smooth' });
        }

        function editWallet(id) {
            const wallet = wallets.find(w => w.id === id);
            if (!wallet) return;
            
            document.getElementById('walletId').value = wallet.id;
            document.getElementById('walletName').value = wallet.name;
            
            walletSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update Wallet';
            walletCancelBtn.classList.remove('hidden');
            
            // Scroll to form
            document.getElementById('walletForm').scrollIntoView({ behavior: 'smooth' });
        }

        function editCategory(id) {
            const category = categories.find(c => c.id === id);
            if (!category) return;
            
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryType').value = category.type;
            
            if (category.type === 'sub') {
                parentCategoryGroup.classList.remove('hidden');
                loadParentCategories();
                setTimeout(() => {
                    document.getElementById('parentCategory').value = category.parentId;
                }, 100);
            } else {
                parentCategoryGroup.classList.add('hidden');
            }
            
            categorySubmitBtn.innerHTML = '<i class="fas fa-save"></i> Update Category';
            categoryCancelBtn.classList.remove('hidden');
            
            // Scroll to form
            document.getElementById('categoryForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Delete confirmation
        function confirmDelete(type, id, name) {
            itemToDelete = id;
            deleteType = type;
            
            let message = `Are you sure you want to delete ${name}?`;
            if (type === 'wallet') {
                message += " This will also delete all expenses and income associated with this wallet.";
            } else if (type === 'category') {
                message += " This will remove this category from all expenses.";
            }
            
            deleteMessage.textContent = message;
            deleteModal.classList.add('active');
        }

        // Handle delete confirmation
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!itemToDelete || !deleteType) return;
            
            try {
                let success = false;
                
                switch (deleteType) {
                    case 'expense':
                        success = await deleteExpense(itemToDelete);
                        if (success) {
                            expenses = expenses.filter(e => e.id !== itemToDelete);
                            showAlert('Expense deleted successfully!', 'success');
                        }
                        break;
                    case 'income':
                        success = await deleteIncome(itemToDelete);
                        if (success) {
                            incomes = incomes.filter(i => i.id !== itemToDelete);
                            showAlert('Income deleted successfully!', 'success');
                        }
                        break;
                    case 'wallet':
                        success = await deleteWallet(itemToDelete);
                        if (success) {
                            wallets = wallets.filter(w => w.id !== itemToDelete);
                            expenses = expenses.filter(e => e.walletId !== itemToDelete);
                            incomes = incomes.filter(i => i.walletId !== itemToDelete);
                            
                            // If we deleted the current wallet, select another one
                            if (currentWalletId === itemToDelete) {
                                currentWalletId = wallets.length > 0 ? wallets[0].id : null;
                                updateGlobalWalletSelector();
                            }
                            showAlert('Wallet deleted successfully!', 'success');
                        }
                        break;
                    case 'category':
                        success = await deleteCategory(itemToDelete);
                        if (success) {
                            categories = categories.filter(c => c.id !== itemToDelete);
                            // Also remove this category from expenses
                            expenses.forEach(expense => {
                                if (expense.category === itemToDelete) {
                                    expense.category = '';
                                }
                            });
                            showAlert('Category deleted successfully!', 'success');
                        }
                        break;
                }
                
                if (success) {
                    await loadExpenses();
                    await loadIncomes();
                    await loadWallets();
                    await loadCategories();
                    updateStats();
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showAlert('Error deleting item: ' + error.message, 'error');
            }
            
            deleteModal.classList.remove('active');
            itemToDelete = null;
            deleteType = null;
        });

        // Reset form functions
        function resetExpenseForm() {
            document.getElementById('expenseId').value = '';
            expenseForm.reset();
            document.getElementById('expenseDate').valueAsDate = new Date();
            expenseSubmitBtn.innerHTML = '<i class="fas fa-minus-circle"></i> Add Expense';
            expenseCancelBtn.classList.add('hidden');
        }

        function resetIncomeForm() {
            document.getElementById('incomeId').value = '';
            incomeForm.reset();
            document.getElementById('incomeDate').valueAsDate = new Date();
            incomeSubmitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Income';
            incomeCancelBtn.classList.add('hidden');
        }

        function resetWalletForm() {
            document.getElementById('walletId').value = '';
            walletForm.reset();
            walletSubmitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Wallet';
            walletCancelBtn.classList.add('hidden');
        }

        function resetCategoryForm() {
            document.getElementById('categoryId').value = '';
            categoryForm.reset();
            document.getElementById('categoryType').value = '';
            parentCategoryGroup.classList.add('hidden');
            categorySubmitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Category';
            categoryCancelBtn.classList.add('hidden');
        }

        // Function to refresh all category UI
        async function refreshAllCategoryUI() {
            console.log('Refreshing all category UI...');
            await loadCategories(); // This will call updateCategoryDropdowns
            updateStats();
        }

        // Data loading functions
        async function loadExpenses() {
            expenses = await loadExpensesFromSupabase();
            const expensesList = document.getElementById('expensesList');
            
            // Filter expenses for current wallet if one is selected
            let displayExpenses = expenses;
            if (currentWalletId) {
                displayExpenses = expenses.filter(expense => expense.walletId === currentWalletId);
            }
            
            if (displayExpenses.length === 0) {
                expensesList.innerHTML = `
                    <div class="expense-item">
                        <div class="expense-details">
                            <div>No expenses yet. Add your first expense!</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            expensesList.innerHTML = '';
            const sortedExpenses = [...displayExpenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExpenses.forEach(expense => {
                const expenseDate = new Date(expense.date).toLocaleDateString();
                const wallet = wallets.find(w => w.id === expense.walletId);
                
                let categoryText = expense.category;
                if (expense.subcategory) {
                    categoryText += ` > ${expense.subcategory}`;
                }
                
                const expenseItem = document.createElement('div');
                expenseItem.className = 'expense-item';
                expenseItem.innerHTML = `
                    <div class="expense-details">
                        <div>${expense.description}</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">
                            ${expenseDate}  ${wallet ? wallet.name : 'Unknown Wallet'}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="expense-amount">
                            ${formatDisplayCurrency(expense.amount)}
                            <span class="expense-category">${categoryText}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="editExpense('${expense.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" onclick="confirmDelete('expense', '${expense.id}', '${expense.description}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                expensesList.appendChild(expenseItem);
            });
        }

        // Load incomes
        async function loadIncomes() {
            incomes = await loadIncomesFromSupabase();
            const incomesList = document.getElementById('incomesList');
            
            // Filter incomes for current wallet if one is selected
            let displayIncomes = incomes;
            if (currentWalletId) {
                displayIncomes = incomes.filter(income => income.walletId === currentWalletId);
            }
            
            if (displayIncomes.length === 0) {
                incomesList.innerHTML = `
                    <div class="income-item">
                        <div class="income-details">
                            <div>No income yet. Add your first income!</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            incomesList.innerHTML = '';
            const sortedIncomes = [...displayIncomes].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedIncomes.forEach(income => {
                const incomeDate = new Date(income.date).toLocaleDateString();
                const wallet = wallets.find(w => w.id === income.walletId);
                
                const incomeItem = document.createElement('div');
                incomeItem.className = 'income-item';
                incomeItem.innerHTML = `
                    <div class="income-details">
                        <div>${income.description}</div>
                        <div style="font-size: 0.9rem; color: var(--gray);">
                            ${incomeDate}  ${wallet ? wallet.name : 'Unknown Wallet'}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="income-amount">
                            ${formatDisplayCurrency(income.amount)}
                            <span class="income-source">${income.source}</span>
                        </div>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="editIncome('${income.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" onclick="confirmDelete('income', '${income.id}', '${income.description}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                incomesList.appendChild(incomeItem);
            });
        }
        
        async function loadWallets() {
            wallets = await loadWalletsFromSupabase();
            const walletsList = document.getElementById('walletsList');
            
            // Update global wallet selector - REMOVED BALANCE FROM DISPLAY
            globalWalletSelect.innerHTML = '<option value="">Select a wallet</option>';
            wallets.forEach(wallet => {
                const option = document.createElement('option');
                option.value = wallet.id;
                
                // Only show wallet name, no balance
                option.textContent = wallet.name;
                globalWalletSelect.appendChild(option);
            });
            
            // Set the current wallet in the selector
            if (currentWalletId) {
                globalWalletSelect.value = currentWalletId;
            } else if (wallets.length > 0) {
                currentWalletId = wallets[0].id;
                globalWalletSelect.value = currentWalletId;
            }
            
            // Update wallet list - KEEP balance in the wallet list view
            walletsList.innerHTML = '';
            
            if (wallets.length === 0) {
                walletsList.innerHTML = `
                    <div class="wallet-item">
                        <div class="wallet-details">
                            <div>No wallets yet. Add your first wallet!</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            wallets.forEach(wallet => {
                const walletItem = document.createElement('div');
                walletItem.className = 'wallet-item';
                
                // Calculate balance for this wallet
                const balance = calculateWalletBalance(wallet.id);
                
                walletItem.innerHTML = `
                    <div class="wallet-details">
                        <div>${wallet.name}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="wallet-balance">
                            ${formatDisplayCurrency(balance)}
                        </div>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="editWallet('${wallet.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn" onclick="confirmDelete('wallet', '${wallet.id}', '${wallet.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                walletsList.appendChild(walletItem);
            });
        }
        
        async function loadCategories() {
            try {
                categories = await loadCategoriesFromSupabase();
                console.log('Loaded categories from database:', categories);
                
                const categoriesList = document.getElementById('categoriesList');
                categoriesList.innerHTML = '';
                
                if (categories.length === 0) {
                    categoriesList.innerHTML = `
                        <div class="category-item">
                            <div class="category-details">
                                <div>No categories yet. Add your first category!</div>
                            </div>
                        </div>
                    `;
                } else {
                    // Separate main categories and subcategories
                    const mainCategories = categories.filter(c => c.type === 'main');
                    const subcategories = categories.filter(c => c.type === 'sub');
                    
                    console.log('Main categories for display:', mainCategories);
                    console.log('Subcategories for display:', subcategories);
                    
                    if (mainCategories.length === 0) {
                        categoriesList.innerHTML = `
                            <div class="category-item">
                                <div class="category-details">
                                    <div>No main categories yet. Add your first main category!</div>
                                </div>
                            </div>
                        `;
                    } else {
                        mainCategories.forEach(category => {
                            const categoryItem = document.createElement('div');
                            categoryItem.className = 'category-item';
                            categoryItem.innerHTML = `
                                <div class="category-details">
                                    <div><strong>${category.name}</strong></div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="category-actions">
                                        <button class="add-subcategory-btn" data-id="${category.id}">
                                            <i class="fas fa-plus"></i> Add Subcategory
                                        </button>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="edit-btn" onclick="editCategory('${category.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="delete-btn" onclick="confirmDelete('category', '${category.id}', '${category.name}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                            categoriesList.appendChild(categoryItem);
                            
                            // Add event listener
                            const addSubcategoryBtn = categoryItem.querySelector('.add-subcategory-btn');
                            addSubcategoryBtn.addEventListener('click', () => {
                                console.log('Opening subcategory modal for parent ID:', category.id);
                                openSubcategoryModal(category.id);
                            });
                            
                            // Add subcategories for this main category
                            const categorySubcategories = subcategories.filter(sc => sc.parentId === category.id);
                            categorySubcategories.forEach(subcategory => {
                                const subcategoryItem = document.createElement('div');
                                subcategoryItem.className = 'category-item subcategory-item';
                                subcategoryItem.innerHTML = `
                                    <div class="category-details">
                                        <div>${subcategory.name}</div>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="edit-btn" onclick="editCategory('${subcategory.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="delete-btn" onclick="confirmDelete('category', '${subcategory.id}', '${subcategory.name}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `;
                                categoriesList.appendChild(subcategoryItem);
                            });
                        });
                        
                        // Handle orphaned subcategories (subcategories without a valid parent)
                        const orphanSubcategories = subcategories.filter(sc => {
                            return !mainCategories.some(mc => mc.id === sc.parentId);
                        });
                        
                        if (orphanSubcategories.length > 0) {
                            const orphanHeader = document.createElement('div');
                            orphanHeader.className = 'category-item';
                            orphanHeader.innerHTML = `
                                <div class="category-details">
                                    <div><strong>Orphaned Subcategories</strong></div>
                                </div>
                            `;
                            categoriesList.appendChild(orphanHeader);
                            
                            orphanSubcategories.forEach(subcategory => {
                                const subcategoryItem = document.createElement('div');
                                subcategoryItem.className = 'category-item subcategory-item';
                                subcategoryItem.innerHTML = `
                                    <div class="category-details">
                                        <div>${subcategory.name}</div>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="edit-btn" onclick="editCategory('${subcategory.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="delete-btn" onclick="confirmDelete('category', '${subcategory.id}', '${subcategory.name}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `;
                                categoriesList.appendChild(subcategoryItem);
                            });
                        }
                    }
                }
                
                // ALWAYS update the dropdowns after loading categories
                updateCategoryDropdowns();
                
            } catch (error) {
                console.error('Error in loadCategories:', error);
                showAlert('Error loading categories: ' + error.message, 'error');
            }
        }
        
        function loadParentCategories() {
            parentCategory.innerHTML = '<option value="">Select a parent category</option>';
            const mainCategories = categories.filter(c => c.type === 'main');
            
            mainCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                parentCategory.appendChild(option);
            });
        }
        
        function updateCategoryDropdowns() {
            console.log('Updating category dropdowns with:', categories);
            
            // Update expense category dropdown
            const expenseCategorySelect = document.getElementById('expenseCategory');
            const expenseSubcategorySelect = document.getElementById('expenseSubcategory');
            
            // Clear existing options
            expenseCategorySelect.innerHTML = '<option value="">Select a category</option>';
            expenseSubcategorySelect.innerHTML = '<option value="">Select a subcategory (optional)</option>';
            
            // Get main categories only
            const mainCategories = categories.filter(c => c.type === 'main');
            console.log('Main categories for dropdown:', mainCategories);
            
            // Populate main categories dropdown
            mainCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                expenseCategorySelect.appendChild(option);
            });
            
            // Update parent category dropdown (for category form)
            const parentCategorySelect = document.getElementById('parentCategory');
            parentCategorySelect.innerHTML = '<option value="">Select a parent category</option>';
            mainCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                parentCategorySelect.appendChild(option);
            });
            
            // Remove any existing event listeners to prevent duplicates
            const newExpenseCategorySelect = expenseCategorySelect.cloneNode(true);
            expenseCategorySelect.parentNode.replaceChild(newExpenseCategorySelect, expenseCategorySelect);
            
            // Add fresh event listener to update subcategories when category changes
            newExpenseCategorySelect.addEventListener('change', function() {
                const selectedCategory = this.value;
                console.log('Category selected:', selectedCategory);
                
                const expenseSubcategorySelect = document.getElementById('expenseSubcategory');
                expenseSubcategorySelect.innerHTML = '<option value="">Select a subcategory (optional)</option>';
                
                if (selectedCategory) {
                    // Find the main category by name
                    const mainCategory = categories.find(c => c.name === selectedCategory && c.type === 'main');
                    console.log('Found main category:', mainCategory);
                    
                    if (mainCategory) {
                        // Get subcategories for this main category
                        const subcategories = categories.filter(c => c.type === 'sub' && c.parentId === mainCategory.id);
                        console.log('Subcategories for', selectedCategory, ':', subcategories);
                        
                        subcategories.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.name;
                            option.textContent = subcategory.name;
                            expenseSubcategorySelect.appendChild(option);
                        });
                    }
                }
            });
            
            // Update the global reference
            window.expenseCategory = newExpenseCategorySelect;
        }
        
        // UPDATED: Stats function with better filtering and debugging
        function updateStats() {
            console.log('Updating stats, current wallet:', currentWalletId);
            console.log('All expenses:', expenses);
            console.log('All incomes:', incomes);
            
            if (!currentWalletId) {
                // If no wallet is selected, show zeros
                document.getElementById('totalIncome').textContent = formatDisplayCurrency(0);
                document.getElementById('totalExpenses').textContent = formatDisplayCurrency(0);
                document.getElementById('currentWalletBalance').textContent = formatDisplayCurrency(0);
                showAlert('Please select a wallet first', 'warning');
                return;
            }

            // Filter expenses and incomes for the current wallet only
            const walletExpenses = expenses.filter(expense => expense.walletId === currentWalletId);
            const walletIncomes = incomes.filter(income => income.walletId === currentWalletId);
            
            console.log('Wallet expenses:', walletExpenses);
            console.log('Wallet incomes:', walletIncomes);
            
            // Calculate total expenses for current wallet
            const totalExpenses = walletExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalExpenses').textContent = formatDisplayCurrency(totalExpenses);
            
            // Calculate total income for current wallet
            const totalIncome = walletIncomes.reduce((sum, income) => sum + income.amount, 0);
            document.getElementById('totalIncome').textContent = formatDisplayCurrency(totalIncome);
            
            // Calculate current wallet balance (income - expenses)
            const currentWalletBalance = totalIncome - totalExpenses;
            document.getElementById('currentWalletBalance').textContent = formatDisplayCurrency(currentWalletBalance);
            
            console.log('Stats updated - Income:', totalIncome, 'Expenses:', totalExpenses, 'Balance:', currentWalletBalance);
        }

        // Function to update global wallet selector
        function updateGlobalWalletSelector() {
            if (globalWalletSelect && currentWalletId) {
                globalWalletSelect.value = currentWalletId;
            }
        }

        // Function to test category dropdowns (for debugging)
        function testCategoryDropdowns() {
            console.log('=== Testing Category Dropdowns ===');
            console.log('Categories array:', categories);
            console.log('Main categories:', categories.filter(c => c.type === 'main'));
            console.log('Subcategories:', categories.filter(c => c.type === 'sub'));
            
            const expenseCategorySelect = document.getElementById('expenseCategory');
            console.log('Expense category select options:', expenseCategorySelect.innerHTML);
            
            const expenseSubcategorySelect = document.getElementById('expenseSubcategory');
            console.log('Expense subcategory select options:', expenseSubcategorySelect.innerHTML);
        }

        // Add this function to check if dropdowns need initialization
        function initializeCategoryDropdowns() {
            const expenseCategorySelect = document.getElementById('expenseCategory');
            if (expenseCategorySelect && expenseCategorySelect.options.length <= 1) {
                console.log('Initializing empty category dropdowns...');
                updateCategoryDropdowns();
            }
        }

        // Debug function for wallet info
        function debugWalletInfo() {
            console.log('=== WALLET DEBUG INFO ===');
            console.log('Current Wallet ID:', currentWalletId);
            console.log('Available Wallets:', wallets);
            console.log('All Expenses:', expenses);
            console.log('All Incomes:', incomes);
            
            if (currentWalletId) {
                const walletExpenses = expenses.filter(e => e.walletId === currentWalletId);
                const walletIncomes = incomes.filter(i => i.walletId === currentWalletId);
                console.log('Current Wallet Expenses:', walletExpenses);
                console.log('Current Wallet Incomes:', walletIncomes);
                console.log('Current Wallet Balance:', calculateWalletBalance(currentWalletId));
            }
        }

        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 
                         type === 'warning' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle';
            alert.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            alertContainer.appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            
            // Check and initialize dropdowns after a short delay to ensure DOM is ready
            setTimeout(initializeCategoryDropdowns, 500);
        });

        // Set up auth state listener
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                checkAuthState();
            }
        });
    </script>
</body>
</html>